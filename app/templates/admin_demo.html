{% extends "app_base.html" %}

{% block title %}D√©monstration Vid√©o - SarfX Admin{% endblock %}

{% block content %}
<div class="space-y-6 pb-24">
    <!-- Header -->
    <div class="flex justify-between items-center pt-2">
        <div>
            <div class="flex items-center gap-2">
                <div class="logo">
                    <span class="logo-text">Sarf</span><span class="logo-accent">X</span>
                </div>
                <span class="badge badge-error">Admin</span>
            </div>
            <p class="text-muted text-sm mt-1">üé¨ D√©monstrations Vid√©o Automatis√©es</p>
        </div>
        <div class="flex items-center gap-2">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-ghost w-10 h-10 rounded-full flex items-center justify-center text-muted hover:text-default transition">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <!-- Mode Selection -->
    <div class="card p-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <i data-lucide="monitor" class="w-5 h-5 text-primary"></i>
                <span class="font-medium text-default">Mode d'ex√©cution</span>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="execMode" value="server-headless" id="mode-headless" checked class="w-4 h-4 accent-primary">
                    <span class="text-sm">üîá Serveur (headless)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="execMode" value="server-visible" id="mode-visible" class="w-4 h-4 accent-primary">
                    <span class="text-sm">üñ•Ô∏è Serveur (visible)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="radio" name="execMode" value="local" id="mode-local" class="w-4 h-4 accent-primary">
                    <span class="text-sm">üíª Ma machine (local)</span>
                </label>
            </div>
        </div>
        <p class="text-xs text-muted mt-2" id="mode-description">
            <i data-lucide="info" class="w-3 h-3 inline"></i>
            <strong>Serveur headless</strong> = Robot invisible sur le serveur. <strong>Serveur visible</strong> = Navigateur affich√© sur le serveur. <strong>Local</strong> = T√©l√©charger et ex√©cuter sur votre machine.
        </p>
    </div>

    <!-- Local Execution Instructions (shown when local mode selected) -->
    <div id="local-instructions" class="card p-4 border-l-4 border-warning" style="display: none;">
        <h4 class="font-bold text-default mb-2 flex items-center gap-2">
            <i data-lucide="download" class="w-5 h-5 text-warning"></i>
            Ex√©cution sur votre machine
        </h4>
        <p class="text-sm text-muted mb-3">Pour voir le robot en action sur votre √©cran :</p>
        <ol class="text-sm space-y-2 mb-4">
            <li class="flex items-start gap-2">
                <span class="bg-warning text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0">1</span>
                <span>Installez Python 3.8+ et Playwright : <code class="bg-surface px-1 rounded">pip install playwright && playwright install chromium</code></span>
            </li>
            <li class="flex items-start gap-2">
                <span class="bg-warning text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0">2</span>
                <span>T√©l√©chargez le script ci-dessous</span>
            </li>
            <li class="flex items-start gap-2">
                <span class="bg-warning text-white w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0">3</span>
                <span>Ex√©cutez : <code class="bg-surface px-1 rounded">python sarfx_demo.py --role admin --visible</code></span>
            </li>
        </ol>
        <div class="flex flex-wrap gap-2">
            <a href="/admin/demo/download-script" class="btn btn-warning px-4 py-2">
                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                T√©l√©charger sarfx_demo.py
            </a>
            <button onclick="copyLocalCommand('admin')" class="btn btn-ghost px-3 py-2 text-sm">
                <i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copier commande Admin
            </button>
            <button onclick="copyLocalCommand('bank')" class="btn btn-ghost px-3 py-2 text-sm">
                <i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copier commande Bank
            </button>
            <button onclick="copyLocalCommand('user')" class="btn btn-ghost px-3 py-2 text-sm">
                <i data-lucide="copy" class="w-4 h-4 mr-1"></i> Copier commande User
            </button>
        </div>
    </div>

    <!-- Playwright Status Check -->
    <div id="playwright-check" class="card p-4 border-l-4 border-info" style="display: none;">
        <div class="flex items-center gap-3">
            <i data-lucide="loader-2" class="w-5 h-5 text-info animate-spin"></i>
            <span class="text-sm">V√©rification de Playwright...</span>
        </div>
    </div>

    <!-- Demo Cards - 3 Roles -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Admin Demo -->
        <div class="card p-6 text-center demo-card" id="demo-card-admin">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-red-500 to-pink-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">üëë</span>
            </div>
            <h3 class="text-lg font-bold text-default mb-1">Admin Demo</h3>
            <p class="text-xs text-muted mb-4">Dashboard, Utilisateurs, Banques, ATMs, Transactions</p>
            <div class="demo-status mb-3" id="status-admin">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-surface text-xs text-muted">
                    <i data-lucide="circle" class="w-2 h-2"></i> Pr√™t
                </span>
            </div>
            <button onclick="startPlaywrightDemo('admin')" id="btn-admin" class="btn btn-primary w-full py-3">
                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                Lancer Admin Demo
            </button>
            <div class="mt-3 video-preview" id="video-admin" style="display: none;">
                <video controls class="w-full rounded-lg" style="max-height: 200px;"></video>
            </div>
        </div>

        <!-- Bank Demo -->
        <div class="card p-6 text-center demo-card" id="demo-card-bank">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">üè¶</span>
            </div>
            <h3 class="text-lg font-bold text-default mb-1">Bank Respo Demo</h3>
            <p class="text-xs text-muted mb-4">Config Banque, ATMs Banque, Convertisseur, Wallets</p>
            <div class="demo-status mb-3" id="status-bank">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-surface text-xs text-muted">
                    <i data-lucide="circle" class="w-2 h-2"></i> Pr√™t
                </span>
            </div>
            <button onclick="startPlaywrightDemo('bank')" id="btn-bank" class="btn btn-primary w-full py-3" style="background: linear-gradient(135deg, #3b82f6, #06b6d4);">
                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                Lancer Bank Demo
            </button>
            <div class="mt-3 video-preview" id="video-bank" style="display: none;">
                <video controls class="w-full rounded-lg" style="max-height: 200px;"></video>
            </div>
        </div>

        <!-- User Demo -->
        <div class="card p-6 text-center demo-card" id="demo-card-user">
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center mx-auto mb-4">
                <span class="text-3xl">üë§</span>
            </div>
            <h3 class="text-lg font-bold text-default mb-1">User Demo</h3>
            <p class="text-xs text-muted mb-4">Wallets, Convertisseur, ATMs, Transactions, IA</p>
            <div class="demo-status mb-3" id="status-user">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-surface text-xs text-muted">
                    <i data-lucide="circle" class="w-2 h-2"></i> Pr√™t
                </span>
            </div>
            <button onclick="startPlaywrightDemo('user')" id="btn-user" class="btn btn-primary w-full py-3" style="background: linear-gradient(135deg, #22c55e, #10b981);">
                <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                Lancer User Demo
            </button>
            <div class="mt-3 video-preview" id="video-user" style="display: none;">
                <video controls class="w-full rounded-lg" style="max-height: 200px;"></video>
            </div>
        </div>
    </div>

    <!-- Global Actions -->
    <div class="card p-4">
        <div class="flex flex-wrap gap-3 justify-center">
            <button onclick="startAllDemos()" class="btn btn-ghost px-4 py-2">
                <i data-lucide="play-circle" class="w-4 h-4 mr-2"></i>
                Lancer les 3 D√©mos
            </button>
            <button onclick="refreshAllStatuses()" class="btn btn-ghost px-4 py-2">
                <i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>
                Actualiser
            </button>
            <button onclick="loadAllVideos()" class="btn btn-ghost px-4 py-2">
                <i data-lucide="video" class="w-4 h-4 mr-2"></i>
                Voir Vid√©os
            </button>
        </div>
    </div>

    <!-- Videos Gallery -->
    <div class="card p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-default flex items-center gap-2">
                <i data-lucide="film" class="w-5 h-5 text-error"></i>
                Vid√©os Enregistr√©es
            </h3>
            <button onclick="loadVideos()" class="text-primary text-sm">
                <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i> Actualiser
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="videos-gallery">
            <div class="col-span-full text-center py-8 text-muted">
                <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                <p class="text-sm">Aucune vid√©o enregistr√©e</p>
                <p class="text-xs mt-1">Lancez une d√©monstration pour g√©n√©rer des vid√©os</p>
            </div>
        </div>
    </div>

    <!-- Screenshots Gallery -->
    <div class="card p-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-default flex items-center gap-2">
                <i data-lucide="images" class="w-5 h-5 text-info"></i>
                Captures d'√©cran
            </h3>
            <div class="flex gap-2">
                <select id="screenshot-filter" onchange="loadScreenshots()" class="text-sm bg-surface border border-border rounded px-2 py-1">
                    <option value="">Tous les r√¥les</option>
                    <option value="admin">Admin</option>
                    <option value="bank">Bank</option>
                    <option value="user">User</option>
                </select>
                <button onclick="loadScreenshots()" class="text-primary text-sm">
                    <i data-lucide="refresh-cw" class="w-4 h-4 inline"></i>
                </button>
            </div>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3" id="screenshots-gallery">
            <div class="col-span-full text-center py-8 text-muted">
                <i data-lucide="image" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                <p class="text-sm">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Robot Framework Demo (Legacy) -->
    <div class="card p-4">
        <details>
            <summary class="cursor-pointer font-bold text-default flex items-center gap-2">
                <i data-lucide="terminal" class="w-5 h-5 text-warning"></i>
                Robot Framework (Legacy)
            </summary>
            <div class="mt-4 pt-4 border-t border-border">
                <p class="text-sm text-muted mb-4">Ancien syst√®me de d√©monstration avec Robot Framework et Selenium</p>
                <button onclick="startRobotDemo()" id="robot-demo-btn" class="btn btn-ghost px-4 py-2">
                    <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                    Lancer Robot Demo
                </button>
            </div>
        </details>
    </div>
</div>

<!-- Admin Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-surface border-t border-border px-6 py-3 z-50" style="background: var(--bg-secondary); backdrop-filter: blur(20px);">
    <div class="flex justify-around items-center max-w-lg mx-auto">
        <a href="{{ url_for('admin.dashboard') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span class="text-xs">Dashboard</span>
        </a>
        <a href="{{ url_for('admin.users') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="text-xs">Users</span>
        </a>
        <a href="{{ url_for('admin.demo_page') }}" class="flex flex-col items-center gap-1 text-primary">
            <i data-lucide="play-circle" class="w-5 h-5"></i>
            <span class="text-xs font-bold">D√©mo</span>
        </a>
        <a href="{{ url_for('admin_banks.list_banks') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="building-2" class="w-5 h-5"></i>
            <span class="text-xs">Banques</span>
        </a>
        <a href="{{ url_for('app.home') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-xs">App</span>
        </a>
    </div>
</nav>

<!-- Screenshot Modal -->
<div id="screenshot-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4" onclick="closeModal()">
    <button class="absolute top-4 right-4 text-white text-3xl">&times;</button>
    <img id="modal-image" src="" alt="Screenshot" class="max-w-full max-h-full rounded-lg" onclick="event.stopPropagation()">
</div>

<style>
.demo-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}
.demo-card.running {
    border-color: var(--primary);
    animation: pulse-border 2s infinite;
}
.demo-card.success {
    border-color: var(--success);
}
.demo-card.error {
    border-color: var(--error);
}
@keyframes pulse-border {
    0%, 100% { box-shadow: 0 0 0 0 rgba(224, 90, 3, 0.4); }
    50% { box-shadow: 0 0 0 10px rgba(224, 90, 3, 0); }
}
</style>

<script>
let statusPollingInterval = null;

// Mode selection handling
document.addEventListener('DOMContentLoaded', () => {
    const modeRadios = document.querySelectorAll('input[name="execMode"]');
    const localInstructions = document.getElementById('local-instructions');

    modeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'local' && radio.checked) {
                localInstructions.style.display = 'block';
            } else {
                localInstructions.style.display = 'none';
            }
        });
    });

    checkPlaywright();
    loadVideos();
});

// Copy local command to clipboard
function copyLocalCommand(role) {
    const command = `python sarfx_demo.py --role ${role} --visible`;
    navigator.clipboard.writeText(command).then(() => {
        showNotification(`üìã Commande copi√©e: ${command}`, 'success');
    });
}

// Check Playwright installation
async function checkPlaywright() {
    const checkDiv = document.getElementById('playwright-check');
    checkDiv.style.display = 'block';

    try {
        const response = await fetch('/admin/demo/playwright/check');
        const data = await response.json();

        if (data.installed && data.browsers_installed) {
            checkDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="check-circle" class="w-5 h-5 text-success"></i>
                    <span class="text-sm text-success">Playwright est pr√™t !</span>
                </div>
            `;
            setTimeout(() => { checkDiv.style.display = 'none'; }, 2000);
        } else {
            checkDiv.className = 'card p-4 border-l-4 border-warning';
            checkDiv.innerHTML = `
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-warning flex-shrink-0"></i>
                    <div>
                        <p class="text-sm font-bold text-warning">Playwright non configur√©</p>
                        <p class="text-xs text-muted mt-1">${data.error || 'Installez avec: pip install playwright && playwright install chromium'}</p>
                    </div>
                </div>
            `;
        }
        lucide.createIcons();
    } catch (error) {
        checkDiv.className = 'card p-4 border-l-4 border-error';
        checkDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="x-circle" class="w-5 h-5 text-error"></i>
                <span class="text-sm text-error">Erreur de v√©rification Playwright</span>
            </div>
        `;
        lucide.createIcons();
    }
}

// Get selected execution mode
function getExecutionMode() {
    const serverHeadless = document.getElementById('mode-headless');
    const serverVisible = document.getElementById('mode-visible');
    const local = document.getElementById('mode-local');

    if (local && local.checked) return 'local';
    if (serverVisible && serverVisible.checked) return 'server-visible';
    return 'server-headless';
}

// Start Playwright demo for a specific role
async function startPlaywrightDemo(role) {
    const mode = getExecutionMode();

    // Si mode local, ouvrir le t√©l√©chargement et afficher instructions
    if (mode === 'local') {
        showNotification(`üíª T√©l√©chargez le script et ex√©cutez: python sarfx_demo.py --role ${role} --visible`, 'info');
        window.open('/admin/demo/download-script', '_blank');
        return;
    }

    const btn = document.getElementById(`btn-${role}`);
    const card = document.getElementById(`demo-card-${role}`);
    const statusDiv = document.getElementById(`status-${role}`);
    const headless = mode === 'server-headless';

    // Update UI
    btn.disabled = true;
    const modeText = headless ? '(serveur headless)' : '(serveur visible)';
    btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>D√©marrage ${modeText}...`;
    card.classList.add('running');
    card.classList.remove('success', 'error');
    statusDiv.innerHTML = `
        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-primary/20 text-xs text-primary">
            <i data-lucide="loader-2" class="w-2 h-2 animate-spin"></i> En cours ${modeText}...
        </span>
    `;
    lucide.createIcons();

    try {
        const response = await fetch(`/admin/demo/playwright/run/${role}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ headless: headless })
        });

        const data = await response.json();

        if (data.success) {
            showNotification(`üé¨ D√©mo ${role} lanc√©e !`, 'success');
            startStatusPolling();
        } else {
            throw new Error(data.message);
        }
    } catch (error) {
        card.classList.remove('running');
        card.classList.add('error');
        statusDiv.innerHTML = `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-error/20 text-xs text-error">
                <i data-lucide="x-circle" class="w-2 h-2"></i> Erreur
            </span>
        `;
        btn.disabled = false;
        btn.innerHTML = `<i data-lucide="play" class="w-4 h-4 mr-2"></i>R√©essayer`;
        lucide.createIcons();
        showNotification(`‚ùå ${error.message}`, 'error');
    }
}

// Start all demos sequentially
async function startAllDemos() {
    for (const role of ['admin', 'bank', 'user']) {
        await startPlaywrightDemo(role);
        // Wait a bit before starting the next one
        await new Promise(resolve => setTimeout(resolve, 2000));
    }
}

// Refresh all statuses
async function refreshAllStatuses() {
    try {
        const response = await fetch('/admin/demo/playwright/status');
        const statuses = await response.json();

        for (const [role, status] of Object.entries(statuses)) {
            updateRoleStatus(role, status);
        }
    } catch (error) {
        console.error('Status refresh error:', error);
    }
}

// Update status for a specific role
function updateRoleStatus(role, status) {
    const btn = document.getElementById(`btn-${role}`);
    const card = document.getElementById(`demo-card-${role}`);
    const statusDiv = document.getElementById(`status-${role}`);
    const videoDiv = document.getElementById(`video-${role}`);

    card.classList.remove('running', 'success', 'error');

    if (status.running) {
        card.classList.add('running');
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>En cours...';
        statusDiv.innerHTML = `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-primary/20 text-xs text-primary">
                <i data-lucide="loader-2" class="w-2 h-2 animate-spin"></i> Enregistrement...
            </span>
        `;
    } else if (status.success === true) {
        card.classList.add('success');
        btn.disabled = false;
        btn.innerHTML = `<i data-lucide="refresh-cw" class="w-4 h-4 mr-2"></i>Relancer`;
        statusDiv.innerHTML = `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-success/20 text-xs text-success">
                <i data-lucide="check-circle" class="w-2 h-2"></i> Termin√© (${Math.round(status.duration)}s)
            </span>
        `;

        // Show video if available
        if (status.video_path) {
            const filename = status.video_path.split('/').pop();
            videoDiv.style.display = 'block';
            videoDiv.querySelector('video').src = `/admin/demo/video/${filename}`;
        }
    } else if (status.success === false) {
        card.classList.add('error');
        btn.disabled = false;
        btn.innerHTML = `<i data-lucide="play" class="w-4 h-4 mr-2"></i>R√©essayer`;
        statusDiv.innerHTML = `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-error/20 text-xs text-error">
                <i data-lucide="x-circle" class="w-2 h-2"></i> Erreur
            </span>
        `;
    } else {
        btn.disabled = false;
        const colors = { admin: 'from-red-500 to-pink-500', bank: 'from-blue-500 to-cyan-500', user: 'from-green-500 to-emerald-500' };
        btn.innerHTML = `<i data-lucide="play" class="w-4 h-4 mr-2"></i>Lancer ${role.charAt(0).toUpperCase() + role.slice(1)} Demo`;
        statusDiv.innerHTML = `
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-surface text-xs text-muted">
                <i data-lucide="circle" class="w-2 h-2"></i> Pr√™t
            </span>
        `;
    }

    lucide.createIcons();
}

// Start polling for status updates
function startStatusPolling() {
    if (statusPollingInterval) return;

    statusPollingInterval = setInterval(async () => {
        await refreshAllStatuses();

        // Check if any demo is still running
        const response = await fetch('/admin/demo/playwright/status');
        const statuses = await response.json();
        const anyRunning = Object.values(statuses).some(s => s.running);

        if (!anyRunning && statusPollingInterval) {
            clearInterval(statusPollingInterval);
            statusPollingInterval = null;
            loadVideos();
            loadScreenshots();
        }
    }, 3000);
}

// Load videos gallery
async function loadVideos() {
    const gallery = document.getElementById('videos-gallery');

    try {
        const response = await fetch('/admin/demo/playwright/videos');
        const videos = await response.json();

        if (videos.length === 0) {
            gallery.innerHTML = `
                <div class="col-span-full text-center py-8 text-muted">
                    <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                    <p class="text-sm">Aucune vid√©o enregistr√©e</p>
                </div>
            `;
        } else {
            gallery.innerHTML = videos.map(v => {
                const roleEmoji = v.role === 'admin' ? 'üëë' : v.role === 'bank' ? 'üè¶' : 'üë§';
                const roleColor = v.role === 'admin' ? 'text-pink-500' : v.role === 'bank' ? 'text-blue-500' : 'text-green-500';
                return `
                    <div class="card p-3">
                        <div class="bg-black rounded-lg overflow-hidden mb-2">
                            <video controls class="w-full" style="max-height: 180px;">
                                <source src="${v.path}" type="video/mp4">
                            </video>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-bold ${roleColor}">${roleEmoji} ${v.role}</span>
                            <span class="text-xs text-muted">${(v.size / 1024 / 1024).toFixed(1)} MB</span>
                        </div>
                        <p class="text-xs text-muted truncate">${v.filename}</p>
                        <a href="${v.path}" download class="btn btn-ghost btn-sm w-full mt-2">
                            <i data-lucide="download" class="w-3 h-3 mr-1"></i> T√©l√©charger
                        </a>
                    </div>
                `;
            }).join('');
        }

        lucide.createIcons();
    } catch (error) {
        gallery.innerHTML = '<div class="col-span-full text-center py-4 text-error">Erreur de chargement</div>';
    }
}

// Load all videos inline
function loadAllVideos() {
    ['admin', 'bank', 'user'].forEach(role => {
        const videoDiv = document.getElementById(`video-${role}`);
        videoDiv.style.display = 'block';
    });
    loadVideos();
}

// Load screenshots gallery
async function loadScreenshots() {
    const gallery = document.getElementById('screenshots-gallery');
    const roleFilter = document.getElementById('screenshot-filter').value;

    try {
        const url = roleFilter ? `/admin/demo/playwright/screenshots?role=${roleFilter}` : '/admin/demo/playwright/screenshots';
        const response = await fetch(url);
        const screenshots = await response.json();

        if (screenshots.length === 0) {
            gallery.innerHTML = `
                <div class="col-span-full text-center py-8 text-muted">
                    <i data-lucide="image" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                    <p class="text-sm">Aucune capture disponible</p>
                </div>
            `;
        } else {
            gallery.innerHTML = screenshots.map(s => `
                <div class="cursor-pointer group" onclick="openModal('${s.path}')">
                    <div class="aspect-video bg-surface rounded-lg overflow-hidden">
                        <img src="${s.path}" alt="${s.filename}" class="w-full h-full object-cover group-hover:scale-105 transition" loading="lazy">
                    </div>
                    <p class="text-xs text-muted mt-1 truncate">${s.filename.replace('.png', '').replace(/_/g, ' ').substring(0, 20)}</p>
                </div>
            `).join('');
        }

        lucide.createIcons();
    } catch (error) {
        gallery.innerHTML = '<div class="col-span-full text-center py-4 text-error">Erreur de chargement</div>';
    }
}

// Modal functions
function openModal(src) {
    document.getElementById('modal-image').src = src;
    document.getElementById('screenshot-modal').classList.remove('hidden');
    document.getElementById('screenshot-modal').classList.add('flex');
}

function closeModal() {
    document.getElementById('screenshot-modal').classList.add('hidden');
    document.getElementById('screenshot-modal').classList.remove('flex');
}

// Robot Framework legacy demo
async function startRobotDemo() {
    const btn = document.getElementById('robot-demo-btn');
    btn.disabled = true;
    btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i>Lancement...';
    lucide.createIcons();

    try {
        const response = await fetch('/admin/demo/run', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();

        if (data.success) {
            showNotification('Robot Framework d√©mo lanc√©e', 'success');
        } else {
            showNotification(data.message, 'error');
        }
    } catch (error) {
        showNotification('Erreur de lancement', 'error');
    }

    btn.disabled = false;
    btn.innerHTML = '<i data-lucide="play" class="w-4 h-4 mr-2"></i>Lancer Robot Demo';
    lucide.createIcons();
}

// Notification helper
function showNotification(message, type) {
    if (typeof SarfXNotify !== 'undefined') {
        SarfXNotify[type](message);
    } else {
        console.log(`[${type}] ${message}`);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkPlaywright();
    refreshAllStatuses();
    loadVideos();
    loadScreenshots();
    lucide.createIcons();
});

// Close modal on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
});
</script>
{% endblock %}
