{% extends "app_base.html" %}

{% block title %}Sources de données - Admin SarfX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-2026.css') }}">
<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-wrapper fade-in-up">

    <!-- Admin Header -->
    <div class="admin-header-2026">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <a href="{{ url_for('admin.dashboard') }}" class="admin-btn-link mb-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour au Dashboard
                </a>
                <h1 class="admin-title">
                    <span class="admin-title-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i data-lucide="database" class="w-8 h-8"></i>
                    </span>
                    Sources de Données
                </h1>
                <p class="admin-subtitle">
                    <strong>{{ sources | length }}</strong> sources enregistrées
                </p>
            </div>

            <div class="admin-header-actions">
                <a href="{{ url_for('admin.import_atms') }}" class="admin-btn admin-btn-primary">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Nouvel Import
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="admin-stats-grid stagger-container">
        <div class="admin-stat-card stagger-item" style="--stagger-delay: 1">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); color: #8b5cf6;">
                <i data-lucide="database" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Total Sources</p>
                <p class="admin-stat-value">{{ sources | length }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 2">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1)); color: #22c55e;">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Complétées</p>
                <p class="admin-stat-value">{{ sources | selectattr('status', 'eq', 'completed') | list | length }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 3">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); color: #10b981;">
                <i data-lucide="map-pin" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Total ATMs Importés</p>
                <p class="admin-stat-value">{{ sources | sum(attribute='total_atms') | default(0) | number_format }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 4">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); color: #f59e0b;">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Erreurs</p>
                <p class="admin-stat-value">{{ sources | sum(attribute='errors') | default(0) }}</p>
            </div>
        </div>
    </div>

    <!-- Sources List -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="list" class="w-5 h-5 text-purple-500"></i>
                Historique des Imports
            </h3>
        </div>
        <div class="admin-card-body">
            <div class="admin-sources-list">
                {% for source in sources %}
                <div class="admin-source-card">
                    <div class="admin-source-icon
                                {{ 'admin-source-icon-seed' if source.type == 'initial_seed' else 'admin-source-icon-csv' if source.type == 'csv_import' else 'admin-source-icon-api' }}">
                        <i data-lucide="{{ 'database' if source.type == 'initial_seed' else 'file-text' if source.type == 'csv_import' else 'cloud' }}"
                           class="w-6 h-6"></i>
                    </div>

                    <div class="admin-source-info">
                        <h4 class="admin-source-name">{{ source.name }}</h4>
                        <p class="admin-source-id">
                            <i data-lucide="hash" class="w-3 h-3"></i>
                            {{ source.source_id }}
                        </p>
                        {% if source.description %}
                        <p class="admin-source-desc">{{ source.description }}</p>
                        {% endif %}

                        <div class="admin-source-meta">
                            <span>
                                <i data-lucide="calendar" class="w-3 h-3"></i>
                                {{ source.imported_at.strftime('%d/%m/%Y %H:%M') }}
                            </span>
                            {% if source.imported_by %}
                            <span>
                                <i data-lucide="user" class="w-3 h-3"></i>
                                {{ source.imported_by }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="admin-source-stats">
                        <div class="admin-source-count">
                            <span class="admin-source-count-value">{{ source.total_atms | number_format }}</span>
                            <span class="admin-source-count-label">ATMs</span>
                        </div>

                        <span class="admin-badge {{ 'admin-badge-success' if source.status == 'completed' else 'admin-badge-warning' }}">
                            {{ source.status }}
                        </span>
                    </div>

                    {% if source.banks %}
                    <div class="admin-source-banks">
                        <p class="admin-source-banks-label">Banques:</p>
                        <div class="admin-source-banks-list">
                            {% for bank in source.banks %}
                            <span class="admin-badge admin-badge-outline">{{ bank }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if source.errors %}
                    <div class="admin-source-errors">
                        <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                        {{ source.errors }} erreurs lors de l'import
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="admin-empty-state">
                    <i data-lucide="database" class="w-16 h-16"></i>
                    <h3>Aucune source de données</h3>
                    <p>Importez des données ATM pour commencer</p>
                    <a href="{{ url_for('admin.import_atms') }}" class="admin-btn admin-btn-primary">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Importer des données
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Admin Bottom Navigation -->
{% include 'admin/partials/bottom_nav.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
    // Lucide icons init
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endblock %}
