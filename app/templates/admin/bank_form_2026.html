{% extends "app_base.html" %}

{% block title %}{% if action == 'create' %}Ajouter une Banque{% else %}Modifier la Banque{% endif %} - Admin SarfX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-2026.css') }}">
<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
    }

    .color-preview {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .color-preview:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .logo-upload-zone {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .logo-upload-zone:hover,
    .logo-upload-zone.dragover {
        border-color: var(--admin-primary);
        background: rgba(99, 102, 241, 0.1);
    }

    .logo-preview-container {
        width: 120px;
        height: 120px;
        border-radius: 16px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        overflow: hidden;
    }

    .logo-preview-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-wrapper fade-in-up">

    <!-- Admin Header -->
    <div class="admin-header-2026">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <a href="{{ url_for('admin_banks.list_banks') }}" class="admin-btn-link mb-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour aux banques
                </a>
                <h1 class="admin-title">
                    <span class="admin-title-icon" style="background: linear-gradient(135deg, {{ '#10b981' if action == 'create' else '#3b82f6' }}, {{ '#059669' if action == 'create' else '#2563eb' }});">
                        <i data-lucide="{{ 'plus-circle' if action == 'create' else 'edit' }}" class="w-8 h-8"></i>
                    </span>
                    {% if action == 'create' %}
                    Créer une nouvelle banque
                    {% else %}
                    Modifier la banque
                    {% endif %}
                </h1>
                <p class="admin-subtitle">
                    {% if action == 'create' %}
                    Remplissez les informations pour ajouter une nouvelle banque partenaire
                    {% else %}
                    Mise à jour de <strong>{{ bank.name }}</strong>
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="POST" enctype="multipart/form-data" class="admin-form-container">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="admin-form-grid-2col">
            <!-- Left Column -->
            <div class="admin-form-column">
                <!-- Basic Info Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="building-2" class="w-5 h-5 text-blue-500"></i>
                            Informations de base
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Nom de la banque <span class="text-red-500">*</span></label>
                            <input type="text" name="name" required
                                   value="{{ bank.name if bank else '' }}"
                                   class="admin-form-input"
                                   placeholder="Ex: Attijariwafa Bank">
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Nom en arabe</label>
                            <input type="text" name="name_ar" dir="rtl"
                                   value="{{ bank.name_ar if bank else '' }}"
                                   class="admin-form-input"
                                   placeholder="مثال: التجاري وفا بنك">
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Code de la banque <span class="text-red-500">*</span></label>
                            <input type="text" name="code" required
                                   value="{{ bank.code if bank else '' }}"
                                   {% if action == 'edit' %}readonly{% endif %}
                                   class="admin-form-input {% if action == 'edit' %}admin-input-readonly{% endif %}"
                                   placeholder="Ex: attijariwafa">
                            {% if action == 'edit' %}
                            <p class="admin-form-hint">
                                <i data-lucide="info" class="w-3 h-3 inline"></i>
                                Le code ne peut pas être modifié après la création
                            </p>
                            {% endif %}
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Site web</label>
                            <div class="admin-input-icon-wrapper">
                                <i data-lucide="globe" class="admin-input-icon"></i>
                                <input type="url" name="website"
                                       value="{{ bank.website if bank else '' }}"
                                       class="admin-form-input admin-input-with-icon"
                                       placeholder="https://www.example.com">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Info Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="phone" class="w-5 h-5 text-green-500"></i>
                            Contact
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Email de contact</label>
                            <div class="admin-input-icon-wrapper">
                                <i data-lucide="mail" class="admin-input-icon"></i>
                                <input type="email" name="contact_email"
                                       value="{{ bank.contact_email if bank else '' }}"
                                       class="admin-form-input admin-input-with-icon"
                                       placeholder="contact@banque.ma">
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Téléphone</label>
                            <div class="admin-input-icon-wrapper">
                                <i data-lucide="phone" class="admin-input-icon"></i>
                                <input type="tel" name="phone"
                                       value="{{ bank.phone if bank else '' }}"
                                       class="admin-form-input admin-input-with-icon"
                                       placeholder="+212 5XX XX XX XX">
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Adresse du siège</label>
                            <textarea name="address" rows="2"
                                      class="admin-form-textarea"
                                      placeholder="Adresse complète du siège social">{{ bank.address if bank else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="admin-form-column">
                <!-- Logo & Branding Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="palette" class="w-5 h-5 text-purple-500"></i>
                            Logo & Branding
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-form-group">
                            <label class="admin-form-label">Logo de la banque</label>
                            <div class="logo-upload-zone" id="logo-dropzone">
                                <input type="file" name="logo" id="logo-input" accept="image/*"
                                       style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;">
                                <div id="logo-preview-wrapper">
                                    {% if bank and bank.logo %}
                                    <div class="logo-preview-container">
                                        <img src="{{ bank.logo }}" alt="{{ bank.name }}" id="logo-preview">
                                    </div>
                                    <p class="text-sm text-muted mt-3">Cliquez pour changer le logo</p>
                                    {% else %}
                                    <div class="text-center">
                                        <i data-lucide="upload-cloud" class="w-12 h-12 text-muted mx-auto mb-3"></i>
                                        <p class="text-sm text-muted">Glissez-déposez ou cliquez pour télécharger</p>
                                        <p class="text-xs text-muted mt-1">PNG, JPG, SVG (max 2MB)</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Couleur de marque</label>
                            <div class="flex items-center gap-4">
                                <input type="color" name="color" id="color-input"
                                       value="{{ bank.color if bank else '#3b82f6' }}"
                                       class="color-preview">
                                <input type="text" id="color-text"
                                       value="{{ bank.color if bank else '#3b82f6' }}"
                                       class="admin-form-input flex-1 font-mono"
                                       placeholder="#3b82f6">
                            </div>
                            <p class="admin-form-hint">Cette couleur sera utilisée pour identifier la banque</p>
                        </div>
                    </div>
                </div>

                <!-- API Configuration Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="key" class="w-5 h-5 text-cyan-500"></i>
                            Configuration API
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-form-group">
                            <div class="admin-switch-row">
                                <div class="admin-switch-info">
                                    <span class="admin-switch-label">Accès API activé</span>
                                    <span class="admin-switch-desc">Permet à la banque d'utiliser l'API SarfX</span>
                                </div>
                                <label class="admin-switch">
                                    <input type="checkbox" name="api_enabled"
                                           {{ 'checked' if bank and bank.api_enabled else '' }}>
                                    <span class="admin-switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="admin-form-group">
                            <label class="admin-form-label">Limite de requêtes API (par heure)</label>
                            <input type="number" name="rate_limit"
                                   value="{{ bank.rate_limit if bank else 1000 }}"
                                   class="admin-form-input"
                                   min="100" max="10000">
                        </div>
                    </div>
                </div>

                <!-- Status Card -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">
                            <i data-lucide="toggle-right" class="w-5 h-5 text-amber-500"></i>
                            Statut
                        </h3>
                    </div>
                    <div class="admin-card-body">
                        <div class="admin-form-group">
                            <div class="admin-switch-row">
                                <div class="admin-switch-info">
                                    <span class="admin-switch-label">Banque active</span>
                                    <span class="admin-switch-desc">Visible et utilisable par les utilisateurs</span>
                                </div>
                                <label class="admin-switch">
                                    <input type="checkbox" name="is_active"
                                           {{ 'checked' if not bank or bank.is_active else '' }}>
                                    <span class="admin-switch-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="admin-form-actions">
            <a href="{{ url_for('admin_banks.list_banks') }}" class="admin-btn admin-btn-ghost">
                <i data-lucide="x" class="w-4 h-4"></i>
                Annuler
            </a>
            <button type="submit" class="admin-btn admin-btn-primary">
                <i data-lucide="{{ 'plus' if action == 'create' else 'save' }}" class="w-4 h-4"></i>
                {% if action == 'create' %}
                Créer la banque
                {% else %}
                Enregistrer les modifications
                {% endif %}
            </button>
        </div>
    </form>

</div>

<!-- Admin Bottom Navigation -->
{% include 'admin/partials/bottom_nav.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Color input sync
    const colorInput = document.getElementById('color-input');
    const colorText = document.getElementById('color-text');

    colorInput.addEventListener('input', function() {
        colorText.value = this.value;
    });

    colorText.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            colorInput.value = this.value;
        }
    });

    // Logo upload
    const dropzone = document.getElementById('logo-dropzone');
    const logoInput = document.getElementById('logo-input');
    const previewWrapper = document.getElementById('logo-preview-wrapper');

    dropzone.addEventListener('click', () => logoInput.click());

    dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length) {
            logoInput.files = files;
            handleLogoPreview(files[0]);
        }
    });

    logoInput.addEventListener('change', function() {
        if (this.files.length) {
            handleLogoPreview(this.files[0]);
        }
    });

    function handleLogoPreview(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewWrapper.innerHTML = `
                    <div class="logo-preview-container">
                        <img src="${e.target.result}" alt="Preview" id="logo-preview">
                    </div>
                    <p class="text-sm text-muted mt-3">Cliquez pour changer le logo</p>
                `;
            };
            reader.readAsDataURL(file);
        }
    }
});
</script>
{% endblock %}
