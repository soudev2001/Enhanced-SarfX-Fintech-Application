{% extends "app_base.html" %}

{% block title %}Gestion ATM - Admin SarfX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-2026.css') }}">
<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-wrapper fade-in-up">

    <!-- Admin Header -->
    <div class="admin-header-2026">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <a href="{{ url_for('admin.dashboard') }}" class="admin-btn-link mb-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour au Dashboard
                </a>
                <h1 class="admin-title">
                    <span class="admin-title-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i data-lucide="map-pin" class="w-8 h-8"></i>
                    </span>
                    Gestion ATM
                </h1>
                <p class="admin-subtitle">
                    <strong id="atm-count">{{ total_atms | default(0) | number_format }}</strong> guichets automatiques
                </p>
            </div>

            <div class="admin-header-actions">
                <a href="{{ url_for('admin.atm_dashboard') }}" class="admin-btn admin-btn-outline-secondary">
                    <i data-lucide="pie-chart" class="w-4 h-4"></i>
                    Analytics
                </a>
                <a href="{{ url_for('admin.import_atms') }}" class="admin-btn admin-btn-outline-primary">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Import CSV
                </a>
                <a href="{{ url_for('admin.add_atm') }}" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Ajouter ATM
                </a>
            </div>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="admin-stats-grid stagger-container">
        <div class="admin-stat-card stagger-item" style="--stagger-delay: 1">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.1)); color: #10b981;">
                <i data-lucide="map-pin" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Total ATMs</p>
                <p class="admin-stat-value">{{ total_atms | default(0) | number_format }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 2">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1)); color: #22c55e;">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Actifs</p>
                <p class="admin-stat-value">{{ active_count | default(total_atms) | number_format }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 3">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); color: #f59e0b;">
                <i data-lucide="wrench" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Maintenance</p>
                <p class="admin-stat-value">{{ maintenance_count | default(0) | number_format }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 4">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); color: #3b82f6;">
                <i data-lucide="building-2" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Banques</p>
                <p class="admin-stat-value">{{ banks | length | default(0) }}</p>
            </div>
        </div>
    </div>

    <!-- Bank Quick Filters -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="building-2" class="w-5 h-5 text-primary"></i>
                Filtrer par Banque
            </h3>
        </div>
        <div class="admin-card-body">
            <div class="admin-bank-filters">
                <button onclick="filterByBank('')" class="admin-bank-filter-btn {{ 'active' if not request.args.get('bank') else '' }}">
                    <span class="admin-bank-filter-count">{{ total_atms | default(0) }}</span>
                    <span class="admin-bank-filter-name">Toutes</span>
                </button>
                {% for bank in banks %}
                <button onclick="filterByBank('{{ bank.code }}')"
                        class="admin-bank-filter-btn {{ 'active' if request.args.get('bank') == bank.code else '' }}"
                        style="--bank-color: {{ bank.color }}">
                    <span class="admin-bank-filter-count">{{ bank.atm_count | default(0) }}</span>
                    <span class="admin-bank-filter-name">{{ bank.name.split()[0] }}</span>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="admin-card">
        <div class="admin-card-body">
            <form method="GET" action="{{ url_for('admin.atms') }}" id="filter-form" class="admin-filters-form">
                <div class="admin-filters-grid">
                    <div class="admin-search-box">
                        <i data-lucide="search" class="admin-search-icon"></i>
                        <input type="text" name="q" value="{{ request.args.get('q', '') }}"
                               placeholder="Rechercher ATM, adresse..."
                               class="admin-search-input">
                    </div>

                    <select name="bank" onchange="this.form.submit()" class="admin-select">
                        <option value="">Toutes les banques</option>
                        {% for bank in banks %}
                        <option value="{{ bank.code }}" {{ 'selected' if request.args.get('bank') == bank.code else '' }}>
                            {{ bank.name }}
                        </option>
                        {% endfor %}
                    </select>

                    <select name="city" onchange="this.form.submit()" class="admin-select">
                        <option value="">Toutes les villes</option>
                        {% for city in cities %}
                        <option value="{{ city.city }}" {{ 'selected' if request.args.get('city') == city.city else '' }}>
                            {{ city.city }} ({{ city.atm_count }})
                        </option>
                        {% endfor %}
                    </select>

                    <select name="status" onchange="this.form.submit()" class="admin-select">
                        <option value="">Tous statuts</option>
                        <option value="active" {{ 'selected' if request.args.get('status') == 'active' else '' }}>Actif</option>
                        <option value="inactive" {{ 'selected' if request.args.get('status') == 'inactive' else '' }}>Inactif</option>
                        <option value="maintenance" {{ 'selected' if request.args.get('status') == 'maintenance' else '' }}>Maintenance</option>
                    </select>
                </div>
            </form>
        </div>
    </div>

    <!-- ATM List -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="list" class="w-5 h-5 text-success"></i>
                Liste des ATMs
            </h3>
            <div class="admin-header-actions">
                <label class="admin-checkbox-label">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                    <span>Tout sélectionner</span>
                </label>
            </div>
        </div>
        <div class="admin-card-body">
            <div class="admin-atm-list">
                {% for atm in atms %}
                <div class="admin-atm-card" data-atm-id="{{ atm._id }}">
                    <div class="admin-atm-checkbox">
                        <input type="checkbox" class="atm-checkbox" value="{{ atm._id }}">
                    </div>

                    <div class="admin-atm-bank-logo" style="background: {{ banks_dict.get(atm.bank_code, {}).get('color', '#3b82f6') }}20;">
                        {% if atm.bank_code and banks_dict.get(atm.bank_code, {}).get('logo') %}
                        <img src="{{ banks_dict[atm.bank_code].logo }}" alt="{{ atm.bank_code }}">
                        {% else %}
                        <i data-lucide="building-2" class="w-6 h-6" style="color: {{ banks_dict.get(atm.bank_code, {}).get('color', '#3b82f6') }}"></i>
                        {% endif %}
                    </div>

                    <div class="admin-atm-info">
                        <h4 class="admin-atm-name">{{ atm.name | default('ATM ' ~ atm.atm_id) }}</h4>
                        <p class="admin-atm-address">
                            <i data-lucide="map-pin" class="w-3 h-3"></i>
                            {{ atm.address | default('Adresse non renseignée') }}
                        </p>
                        <p class="admin-atm-city">
                            <i data-lucide="building" class="w-3 h-3"></i>
                            {{ atm.city | default('Ville non renseignée') }}
                        </p>
                    </div>

                    <div class="admin-atm-status">
                        {% if atm.status == 'active' %}
                        <span class="admin-badge admin-badge-success">
                            <i data-lucide="check-circle" class="w-3 h-3"></i>
                            Actif
                        </span>
                        {% elif atm.status == 'maintenance' %}
                        <span class="admin-badge admin-badge-warning">
                            <i data-lucide="wrench" class="w-3 h-3"></i>
                            Maintenance
                        </span>
                        {% else %}
                        <span class="admin-badge admin-badge-danger">
                            <i data-lucide="x-circle" class="w-3 h-3"></i>
                            Inactif
                        </span>
                        {% endif %}
                    </div>

                    <div class="admin-atm-actions">
                        <a href="{{ url_for('admin.view_atm', atm_id=atm._id) }}" class="admin-btn-icon" title="Voir">
                            <i data-lucide="eye" class="w-4 h-4"></i>
                        </a>
                        <a href="{{ url_for('admin.edit_atm', atm_id=atm._id) }}" class="admin-btn-icon" title="Modifier">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </a>
                        <form action="{{ url_for('admin.delete_atm', atm_id=atm._id) }}" method="POST" style="display:inline"
                              onsubmit="return confirm('Supprimer cet ATM ?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="admin-btn-icon admin-btn-icon-danger" title="Supprimer">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="admin-empty-state">
                    <i data-lucide="map-pin-off" class="w-16 h-16"></i>
                    <h3>Aucun ATM trouvé</h3>
                    <p>Ajoutez des ATMs ou modifiez vos filtres</p>
                    <a href="{{ url_for('admin.add_atm') }}" class="admin-btn admin-btn-primary">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Ajouter un ATM
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="admin-pagination">
        {% if page > 1 %}
        <a href="{{ url_for('admin.atms', page=page-1, **request.args.to_dict(flat=False)) }}" class="admin-pagination-btn">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
            Précédent
        </a>
        {% endif %}

        <span class="admin-pagination-info">
            Page {{ page }} / {{ total_pages }}
        </span>

        {% if page < total_pages %}
        <a href="{{ url_for('admin.atms', page=page+1, **request.args.to_dict(flat=False)) }}" class="admin-pagination-btn">
            Suivant
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Admin Bottom Navigation -->
{% include 'admin/partials/bottom_nav.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
    function filterByBank(bankCode) {
        const url = new URL(window.location);
        if (bankCode) {
            url.searchParams.set('bank', bankCode);
        } else {
            url.searchParams.delete('bank');
        }
        url.searchParams.delete('page');
        window.location = url;
    }

    function toggleSelectAll() {
        const selectAll = document.getElementById('select-all');
        document.querySelectorAll('.atm-checkbox').forEach(cb => {
            cb.checked = selectAll.checked;
        });
        updateBulkActions();
    }

    function updateBulkActions() {
        const checked = document.querySelectorAll('.atm-checkbox:checked').length;
        const bulkActions = document.getElementById('bulk-actions');
        if (bulkActions) {
            bulkActions.style.display = checked > 0 ? 'flex' : 'none';
        }
    }

    document.querySelectorAll('.atm-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkActions);
    });

    // Lucide icons init
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endblock %}
