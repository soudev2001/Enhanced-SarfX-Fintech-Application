{% extends "app_base.html" %}

{% block title %}Dashboard ATM - Admin SarfX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-2026.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-wrapper fade-in-up">

    <!-- Admin Header -->
    <div class="admin-header-2026">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <a href="{{ url_for('admin.atms') }}" class="admin-btn-link mb-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour aux ATMs
                </a>
                <h1 class="admin-title">
                    <span class="admin-title-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                        <i data-lucide="bar-chart-3" class="w-8 h-8"></i>
                    </span>
                    Dashboard ATM Analytics
                </h1>
                <p class="admin-subtitle">
                    Analyse des <strong>{{ total_atms | default(0) | number_format }}</strong> guichets automatiques
                </p>
            </div>

            <div class="admin-header-actions">
                <span class="admin-badge admin-badge-success">
                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                    {{ active_atms | default(0) | number_format }} actifs
                </span>
                <span class="admin-badge admin-badge-danger">
                    <i data-lucide="x-circle" class="w-3 h-3"></i>
                    {{ inactive_atms | default(0) | number_format }} inactifs
                </span>
            </div>
        </div>
    </div>

    <!-- KPI Stats Grid -->
    <div class="admin-stats-grid stagger-container">
        <div class="admin-stat-card stagger-item" style="--stagger-delay: 1">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(8, 145, 178, 0.1)); color: #06b6d4;">
                <i data-lucide="landmark" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Total ATM</p>
                <p class="admin-stat-value">{{ total_atms | default(0) | number_format }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 2">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.1)); color: #8b5cf6;">
                <i data-lucide="building-2" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Banques Partenaires</p>
                <p class="admin-stat-value">{{ banks | length | default(0) }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 3">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.1)); color: #f59e0b;">
                <i data-lucide="map" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Villes Couvertes</p>
                <p class="admin-stat-value">{{ cities | length | default(0) }}</p>
            </div>
        </div>

        <div class="admin-stat-card stagger-item" style="--stagger-delay: 4">
            <div class="admin-stat-icon" style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(22, 163, 74, 0.1)); color: #22c55e;">
                <i data-lucide="clock" class="w-6 h-6"></i>
            </div>
            <div class="admin-stat-content">
                <p class="admin-stat-label">Disponibles 24h</p>
                <p class="admin-stat-value">{{ atm_24h_percent | default(0) }}%</p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="admin-charts-grid">
        <div class="admin-card admin-chart-card">
            <div class="admin-card-header">
                <h3 class="admin-card-title">
                    <i data-lucide="pie-chart" class="w-5 h-5 text-cyan-500"></i>
                    Répartition par Banque
                </h3>
            </div>
            <div class="admin-card-body">
                <div class="admin-chart-container">
                    <canvas id="bankChart"></canvas>
                </div>
                <div class="admin-chart-legend">
                    {% for bank in banks_stats %}
                    <div class="admin-legend-item">
                        <div class="admin-legend-color" style="background: {{ bank.color }}"></div>
                        <span class="admin-legend-label">{{ bank.name }}</span>
                        <span class="admin-legend-value">{{ bank.count | number_format }}</span>
                        <span class="admin-legend-percent">({{ bank.percent }}%)</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="admin-card admin-chart-card">
            <div class="admin-card-header">
                <h3 class="admin-card-title">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-purple-500"></i>
                    Top 10 Villes
                </h3>
            </div>
            <div class="admin-card-body">
                <div class="admin-chart-container">
                    <canvas id="cityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Services & Features -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="settings-2" class="w-5 h-5 text-green-500"></i>
                Services & Fonctionnalités
            </h3>
        </div>
        <div class="admin-card-body">
            <div class="admin-services-grid">
                {% for svc_name, svc_data in services_stats.items() %}
                <div class="admin-service-card">
                    <div class="admin-service-icon" style="color: {{ svc_data.color }}">
                        <i data-lucide="{{ svc_data.icon }}" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-service-info">
                        <h4 class="admin-service-name">{{ svc_name | replace('_', ' ') | title }}</h4>
                        <p class="admin-service-count">{{ svc_data.count | number_format }} ATMs</p>
                    </div>
                    <div class="admin-service-progress">
                        <div class="admin-progress-bar">
                            <div class="admin-progress-fill" style="width: {{ svc_data.percent }}%; background: {{ svc_data.color }}"></div>
                        </div>
                        <span class="admin-progress-label">{{ svc_data.percent }}%</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Accessibility Features -->
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="accessibility" class="w-5 h-5 text-blue-500"></i>
                Accessibilité & Équipements
            </h3>
        </div>
        <div class="admin-card-body">
            <div class="admin-accessibility-grid">
                <div class="admin-accessibility-item">
                    <div class="admin-accessibility-icon" style="background: rgba(59, 130, 246, 0.15); color: #3b82f6;">
                        <i data-lucide="accessibility" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-accessibility-info">
                        <h4>Accès fauteuil</h4>
                        <div class="admin-progress-bar">
                            <div class="admin-progress-fill" style="width: {{ wheelchair_percent }}%; background: #3b82f6;"></div>
                        </div>
                    </div>
                    <span class="admin-accessibility-percent">{{ wheelchair_percent }}%</span>
                </div>

                <div class="admin-accessibility-item">
                    <div class="admin-accessibility-icon" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6;">
                        <i data-lucide="smartphone-nfc" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-accessibility-info">
                        <h4>Sans contact (NFC)</h4>
                        <div class="admin-progress-bar">
                            <div class="admin-progress-fill" style="width: {{ nfc_percent }}%; background: #8b5cf6;"></div>
                        </div>
                    </div>
                    <span class="admin-accessibility-percent">{{ nfc_percent }}%</span>
                </div>

                <div class="admin-accessibility-item">
                    <div class="admin-accessibility-icon" style="background: rgba(34, 197, 94, 0.15); color: #22c55e;">
                        <i data-lucide="wallet" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-accessibility-info">
                        <h4>Dépôt d'espèces</h4>
                        <div class="admin-progress-bar">
                            <div class="admin-progress-fill" style="width: {{ deposit_percent }}%; background: #22c55e;"></div>
                        </div>
                    </div>
                    <span class="admin-accessibility-percent">{{ deposit_percent }}%</span>
                </div>

                <div class="admin-accessibility-item">
                    <div class="admin-accessibility-icon" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b;">
                        <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-accessibility-info">
                        <h4>24h/24</h4>
                        <div class="admin-progress-bar">
                            <div class="admin-progress-fill" style="width: {{ atm_24h_percent }}%; background: #f59e0b;"></div>
                        </div>
                    </div>
                    <span class="admin-accessibility-percent">{{ atm_24h_percent }}%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sources -->
    {% if sources %}
    <div class="admin-card">
        <div class="admin-card-header">
            <h3 class="admin-card-title">
                <i data-lucide="database" class="w-5 h-5 text-orange-500"></i>
                Dernières Sources
            </h3>
            <a href="{{ url_for('admin.sources') }}" class="admin-btn admin-btn-outline-primary admin-btn-sm">
                Voir tout
            </a>
        </div>
        <div class="admin-card-body">
            <div class="admin-sources-mini-list">
                {% for source in sources %}
                <div class="admin-source-mini">
                    <div class="admin-source-mini-icon">
                        <i data-lucide="{{ 'database' if source.type == 'initial_seed' else 'file-text' }}" class="w-4 h-4"></i>
                    </div>
                    <div class="admin-source-mini-info">
                        <span class="admin-source-mini-name">{{ source.name }}</span>
                        <span class="admin-source-mini-date">{{ source.imported_at.strftime('%d/%m/%Y') }}</span>
                    </div>
                    <span class="admin-source-mini-count">{{ source.total_atms }} ATMs</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Admin Bottom Navigation -->
{% include 'admin/partials/bottom_nav.html' %}

{% endblock %}

{% block extra_scripts %}
<script>
// Chart Data from backend
const banksChartData = {{ banks_chart_data | safe }};
const citiesChartData = {{ cities_chart_data | safe }};

// Bank Donut Chart
const bankCtx = document.getElementById('bankChart').getContext('2d');
new Chart(bankCtx, {
    type: 'doughnut',
    data: {
        labels: banksChartData.labels,
        datasets: [{
            data: banksChartData.values,
            backgroundColor: banksChartData.colors,
            borderWidth: 0,
            hoverOffset: 10
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        cutout: '65%'
    }
});

// Cities Bar Chart
const cityCtx = document.getElementById('cityChart').getContext('2d');
new Chart(cityCtx, {
    type: 'bar',
    data: {
        labels: citiesChartData.labels,
        datasets: [{
            data: citiesChartData.values,
            backgroundColor: 'rgba(99, 102, 241, 0.8)',
            borderRadius: 8,
            borderSkipped: false
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: { display: false }
        },
        scales: {
            x: {
                grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { color: '#94a3b8' }
            },
            y: {
                grid: { display: false },
                ticks: { color: '#94a3b8' }
            }
        }
    }
});

// Init Lucide
if (typeof lucide !== 'undefined') {
    lucide.createIcons();
}
</script>
{% endblock %}
