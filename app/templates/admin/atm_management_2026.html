{% extends "app_base.html" %}

{% block title %}Gestion ATMs - SarfX{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin-2026.css') }}">
<style>
    body {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard-wrapper fade-in-up">

    <!-- Admin Header -->
    <div class="admin-header-2026">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <a href="{{ url_for('app.admin_associate_bank') }}" class="admin-btn-link mb-2">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                    Retour au Dashboard
                </a>
                <h1 class="admin-title">
                    <span class="admin-title-icon" style="background: linear-gradient(135deg, #ec4899, #f43f5e);">
                        <i data-lucide="map-pin" class="w-8 h-8"></i>
                    </span>
                    Gestion des ATMs
                </h1>
                <p class="admin-subtitle">
                    <strong id="atm-count">{{ atms | length }}</strong> ATM(s) enregistré(s)
                </p>
            </div>

            <div class="admin-header-actions">
                <button onclick="openAddATMModal()" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Ajouter un ATM
                </button>
            </div>
        </div>
    </div>

    {% if atms %}
    <!-- ATMs List -->
    <div class="admin-atm-list">
        {% for atm in atms %}
        <div class="admin-card admin-atm-item stagger-item" style="--stagger-delay: {{ loop.index }}">
            <div class="admin-card-body">
                <div class="admin-atm-content">
                    <div class="admin-atm-icon">
                        <i data-lucide="landmark" class="w-6 h-6"></i>
                    </div>
                    <div class="admin-atm-info">
                        <h3 class="admin-atm-name">{{ atm.name or 'ATM #' + atm._id[-6:] }}</h3>
                        <p class="admin-atm-id">ID: {{ atm._id }}</p>
                    </div>
                    <div class="admin-atm-details">
                        <div class="admin-atm-detail">
                            <span class="admin-atm-detail-label">Adresse</span>
                            <span class="admin-atm-detail-value">{{ atm.address or 'N/A' }}</span>
                        </div>
                        <div class="admin-atm-detail">
                            <span class="admin-atm-detail-label">Ville</span>
                            <span class="admin-atm-detail-value">{{ atm.city or 'N/A' }}</span>
                        </div>
                        <div class="admin-atm-detail">
                            <span class="admin-atm-detail-label">Statut</span>
                            <span class="admin-atm-detail-value">
                                {% if atm.is_active %}
                                <span class="admin-badge admin-badge-success">
                                    <i data-lucide="check-circle" class="w-3 h-3"></i>
                                    Actif
                                </span>
                                {% else %}
                                <span class="admin-badge admin-badge-danger">
                                    <i data-lucide="x-circle" class="w-3 h-3"></i>
                                    Inactif
                                </span>
                                {% endif %}
                            </span>
                        </div>
                        {% if atm.latitude and atm.longitude %}
                        <div class="admin-atm-detail">
                            <span class="admin-atm-detail-label">Coordonnées</span>
                            <span class="admin-atm-detail-value">{{ "%.4f"|format(atm.latitude) }}, {{ "%.4f"|format(atm.longitude) }}</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="admin-atm-actions">
                        <button onclick="editATM('{{ atm._id }}')" class="admin-btn admin-btn-sm admin-btn-outline-primary">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                            Modifier
                        </button>
                        <button onclick="deleteATM('{{ atm._id }}')" class="admin-btn admin-btn-sm admin-btn-outline-danger">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                            Supprimer
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="admin-card">
        <div class="admin-card-body">
            <div class="admin-empty-state">
                <div class="admin-empty-icon">
                    <i data-lucide="map-pin" class="w-16 h-16"></i>
                </div>
                <h2 class="admin-empty-title">Aucun ATM enregistré</h2>
                <p class="admin-empty-desc">
                    Commencez par ajouter votre premier distributeur automatique
                </p>
                <button onclick="openAddATMModal()" class="admin-btn admin-btn-primary">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Ajouter un ATM
                </button>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Modal d'ajout/modification -->
<div id="atm-modal" class="admin-modal">
    <div class="admin-modal-backdrop" onclick="closeATMModal()"></div>
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h2 class="admin-modal-title" id="modal-title">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
                Ajouter un ATM
            </h2>
            <button onclick="closeATMModal()" class="admin-modal-close">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form id="atm-form">
            <div class="admin-modal-body">
                <div class="admin-form-group">
                    <label class="admin-form-label">Nom / Identifiant</label>
                    <input type="text" name="name" required class="admin-form-input" placeholder="Ex: ATM Agdal Centre">
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Adresse</label>
                    <input type="text" name="address" required class="admin-form-input" placeholder="Ex: 123 Avenue Mohammed V">
                </div>

                <div class="admin-form-group">
                    <label class="admin-form-label">Ville</label>
                    <input type="text" name="city" required class="admin-form-input" placeholder="Ex: Rabat">
                </div>

                <div class="admin-form-row">
                    <div class="admin-form-group">
                        <label class="admin-form-label">Latitude</label>
                        <input type="number" name="latitude" step="any" class="admin-form-input" placeholder="Ex: 33.9715">
                    </div>
                    <div class="admin-form-group">
                        <label class="admin-form-label">Longitude</label>
                        <input type="number" name="longitude" step="any" class="admin-form-input" placeholder="Ex: -6.8498">
                    </div>
                </div>

                <div class="admin-form-group">
                    <label class="admin-switch-label">
                        <input type="checkbox" name="is_active" checked class="admin-switch-input">
                        <span class="admin-switch-slider"></span>
                        <span class="admin-switch-text">ATM Actif</span>
                    </label>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" onclick="closeATMModal()" class="admin-btn admin-btn-outline-secondary">
                    Annuler
                </button>
                <button type="submit" class="admin-btn admin-btn-primary">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Bottom Navigation -->
{% include 'admin/partials/bottom_nav.html' %}
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    let editingATMId = null;

    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();
    });

    function openAddATMModal() {
        editingATMId = null;
        document.getElementById('modal-title').innerHTML = '<i data-lucide="map-pin" class="w-5 h-5"></i> Ajouter un ATM';
        document.getElementById('atm-form').reset();
        document.getElementById('atm-modal').classList.add('active');
        lucide.createIcons();
    }

    function closeATMModal() {
        document.getElementById('atm-modal').classList.remove('active');
    }

    function editATM(atmId) {
        editingATMId = atmId;
        document.getElementById('modal-title').innerHTML = '<i data-lucide="pencil" class="w-5 h-5"></i> Modifier l\'ATM';

        // Récupérer les données de l'ATM via API
        fetch(`/api/atms/${atmId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.atm) {
                    const form = document.getElementById('atm-form');
                    form.querySelector('[name="name"]').value = data.atm.name || '';
                    form.querySelector('[name="address"]').value = data.atm.address || '';
                    form.querySelector('[name="city"]').value = data.atm.city || '';
                    form.querySelector('[name="latitude"]').value = data.atm.latitude || '';
                    form.querySelector('[name="longitude"]').value = data.atm.longitude || '';
                    form.querySelector('[name="is_active"]').checked = data.atm.is_active !== false;
                }
                document.getElementById('atm-modal').classList.add('active');
                lucide.createIcons();
            })
            .catch(err => {
                console.error('Erreur:', err);
                showToast('Erreur lors du chargement des données', 'error');
            });
    }

    function deleteATM(atmId) {
        if (!confirm('Êtes-vous sûr de vouloir supprimer cet ATM ?')) {
            return;
        }

        fetch(`/api/atms/${atmId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('ATM supprimé avec succès', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Erreur lors de la suppression', 'error');
            }
        })
        .catch(err => {
            console.error('Erreur:', err);
            showToast('Erreur lors de la suppression', 'error');
        });
    }

    document.getElementById('atm-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {
            name: formData.get('name'),
            address: formData.get('address'),
            city: formData.get('city'),
            latitude: parseFloat(formData.get('latitude')) || null,
            longitude: parseFloat(formData.get('longitude')) || null,
            is_active: formData.get('is_active') === 'on'
        };

        const url = editingATMId ? `/api/atms/${editingATMId}` : '/api/atms';
        const method = editingATMId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(editingATMId ? 'ATM modifié avec succès' : 'ATM ajouté avec succès', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Erreur lors de l\'opération', 'error');
            }
        })
        .catch(err => {
            console.error('Erreur:', err);
            showToast('Erreur lors de l\'opération', 'error');
        });
    });

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `admin-toast admin-toast-${type}`;
        toast.innerHTML = `
            <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}" class="w-5 h-5"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(toast);
        lucide.createIcons();

        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
</script>
{% endblock %}
