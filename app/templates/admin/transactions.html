{% extends "common/app_base.html" %}

{% block title %}Transactions - Admin SarfX{% endblock %}

{% block content %}
<div class="space-y-6 pb-24">
    <!-- Header -->
    <div class="flex justify-between items-center pt-2">
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="text-muted text-sm flex items-center gap-1 mb-2">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Retour
            </a>
            <h1 class="text-2xl font-bold text-default flex items-center gap-2">
                <i data-lucide="receipt" class="w-6 h-6 text-rose-500"></i>
                Transactions
            </h1>
            <p class="text-muted text-sm">{{ transactions | length }} transactions enregistrées</p>
        </div>
        <div class="flex items-center gap-2">
            <a href="{{ url_for('admin.export_transactions') }}" class="card px-3 py-2 rounded-lg text-blue-500 font-bold text-sm flex items-center gap-1">
                <i data-lucide="download" class="w-4 h-4"></i> CSV
            </a>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="card p-4 rounded-xl space-y-4">
        <!-- Search -->
        <div class="relative">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted"></i>
            <input type="text" id="search-input" onkeyup="filterTransactions()" placeholder="Rechercher par email, ID..."
                   class="input w-full rounded-xl pl-10 pr-4 py-2 text-sm">
        </div>

        <!-- Status Filters -->
        <div class="flex gap-2 overflow-x-auto pb-1">
            <a href="{{ url_for('admin.transactions') }}"
               class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap {{ 'bg-blue-500 text-white' if not request.args.get('status') else 'card text-muted' }}">
                Toutes
            </a>
            <a href="{{ url_for('admin.transactions', status='completed') }}"
               class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap {{ 'badge badge-success' if request.args.get('status') == 'completed' else 'card text-muted' }}">
                Complétées
            </a>
            <a href="{{ url_for('admin.transactions', status='pending') }}"
               class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap {{ 'badge badge-warning' if request.args.get('status') == 'pending' else 'card text-muted' }}">
                En attente
            </a>
            <a href="{{ url_for('admin.transactions', status='failed') }}"
               class="px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap {{ 'badge badge-error' if request.args.get('status') == 'failed' else 'card text-muted' }}">
                Échouées
            </a>
        </div>
    </div>

    <!-- Transactions List -->
    <div class="space-y-3">
        {% for tx in transactions %}
        <div class="card p-4 rounded-xl space-y-3 tx-card"
             data-email="{{ (tx.user_email or '') | lower }}"
             data-id="{{ (tx.transaction_id or tx._id|string or '') | lower }}"
             data-status="{{ tx.status or 'pending' }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full {{ 'bg-emerald-500/20 text-emerald-500' if tx.type == 'receive' else 'bg-rose-500/20 text-rose-500' }} flex items-center justify-center">
                        <i data-lucide="{{ 'arrow-down-left' if tx.type == 'receive' else 'arrow-up-right' }}" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <p class="font-bold text-default">{{ tx.user_email or 'Unknown' }}</p>
                        <p class="text-[10px] text-muted font-mono">{{ (tx.transaction_id or tx._id|string)[:16] }}...</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-default">{{ "{:,.2f}".format(tx.amount or 0) }} {{ tx.from_currency or '?' }}</p>
                    <p class="text-xs text-muted">→ {{ "{:,.2f}".format(tx.final_amount or 0) }} {{ tx.to_currency or '?' }}</p>
                </div>
            </div>

            <div class="flex items-center justify-between text-xs">
                <div class="flex items-center gap-2">
                    <span class="px-2 py-0.5 rounded-full
                        {% if tx.status == 'completed' %}badge badge-success
                        {% elif tx.status == 'pending' %}badge badge-warning
                        {% else %}badge badge-error{% endif %}">
                        {{ (tx.status or 'pending') | upper }}
                    </span>
                    <span class="text-muted">
                        {{ tx.created_at.strftime('%d/%m/%Y %H:%M') if tx.created_at else '--' }}
                    </span>
                </div>

                <!-- Status Update -->
                <form action="{{ url_for('admin.update_transaction_status', tx_id=(tx.transaction_id or tx._id|string)) }}" method="POST" class="inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <select name="status" onchange="this.form.submit()" class="input rounded px-2 py-1 text-xs bg-transparent">
                        <option value="pending" {{ 'selected' if tx.status == 'pending' else '' }}>En attente</option>
                        <option value="completed" {{ 'selected' if tx.status == 'completed' else '' }}>Complétée</option>
                        <option value="failed" {{ 'selected' if tx.status == 'failed' else '' }}>Échouée</option>
                    </select>
                </form>
            </div>

            {% if tx.recipient_name %}
            <div class="bg-slate-800/30 p-2 rounded-lg text-xs">
                <span class="text-muted">Bénéficiaire:</span>
                <span class="text-default font-medium">{{ tx.recipient_name }}</span>
                {% if tx.recipient_account %}
                <span class="text-muted ml-2">{{ tx.recipient_account }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="card p-8 rounded-xl text-center">
            <div class="w-16 h-16 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">
                <i data-lucide="inbox" class="w-8 h-8 text-slate-500"></i>
            </div>
            <p class="text-muted">Aucune transaction</p>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Admin Navigation -->
<nav class="fixed bottom-0 left-0 right-0 border-t border-border px-6 py-3 z-40" style="background: var(--bg-secondary); backdrop-filter: blur(20px);">
    <div class="flex justify-around items-center max-w-lg mx-auto">
        <a href="{{ url_for('admin.dashboard') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span class="text-xs">Dashboard</span>
        </a>
        <a href="{{ url_for('admin.users') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="text-xs">Users</span>
        </a>
        <a href="{{ url_for('admin.transactions') }}" class="flex flex-col items-center gap-1 text-primary">
            <i data-lucide="receipt" class="w-5 h-5"></i>
            <span class="text-xs font-bold">Txns</span>
        </a>
        <a href="{{ url_for('admin_banks.list_banks') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="building-2" class="w-5 h-5"></i>
            <span class="text-xs">Banques</span>
        </a>
        <a href="{{ url_for('app.home') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-xs">App</span>
        </a>
    </div>
</nav>

<script>
function filterTransactions() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const cards = document.querySelectorAll('.tx-card');

    cards.forEach(card => {
        const email = card.dataset.email || '';
        const id = card.dataset.id || '';

        const matches = email.includes(search) || id.includes(search);
        card.style.display = matches ? 'block' : 'none';
    });
}
</script>
{% endblock %}
