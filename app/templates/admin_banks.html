{% extends "app_base.html" %}

{% block title %}Banques Partenaires - Admin SarfX{% endblock %}

{% block extra_head %}
<style>
    :root {
        --card-bg: var(--bg-secondary);
        --card-border: var(--border-light);
        --card-shadow: var(--shadow-md);
        --card-shadow-hover: var(--shadow-lg);
    }
    [data-theme="dark"] {
        --card-bg: var(--bg-tertiary);
        --card-border: var(--border-medium);
    }
    .bank-card {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        transition: all 0.2s ease-in-out;
    }
    .bank-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--card-shadow-hover);
    }
    .bank-logo-container {
        width: 60px;
        height: 60px;
        padding: 8px; /* Give some space for the logo */
        background-color: #ffffff; /* Always white for contrast */
    }
    .bank-logo-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    .btn-action {
        flex: 1;
        text-align: center;
    }
</style>
{% endblock %}


{% block content %}
<div class="space-y-6 pb-24">
    <!-- Header -->
    <div class="flex flex-wrap gap-4 justify-between items-center pt-2">
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="text-muted text-sm flex items-center gap-1 mb-2 hover:text-primary transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4"></i>
                Retour
            </a>
            <h1 class="text-3xl font-bold text-default flex items-center gap-3">
                <i data-lucide="building-2" class="w-8 h-8 text-blue-500"></i>
                Banques Partenaires
            </h1>
            <p class="text-muted text-sm mt-1">{{ banks | length }} banques enregistrées</p>
        </div>
        <a href="{{ url_for('admin_banks.create_bank') }}" class="btn btn-primary">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Ajouter une Banque</span>
        </a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                <i data-lucide="{% if category == 'success' %}check-circle{% elif category == 'error' %}x-circle{% else %}info{% endif %}" class="w-5 h-5"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Search -->
    <div class="card p-4 rounded-xl">
        <div class="relative">
            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-muted"></i>
            <input type="text" id="search-input" onkeyup="filterBanks()" placeholder="Rechercher par nom ou code..." 
                   class="input w-full rounded-xl pl-12 pr-4 py-3 text-base">
        </div>
    </div>

    <!-- Banks Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="banks-grid">
        {% for bank in banks %}
        <div class="bank-card rounded-2xl flex flex-col" data-name="{{ bank.name | lower }}" data-code="{{ bank.code | lower }}">
            <div class="p-6 flex-grow">
                <div class="flex items-start justify-between">
                    <div class="flex items-start gap-4">
                        <div class="bank-logo-container rounded-xl flex items-center justify-center overflow-hidden shadow-sm">
                            {% if bank.logo %}
                            <img src="{{ bank.logo }}" alt="{{ bank.name }} logo" class="bank-logo-img">
                            {% else %}
                            <i data-lucide="building-2" class="w-8 h-8 text-muted"></i>
                            {% endif %}
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-default">{{ bank.name }}</h3>
                            <p class="text-sm text-muted">{{ bank.code }}</p>
                        </div>
                    </div>
                    
                    <span class="badge {{ 'badge-success' if bank.is_active else 'badge-error' }} mt-1">
                        {% if bank.is_active %}Actif{% else %}Inactif{% endif %}
                    </span>
                </div>
                
                {% if bank.website %}
                <a href="{{ bank.website }}" target="_blank" class="text-blue-500 text-sm flex items-center gap-1.5 mt-3 hover:underline">
                    <i data-lucide="external-link" class="w-4 h-4"></i>
                    {{ bank.website | truncate(30) }}
                </a>
                {% endif %}
                
                {% if bank.description %}
                <p class="text-sm text-muted mt-4">{{ bank.description | truncate(120) }}</p>
                {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="border-t border-border p-3">
                 <div class="flex gap-2 mt-auto">
                    <a href="{{ url_for('admin_banks.edit_bank', bank_id=bank._id) }}" class="btn btn-secondary btn-action">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                        <span>Modifier</span>
                    </a>
                    <button onclick="deleteBank('{{ bank._id }}', '{{ bank.name }}')" class="btn btn-danger-outline btn-icon" aria-label="Supprimer">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="flex items-center gap-3 mt-4">
                    <div class="flex-grow">
                        <select id="user-select-{{ bank._id }}" class="input" aria-label="Sélectionner un utilisateur">
                            <option value="">Assigner un utilisateur...</option>
                            {% for user in users %}
                                {% if user.role == 'bank_admin' %}
                                    <option value="{{ user._id }}">{{ user.email }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <button onclick="assignUserToBank('{{ bank._id }}')" class="btn btn-primary" aria-label="Assigner l'utilisateur">
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- No banks message -->
    {% if not banks %}
    <div class="card p-8 rounded-xl text-center col-span-full">
        <div class="w-16 h-16 bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">
            <i data-lucide="building-2" class="w-8 h-8 text-slate-500"></i>
        </div>
        <h2 class="text-xl font-semibold mb-2">Aucune banque partenaire</h2>
        <p class="text-muted mb-4">Commencez par ajouter votre première banque pour la gérer ici.</p>
        <a href="{{ url_for('admin_banks.create_bank') }}" class="btn btn-primary">
             <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Ajouter une banque</span>
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function filterBanks() {
    const search = document.getElementById('search-input').value.toLowerCase();
    const cards = document.querySelectorAll('.bank-card');
    
    cards.forEach(card => {
        const name = card.dataset.name || '';
        const code = card.dataset.code || '';
        if (name.includes(search) || code.includes(search)) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}

function assignUserToBank(bankId) {
    const userSelect = document.getElementById(`user-select-${bankId}`);
    const userId = userSelect.value;

    if (!userId) {
        alert("Veuillez sélectionner un utilisateur.");
        return;
    }

    if (!confirm('Êtes-vous sûr de vouloir assigner cet utilisateur à cette banque?')) {
        return;
    }

    fetch(`/admin/banks/${bankId}/assign-user`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            SarfXNotify.success(data.message || 'Utilisateur assigné avec succès!');
            setTimeout(() => location.reload(), 2000);
        } else {
            SarfXNotify.error('Erreur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        SarfXNotify.error('Une erreur est survenue lors de l’assignation.');
    });
}


function deleteBank(bankId, bankName) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer la banque "${bankName}"? Cette action est irréversible.`)) {
        fetch(`/admin/banks/${bankId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                SarfXNotify.success(data.message || 'Banque supprimée avec succès.');
                document.querySelector(`[data-code="${bankName.toLowerCase()}"]`).remove();
            } else {
                SarfXNotify.error('Erreur: ' + (data.message || 'Impossible de supprimer la banque.'));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            SarfXNotify.error('Une erreur est survenue lors de la suppression.');
        });
    }
}
</script>
{% endblock %}
