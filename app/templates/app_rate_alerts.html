{% extends "app_base.html" %}

{% block title %}Alertes de Taux - SarfX{% endblock %}

{% block content %}
<div class="rate-alerts-page">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1>üîî Alertes de Taux</h1>
            <p>Soyez notifi√© quand les taux atteignent vos objectifs</p>
        </div>
        <button class="btn-create" id="btn-create-alert">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Nouvelle alerte
        </button>
    </div>

    <!-- Auth Required Message -->
    <div class="auth-required" id="auth-required" style="display: none;">
        <div class="auth-icon">üîê</div>
        <h2>Connexion requise</h2>
        <p>Connectez-vous pour cr√©er et g√©rer vos alertes de taux</p>
        <a href="/auth/login?next=/app/rate-alerts" class="btn-login">Se connecter</a>
    </div>

    <!-- Main Content (hidden if not authenticated) -->
    <div id="main-content">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-box">
                <span class="stat-num" id="stat-active">0</span>
                <span class="stat-label">Actives</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="stat-triggered">0</span>
                <span class="stat-label">D√©clench√©es</span>
            </div>
            <div class="stat-box">
                <span class="stat-num" id="stat-paused">0</span>
                <span class="stat-label">En pause</span>
            </div>
        </div>

        <!-- Quick Create - Popular Pairs -->
        <div class="section">
            <h3>‚ö° Cr√©ation rapide</h3>
            <div class="pairs-grid" id="pairs-grid">
                <div class="pair-btn" data-from="EUR" data-to="MAD">EUR ‚Üí MAD</div>
                <div class="pair-btn" data-from="USD" data-to="MAD">USD ‚Üí MAD</div>
                <div class="pair-btn" data-from="GBP" data-to="MAD">GBP ‚Üí MAD</div>
                <div class="pair-btn" data-from="EUR" data-to="USD">EUR ‚Üí USD</div>
                <div class="pair-btn" data-from="CAD" data-to="MAD">CAD ‚Üí MAD</div>
                <div class="pair-btn" data-from="CHF" data-to="MAD">CHF ‚Üí MAD</div>
            </div>
        </div>

        <!-- Alerts List -->
        <div class="section">
            <h3>üìã Mes alertes</h3>
            <div class="alerts-list" id="alerts-list">
                <div class="loading">Chargement...</div>
            </div>
            <div class="no-alerts" id="no-alerts" style="display: none;">
                <p>Aucune alerte cr√©√©e</p>
                <button class="btn-small" id="btn-first-alert">Cr√©er ma premi√®re alerte</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Alert Modal -->
<div class="modal-overlay" id="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h2 id="modal-title">Nouvelle alerte</h2>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>

        <div class="modal-body">
            <!-- Currency Selection -->
            <div class="form-row">
                <div class="form-field">
                    <label>De</label>
                    <select id="from-currency">
                        <option value="EUR">üá™üá∫ EUR</option>
                        <option value="USD">üá∫üá∏ USD</option>
                        <option value="GBP">üá¨üáß GBP</option>
                        <option value="MAD">üá≤üá¶ MAD</option>
                        <option value="CAD">üá®üá¶ CAD</option>
                        <option value="CHF">üá®üá≠ CHF</option>
                        <option value="AED">üá¶üá™ AED</option>
                        <option value="SAR">üá∏üá¶ SAR</option>
                    </select>
                </div>
                <button type="button" class="swap-btn" id="swap-btn">‚áÑ</button>
                <div class="form-field">
                    <label>Vers</label>
                    <select id="to-currency">
                        <option value="MAD">üá≤üá¶ MAD</option>
                        <option value="EUR">üá™üá∫ EUR</option>
                        <option value="USD">üá∫üá∏ USD</option>
                        <option value="GBP">üá¨üáß GBP</option>
                        <option value="CAD">üá®üá¶ CAD</option>
                        <option value="CHF">üá®üá≠ CHF</option>
                    </select>
                </div>
            </div>

            <!-- Current Rate -->
            <div class="current-rate" id="current-rate-box">
                Taux actuel: <strong id="current-rate">--</strong>
            </div>

            <!-- Alert Type -->
            <div class="form-field">
                <label>Type d'alerte</label>
                <div class="type-buttons">
                    <label class="type-btn selected">
                        <input type="radio" name="alert_type" value="above" checked>
                        <span>üìà Au-dessus</span>
                    </label>
                    <label class="type-btn">
                        <input type="radio" name="alert_type" value="below">
                        <span>üìâ En-dessous</span>
                    </label>
                </div>
            </div>

            <!-- Target Rate -->
            <div class="form-field">
                <label>Taux cible</label>
                <input type="number" id="target-rate" step="0.0001" placeholder="Ex: 11.05" required>
                <div class="quick-btns">
                    <button type="button" class="quick-btn" data-pct="-2">-2%</button>
                    <button type="button" class="quick-btn" data-pct="-1">-1%</button>
                    <button type="button" class="quick-btn" data-pct="1">+1%</button>
                    <button type="button" class="quick-btn" data-pct="2">+2%</button>
                </div>
            </div>

            <!-- Notification Channels -->
            <div class="form-field">
                <label>Notifications</label>
                <div class="channels">
                    <label class="channel-check">
                        <input type="checkbox" id="notify-email" checked>
                        üìß Email
                    </label>
                    <label class="channel-check">
                        <input type="checkbox" id="notify-push" checked>
                        üîî Push
                    </label>
                </div>
            </div>

            <!-- Hidden field for edit -->
            <input type="hidden" id="alert-id" value="">
        </div>

        <div class="modal-footer">
            <button class="btn-cancel" id="btn-cancel">Annuler</button>
            <button class="btn-save" id="btn-save">Cr√©er l'alerte</button>
        </div>
    </div>
</div>

<style>
/* Base Styles */
.rate-alerts-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.page-header h1 {
    font-size: 24px;
    margin: 0;
}

.page-header p {
    color: #666;
    margin: 4px 0 0;
    font-size: 14px;
}

/* Buttons */
.btn-create {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
}

.btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
}

.btn-login {
    display: inline-block;
    padding: 12px 32px;
    background: #6366f1;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
}

.btn-small {
    padding: 8px 16px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* Auth Required */
.auth-required {
    text-align: center;
    padding: 60px 20px;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 16px;
    margin: 40px 0;
}

.auth-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.auth-required h2 {
    margin: 0 0 8px;
}

.auth-required p {
    color: #666;
    margin-bottom: 20px;
}

/* Stats */
.stats-row {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
}

.stat-box {
    flex: 1;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
}

.stat-num {
    display: block;
    font-size: 28px;
    font-weight: 700;
    color: #6366f1;
}

.stat-label {
    font-size: 13px;
    color: #666;
}

/* Sections */
.section {
    margin-bottom: 28px;
}

.section h3 {
    font-size: 16px;
    margin: 0 0 12px;
    color: var(--text-primary);
}

/* Pairs Grid */
.pairs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}

.pair-btn {
    padding: 12px;
    background: var(--bg-secondary, #f0f0f0);
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.pair-btn:hover {
    background: #6366f1;
    color: white;
    transform: scale(1.05);
}

/* Alerts List */
.alerts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #888;
}

.no-alerts {
    text-align: center;
    padding: 40px;
    background: var(--bg-secondary, #f8f9fa);
    border-radius: 12px;
}

.alert-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px;
    background: var(--bg-secondary, #fff);
    border: 1px solid var(--border-color, #e5e7eb);
    border-radius: 12px;
    transition: box-shadow 0.2s;
}

.alert-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.alert-info {
    flex: 1;
}

.alert-pair {
    font-size: 18px;
    font-weight: 700;
}

.alert-details {
    font-size: 13px;
    color: #666;
    margin-top: 4px;
}

.alert-status {
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-right: 12px;
}

.alert-status.active {
    background: #d1fae5;
    color: #059669;
}

.alert-status.triggered {
    background: #dbeafe;
    color: #2563eb;
}

.alert-status.paused {
    background: #fef3c7;
    color: #d97706;
}

.alert-actions {
    display: flex;
    gap: 8px;
}

.alert-actions button {
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
}

.btn-pause { background: #fef3c7; color: #d97706; }
.btn-resume { background: #d1fae5; color: #059669; }
.btn-delete { background: #fee2e2; color: #dc2626; }

/* Modal */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-overlay.show {
    display: flex;
}

.modal-box {
    background: var(--bg-primary, white);
    border-radius: 16px;
    width: 100%;
    max-width: 450px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid var(--border-color, #e5e7eb);
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
}

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #666;
    line-height: 1;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    display: flex;
    gap: 12px;
    padding: 16px 20px;
    border-top: 1px solid var(--border-color, #e5e7eb);
}

/* Form */
.form-row {
    display: flex;
    align-items: flex-end;
    gap: 12px;
    margin-bottom: 16px;
}

.form-field {
    flex: 1;
    margin-bottom: 16px;
}

.form-field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 6px;
    color: var(--text-secondary, #666);
}

.form-field input,
.form-field select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border-color, #ddd);
    border-radius: 8px;
    font-size: 15px;
    background: var(--bg-primary, white);
    color: var(--text-primary);
}

.form-field input:focus,
.form-field select:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
}

.swap-btn {
    padding: 12px 16px;
    background: var(--bg-secondary, #f0f0f0);
    border: none;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
    margin-bottom: 16px;
}

.current-rate {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    text-align: center;
    margin-bottom: 16px;
    font-size: 15px;
}

.current-rate strong {
    font-size: 20px;
}

/* Type Buttons */
.type-buttons {
    display: flex;
    gap: 10px;
}

.type-btn {
    flex: 1;
    padding: 12px;
    border: 2px solid var(--border-color, #ddd);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.type-btn input {
    display: none;
}

.type-btn.selected {
    border-color: #6366f1;
    background: rgba(99,102,241,0.1);
}

.type-btn span {
    font-weight: 600;
}

/* Quick Buttons */
.quick-btns {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.quick-btn {
    flex: 1;
    padding: 8px;
    background: var(--bg-secondary, #f0f0f0);
    border: none;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
}

.quick-btn:hover {
    background: #6366f1;
    color: white;
}

/* Channels */
.channels {
    display: flex;
    gap: 16px;
}

.channel-check {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
}

.channel-check input {
    width: auto;
}

/* Footer Buttons */
.btn-cancel {
    flex: 1;
    padding: 12px;
    background: var(--bg-secondary, #f0f0f0);
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
}

.btn-save {
    flex: 2;
    padding: 12px;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
}

.btn-save:hover {
    opacity: 0.9;
}

.btn-save:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 600px) {
    .page-header {
        flex-direction: column;
        align-items: stretch;
    }

    .stats-row {
        flex-direction: column;
    }

    .form-row {
        flex-direction: column;
    }

    .swap-btn {
        align-self: center;
        margin: 0 0 16px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .pair-btn {
        background: #374151;
    }

    .alert-item {
        background: #1f2937;
        border-color: #374151;
    }
}
</style>

<script>
// ==================== STATE ====================
let currentRate = 0;
let alerts = [];
let isAuthenticated = false;
let editingAlertId = null;

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Rate Alerts page loaded');
    init();
});

async function init() {
    // Check auth
    isAuthenticated = await checkAuth();
    console.log('Authenticated:', isAuthenticated);

    if (isAuthenticated) {
        document.getElementById('auth-required').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        loadAlerts();
        loadStats();
    } else {
        document.getElementById('auth-required').style.display = 'block';
        document.getElementById('main-content').style.display = 'none';
    }

    // Setup event listeners
    setupEventListeners();
}

async function checkAuth() {
    try {
        const resp = await fetch('/api/rate-alerts', { credentials: 'same-origin' });
        return resp.status !== 401;
    } catch (e) {
        return false;
    }
}

// ==================== EVENT LISTENERS ====================
function setupEventListeners() {
    // Create alert button
    document.getElementById('btn-create-alert').addEventListener('click', () => openModal());
    document.getElementById('btn-first-alert')?.addEventListener('click', () => openModal());

    // Modal controls
    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('btn-cancel').addEventListener('click', closeModal);
    document.getElementById('btn-save').addEventListener('click', saveAlert);
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'modal-overlay') closeModal();
    });

    // Swap currencies
    document.getElementById('swap-btn').addEventListener('click', swapCurrencies);

    // Currency change - update rate
    document.getElementById('from-currency').addEventListener('change', updateRate);
    document.getElementById('to-currency').addEventListener('change', updateRate);

    // Alert type selection
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });

    // Quick percentage buttons
    document.querySelectorAll('.quick-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const pct = parseFloat(this.dataset.pct);
            if (currentRate > 0) {
                const target = currentRate * (1 + pct / 100);
                document.getElementById('target-rate').value = target.toFixed(4);
            }
        });
    });

    // Quick pair buttons
    document.querySelectorAll('.pair-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!isAuthenticated) {
                showToast('Veuillez vous connecter', 'warning');
                window.location.href = '/auth/login?next=/app/rate-alerts';
                return;
            }
            const from = this.dataset.from;
            const to = this.dataset.to;
            openModal(from, to);
        });
    });
}

// ==================== MODAL ====================
function openModal(fromCurrency = 'EUR', toCurrency = 'MAD') {
    if (!isAuthenticated) {
        showToast('Veuillez vous connecter pour cr√©er une alerte', 'warning');
        setTimeout(() => {
            window.location.href = '/auth/login?next=/app/rate-alerts';
        }, 1000);
        return;
    }

    // Reset form
    editingAlertId = null;
    document.getElementById('alert-id').value = '';
    document.getElementById('modal-title').textContent = 'Nouvelle alerte';
    document.getElementById('btn-save').textContent = 'Cr√©er l\'alerte';
    document.getElementById('target-rate').value = '';
    document.getElementById('notify-email').checked = true;
    document.getElementById('notify-push').checked = true;

    // Set currencies
    document.getElementById('from-currency').value = fromCurrency;
    document.getElementById('to-currency').value = toCurrency;

    // Reset type selection
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
    document.querySelector('.type-btn').classList.add('selected');
    document.querySelector('input[name="alert_type"][value="above"]').checked = true;

    // Show modal
    document.getElementById('modal-overlay').classList.add('show');

    // Load current rate
    updateRate();
}

function closeModal() {
    document.getElementById('modal-overlay').classList.remove('show');
    editingAlertId = null;
}

function swapCurrencies() {
    const from = document.getElementById('from-currency');
    const to = document.getElementById('to-currency');
    const temp = from.value;
    from.value = to.value;
    to.value = temp;
    updateRate();
}

async function updateRate() {
    const from = document.getElementById('from-currency').value;
    const to = document.getElementById('to-currency').value;
    const rateEl = document.getElementById('current-rate');

    rateEl.textContent = '...';

    try {
        const resp = await fetch(`/api/rates/live?from=${from}&to=${to}`);
        const data = await resp.json();

        if (data.success && data.rate) {
            currentRate = data.rate;
            rateEl.textContent = currentRate.toFixed(4);
        } else {
            // Default rates
            const defaults = {
                'EURMAD': 10.82, 'USDMAD': 9.06, 'GBPMAD': 12.50,
                'EURUSD': 1.08, 'CADMAD': 6.71, 'CHFMAD': 11.80
            };
            currentRate = defaults[from + to] || 1;
            rateEl.textContent = currentRate.toFixed(4);
        }
    } catch (e) {
        currentRate = 10.82;
        rateEl.textContent = currentRate.toFixed(4);
    }
}

// ==================== SAVE ALERT ====================
async function saveAlert() {
    const from = document.getElementById('from-currency').value;
    const to = document.getElementById('to-currency').value;
    const targetRate = document.getElementById('target-rate').value;
    const alertType = document.querySelector('input[name="alert_type"]:checked')?.value;

    // Validation
    if (!targetRate || isNaN(parseFloat(targetRate))) {
        showToast('Veuillez entrer un taux cible valide', 'error');
        return;
    }

    const channels = [];
    if (document.getElementById('notify-email').checked) channels.push('email');
    if (document.getElementById('notify-push').checked) channels.push('push');

    if (channels.length === 0) {
        showToast('S√©lectionnez au moins un canal de notification', 'error');
        return;
    }

    const payload = {
        from_currency: from,
        to_currency: to,
        alert_type: alertType || 'above',
        target_rate: parseFloat(targetRate),
        notification_channels: channels
    };

    console.log('Saving alert:', payload);

    const btn = document.getElementById('btn-save');
    btn.disabled = true;
    btn.textContent = 'Cr√©ation...';

    try {
        const alertId = document.getElementById('alert-id').value;
        const url = alertId ? `/api/rate-alerts/${alertId}` : '/api/rate-alerts';
        const method = alertId ? 'PUT' : 'POST';

        const resp = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
        });

        console.log('Response status:', resp.status);

        if (resp.status === 401) {
            showToast('Session expir√©e. Reconnectez-vous.', 'error');
            setTimeout(() => {
                window.location.href = '/auth/login?next=/app/rate-alerts';
            }, 1500);
            return;
        }

        const data = await resp.json();
        console.log('Response:', data);

        if (data.success) {
            showToast(alertId ? 'Alerte modifi√©e!' : 'Alerte cr√©√©e!', 'success');
            closeModal();
            loadAlerts();
            loadStats();
        } else {
            showToast(data.error || 'Erreur lors de la cr√©ation', 'error');
        }
    } catch (e) {
        console.error('Error:', e);
        showToast('Erreur de connexion', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = editingAlertId ? 'Modifier' : 'Cr√©er l\'alerte';
    }
}

// ==================== LOAD DATA ====================
async function loadAlerts() {
    const listEl = document.getElementById('alerts-list');
    const noAlertsEl = document.getElementById('no-alerts');

    listEl.innerHTML = '<div class="loading">Chargement...</div>';

    try {
        const resp = await fetch('/api/rate-alerts', { credentials: 'same-origin' });

        if (resp.status === 401) {
            isAuthenticated = false;
            document.getElementById('auth-required').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            return;
        }

        const data = await resp.json();
        console.log('Alerts loaded:', data);

        alerts = data.alerts || [];

        if (alerts.length === 0) {
            listEl.innerHTML = '';
            noAlertsEl.style.display = 'block';
        } else {
            noAlertsEl.style.display = 'none';
            renderAlerts();
        }
    } catch (e) {
        console.error('Error loading alerts:', e);
        listEl.innerHTML = '<div class="loading">Erreur de chargement</div>';
    }
}

function renderAlerts() {
    const listEl = document.getElementById('alerts-list');

    listEl.innerHTML = alerts.map(alert => `
        <div class="alert-item" data-id="${alert.alert_id}">
            <div class="alert-info">
                <div class="alert-pair">${alert.from_currency} ‚Üí ${alert.to_currency}</div>
                <div class="alert-details">
                    ${alert.alert_type === 'above' ? 'üìà Au-dessus de' : 'üìâ En-dessous de'}
                    <strong>${alert.target_rate?.toFixed(4) || '--'}</strong>
                    ${alert.current_rate ? `(actuel: ${alert.current_rate.toFixed(4)})` : ''}
                </div>
            </div>
            <span class="alert-status ${alert.status}">${getStatusLabel(alert.status)}</span>
            <div class="alert-actions">
                ${alert.status === 'active' ?
                    `<button class="btn-pause" onclick="pauseAlert('${alert.alert_id}')">‚è∏Ô∏è</button>` :
                    alert.status === 'paused' ?
                    `<button class="btn-resume" onclick="resumeAlert('${alert.alert_id}')">‚ñ∂Ô∏è</button>` : ''
                }
                <button class="btn-delete" onclick="deleteAlert('${alert.alert_id}')">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

function getStatusLabel(status) {
    const labels = {
        'active': 'Active',
        'triggered': 'D√©clench√©e',
        'paused': 'En pause',
        'expired': 'Expir√©e'
    };
    return labels[status] || status;
}

async function loadStats() {
    try {
        const resp = await fetch('/api/rate-alerts/statistics', { credentials: 'same-origin' });
        if (resp.ok) {
            const data = await resp.json();
            if (data.success && data.statistics) {
                document.getElementById('stat-active').textContent = data.statistics.active || 0;
                document.getElementById('stat-triggered').textContent = data.statistics.triggered || 0;
                document.getElementById('stat-paused').textContent = data.statistics.paused || 0;
            }
        }
    } catch (e) {
        console.log('Stats load error:', e);
    }
}

// ==================== ALERT ACTIONS ====================
async function pauseAlert(alertId) {
    try {
        const resp = await fetch(`/api/rate-alerts/${alertId}/pause`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (data.success) {
            showToast('Alerte mise en pause', 'success');
            loadAlerts();
            loadStats();
        } else {
            showToast(data.error || 'Erreur', 'error');
        }
    } catch (e) {
        showToast('Erreur', 'error');
    }
}

async function resumeAlert(alertId) {
    try {
        const resp = await fetch(`/api/rate-alerts/${alertId}/resume`, {
            method: 'POST',
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (data.success) {
            showToast('Alerte r√©activ√©e', 'success');
            loadAlerts();
            loadStats();
        } else {
            showToast(data.error || 'Erreur', 'error');
        }
    } catch (e) {
        showToast('Erreur', 'error');
    }
}

async function deleteAlert(alertId) {
    if (!confirm('Supprimer cette alerte?')) return;

    try {
        const resp = await fetch(`/api/rate-alerts/${alertId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        });
        const data = await resp.json();
        if (data.success) {
            showToast('Alerte supprim√©e', 'success');
            loadAlerts();
            loadStats();
        } else {
            showToast(data.error || 'Erreur', 'error');
        }
    } catch (e) {
        showToast('Erreur', 'error');
    }
}

// ==================== TOAST ====================
function showToast(message, type = 'info') {
    // Use existing showNotification if available
    if (typeof showNotification === 'function') {
        showNotification(message, type);
        return;
    }

    // Fallback toast
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#6366f1'};
        color: white;
        border-radius: 8px;
        font-weight: 500;
        z-index: 9999;
        animation: slideUp 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Add animation keyframes
const style = document.createElement('style');
style.textContent = `
    @keyframes slideUp {
        from { transform: translateX(-50%) translateY(20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes fadeOut {
        to { opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
