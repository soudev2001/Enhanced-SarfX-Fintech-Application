{% extends "app_base.html" %}

{% block title %}Swap de Devises - SarfX{% endblock %}

{% block extra_head %}
<style>
    .swap-container {
        max-width: 480px;
        margin: 0 auto;
    }
    
    .swap-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
    }
    
    .swap-header {
        background: linear-gradient(135deg, rgba(224, 90, 3, 0.15), rgba(255, 140, 66, 0.1));
        padding: 24px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
    }
    
    .swap-header h1 {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-default);
        margin: 0 0 8px 0;
    }
    
    .swap-header p {
        color: var(--text-muted);
        font-size: 14px;
        margin: 0;
    }
    
    .swap-body {
        padding: 24px;
    }
    
    .swap-input-group {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 12px;
        transition: all 0.2s ease;
    }
    
    .swap-input-group:focus-within {
        border-color: var(--brand-orange);
        box-shadow: 0 0 0 3px rgba(224, 90, 3, 0.1);
    }
    
    .swap-input-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .swap-input-label span {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .balance-badge {
        font-size: 12px;
        color: var(--brand-orange);
        background: rgba(224, 90, 3, 0.1);
        padding: 4px 10px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .balance-badge:hover {
        background: rgba(224, 90, 3, 0.2);
    }
    
    .swap-input-row {
        display: flex;
        gap: 12px;
        align-items: center;
    }
    
    .swap-amount-input {
        flex: 1;
        background: transparent;
        border: none;
        font-size: 28px;
        font-weight: 700;
        color: var(--text-default);
        outline: none;
        width: 100%;
    }
    
    .swap-amount-input::placeholder {
        color: var(--text-muted);
        opacity: 0.5;
    }
    
    .currency-select {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        cursor: pointer;
        min-width: 110px;
        transition: all 0.2s ease;
    }
    
    .currency-select:hover {
        border-color: var(--brand-orange);
    }
    
    .currency-select select {
        background: transparent;
        border: none;
        font-size: 16px;
        font-weight: 600;
        color: var(--text-default);
        cursor: pointer;
        outline: none;
        appearance: none;
        -webkit-appearance: none;
    }
    
    .currency-flag {
        font-size: 24px;
    }
    
    .swap-arrow-container {
        display: flex;
        justify-content: center;
        margin: -8px 0;
        position: relative;
        z-index: 10;
    }
    
    .swap-arrow-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--brand-orange);
        border: 4px solid var(--card-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(224, 90, 3, 0.3);
    }
    
    .swap-arrow-btn:hover {
        transform: rotate(180deg);
        background: #d45403;
    }
    
    .swap-arrow-btn i {
        color: white;
        width: 24px;
        height: 24px;
    }
    
    .swap-preview {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 16px;
        margin-top: 20px;
    }
    
    .swap-preview-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .swap-preview-row:last-child {
        border-bottom: none;
        padding-top: 12px;
        margin-top: 4px;
    }
    
    .swap-preview-label {
        font-size: 13px;
        color: var(--text-muted);
    }
    
    .swap-preview-value {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-default);
    }
    
    .swap-preview-value.highlight {
        color: var(--brand-orange);
        font-size: 18px;
    }
    
    .swap-btn {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #e05a03, #ff8c42);
        border: none;
        border-radius: 14px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 20px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .swap-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(224, 90, 3, 0.4);
    }
    
    .swap-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .rates-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 24px;
    }
    
    .rate-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 14px;
        text-align: center;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .rate-card:hover {
        border-color: var(--brand-orange);
        transform: translateY(-2px);
    }
    
    .rate-pair {
        font-size: 13px;
        color: var(--text-muted);
        margin-bottom: 4px;
    }
    
    .rate-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-default);
    }
    
    @media (max-width: 480px) {
        .swap-amount-input {
            font-size: 24px;
        }
        
        .rates-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-24">
    
    <!-- Back Button -->
    <a href="{{ url_for('app.wallets') }}" class="inline-flex items-center gap-2 text-muted hover:text-default transition">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        <span class="text-sm">Retour aux portefeuilles</span>
    </a>
    
    <div class="swap-container">
        <div class="swap-card">
            <div class="swap-header">
                <h1>
                    <i data-lucide="repeat" class="w-6 h-6 inline-block mr-2 text-amber-500"></i>
                    Swap de Devises
                </h1>
                <p>Ã‰changez instantanÃ©ment entre vos devises</p>
            </div>
            
            <form method="POST" action="{{ url_for('app.wallet_swap') }}" id="swapForm" class="swap-body">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- From Currency -->
                <div class="swap-input-group" id="fromGroup">
                    <div class="swap-input-label">
                        <span>Vous envoyez</span>
                        <span class="balance-badge" onclick="setMaxAmount()" id="fromBalance">
                            Solde: <span id="fromBalanceValue">0.00</span>
                        </span>
                    </div>
                    <div class="swap-input-row">
                        <input type="number" 
                               name="amount" 
                               id="swapAmount" 
                               class="swap-amount-input" 
                               placeholder="0.00"
                               step="0.01"
                               min="0.01"
                               required
                               oninput="updatePreview()">
                        <div class="currency-select">
                            <span class="currency-flag" id="fromFlag">ðŸ‡ªðŸ‡º</span>
                            <select name="from_currency" id="fromCurrency" onchange="updateFromCurrency()">
                                {% for currency, balance in wallet.balances.items() %}
                                <option value="{{ currency }}" data-balance="{{ balance }}">{{ currency }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Swap Arrow -->
                <div class="swap-arrow-container">
                    <button type="button" class="swap-arrow-btn" onclick="swapCurrencies()">
                        <i data-lucide="arrow-down-up"></i>
                    </button>
                </div>
                
                <!-- To Currency -->
                <div class="swap-input-group" id="toGroup">
                    <div class="swap-input-label">
                        <span>Vous recevez</span>
                        <span class="balance-badge" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                            Solde: <span id="toBalanceValue">0.00</span>
                        </span>
                    </div>
                    <div class="swap-input-row">
                        <input type="text" 
                               id="receiveAmount" 
                               class="swap-amount-input" 
                               placeholder="0.00"
                               readonly
                               style="color: #22c55e;">
                        <div class="currency-select">
                            <span class="currency-flag" id="toFlag">ðŸ‡²ðŸ‡¦</span>
                            <select name="to_currency" id="toCurrency" onchange="updateToCurrency()">
                                {% for currency, balance in wallet.balances.items() %}
                                <option value="{{ currency }}" data-balance="{{ balance }}" {% if currency == 'MAD' %}selected{% endif %}>{{ currency }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Preview -->
                <div class="swap-preview" id="swapPreview" style="display: none;">
                    <div class="swap-preview-row">
                        <span class="swap-preview-label">Taux de change</span>
                        <span class="swap-preview-value" id="previewRate">-</span>
                    </div>
                    <div class="swap-preview-row">
                        <span class="swap-preview-label">Frais SarfX (0.5%)</span>
                        <span class="swap-preview-value" id="previewFee">-</span>
                    </div>
                    <div class="swap-preview-row">
                        <span class="swap-preview-label">Vous recevrez</span>
                        <span class="swap-preview-value highlight" id="previewTotal">-</span>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" class="swap-btn" id="swapBtn" disabled>
                    <i data-lucide="repeat" class="w-5 h-5"></i>
                    <span>Confirmer le Swap</span>
                </button>
                
            </form>
        </div>
        
        <!-- Live Rates -->
        {% if swap_rates %}
        <div class="mt-6">
            <h3 class="text-lg font-bold text-default mb-3 flex items-center gap-2">
                <i data-lucide="trending-up" class="w-5 h-5 text-amber-500"></i>
                Taux disponibles
            </h3>
            <div class="rates-grid">
                {% for rate in swap_rates[:8] %}
                <div class="rate-card" onclick="selectRate('{{ rate.from }}', '{{ rate.to }}', {{ rate.rate }})">
                    <div class="rate-pair">{{ rate.from }} â†’ {{ rate.to }}</div>
                    <div class="rate-value">{{ "%.4f"|format(rate.rate) }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
    updateFromCurrency();
    updateToCurrency();
});

const flags = {
    'USD': 'ðŸ‡ºðŸ‡¸', 'EUR': 'ðŸ‡ªðŸ‡º', 'GBP': 'ðŸ‡¬ðŸ‡§', 'MAD': 'ðŸ‡²ðŸ‡¦',
    'CHF': 'ðŸ‡¨ðŸ‡­', 'CAD': 'ðŸ‡¨ðŸ‡¦', 'AED': 'ðŸ‡¦ðŸ‡ª', 'SAR': 'ðŸ‡¸ðŸ‡¦'
};

const walletBalances = {
    {% for currency, balance in wallet.balances.items() %}
    '{{ currency }}': {{ balance }},
    {% endfor %}
};

let currentRate = null;
let previewTimeout = null;

function updateFromCurrency() {
    const select = document.getElementById('fromCurrency');
    const currency = select.value;
    const balance = walletBalances[currency] || 0;
    
    document.getElementById('fromFlag').textContent = flags[currency] || 'ðŸ’µ';
    document.getElementById('fromBalanceValue').textContent = balance.toFixed(2);
    
    updatePreview();
}

function updateToCurrency() {
    const select = document.getElementById('toCurrency');
    const currency = select.value;
    const balance = walletBalances[currency] || 0;
    
    document.getElementById('toFlag').textContent = flags[currency] || 'ðŸ’µ';
    document.getElementById('toBalanceValue').textContent = balance.toFixed(2);
    
    updatePreview();
}

function swapCurrencies() {
    const fromSelect = document.getElementById('fromCurrency');
    const toSelect = document.getElementById('toCurrency');
    
    const fromValue = fromSelect.value;
    const toValue = toSelect.value;
    
    fromSelect.value = toValue;
    toSelect.value = fromValue;
    
    updateFromCurrency();
    updateToCurrency();
}

function setMaxAmount() {
    const fromCurrency = document.getElementById('fromCurrency').value;
    const balance = walletBalances[fromCurrency] || 0;
    document.getElementById('swapAmount').value = balance.toFixed(2);
    updatePreview();
}

async function updatePreview() {
    clearTimeout(previewTimeout);
    
    const amount = parseFloat(document.getElementById('swapAmount').value) || 0;
    const fromCurrency = document.getElementById('fromCurrency').value;
    const toCurrency = document.getElementById('toCurrency').value;
    const previewDiv = document.getElementById('swapPreview');
    const swapBtn = document.getElementById('swapBtn');
    const receiveInput = document.getElementById('receiveAmount');
    
    // Validate
    if (fromCurrency === toCurrency) {
        previewDiv.style.display = 'none';
        swapBtn.disabled = true;
        receiveInput.value = '';
        return;
    }
    
    if (amount <= 0) {
        previewDiv.style.display = 'none';
        swapBtn.disabled = true;
        receiveInput.value = '';
        return;
    }
    
    const balance = walletBalances[fromCurrency] || 0;
    if (amount > balance) {
        previewDiv.style.display = 'none';
        swapBtn.disabled = true;
        receiveInput.value = 'Solde insuffisant';
        receiveInput.style.color = '#ef4444';
        return;
    }
    
    receiveInput.style.color = '#22c55e';
    
    // Debounce API call
    previewTimeout = setTimeout(async () => {
        try {
            const response = await fetch('/api/wallet/swap/preview', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    from_currency: fromCurrency,
                    to_currency: toCurrency,
                    amount: amount
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentRate = data.rate;
                
                document.getElementById('previewRate').textContent = 
                    `1 ${fromCurrency} = ${data.rate.toFixed(4)} ${toCurrency}`;
                document.getElementById('previewFee').textContent = 
                    `${data.fee_amount.toFixed(2)} ${fromCurrency}`;
                document.getElementById('previewTotal').textContent = 
                    `${data.received_amount.toFixed(2)} ${toCurrency}`;
                
                receiveInput.value = data.received_amount.toFixed(2);
                
                previewDiv.style.display = 'block';
                swapBtn.disabled = false;
            } else {
                previewDiv.style.display = 'none';
                swapBtn.disabled = true;
                receiveInput.value = data.error || 'Erreur';
            }
        } catch (error) {
            console.error('Preview error:', error);
            previewDiv.style.display = 'none';
            swapBtn.disabled = true;
        }
    }, 300);
}

function selectRate(from, to, rate) {
    document.getElementById('fromCurrency').value = from;
    document.getElementById('toCurrency').value = to;
    updateFromCurrency();
    updateToCurrency();
    
    // Focus amount input
    document.getElementById('swapAmount').focus();
}

// Form submission
document.getElementById('swapForm').addEventListener('submit', function(e) {
    const swapBtn = document.getElementById('swapBtn');
    swapBtn.disabled = true;
    swapBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> <span>Traitement...</span>';
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
