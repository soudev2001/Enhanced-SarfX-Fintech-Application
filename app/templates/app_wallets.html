{% extends "app_base.html" %}

{% block title %}Mes Portefeuilles - SarfX{% endblock %}

{% block extra_head %}
<style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       WALLET PAGE 2026 - Premium Design System
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* --- CSS Variables --- */
    :root {
        --wallet-gradient-start: #e05a03;
        --wallet-gradient-end: #ff8c42;
        --wallet-card-bg: #ffffff;
        --wallet-card-border: rgba(0, 0, 0, 0.08);
        --wallet-card-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
        --wallet-card-hover-shadow: 0 12px 40px rgba(224, 90, 3, 0.18);
        --wallet-glass-bg: rgba(255, 255, 255, 0.85);
        --wallet-text-primary: #1a1a2e;
        --wallet-text-secondary: #64748b;
        --wallet-success: #22c55e;
        --wallet-danger: #ef4444;
    }

    [data-theme="dark"] {
        --wallet-card-bg: #1e293b;
        --wallet-card-border: rgba(255, 255, 255, 0.08);
        --wallet-card-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        --wallet-card-hover-shadow: 0 12px 40px rgba(224, 90, 3, 0.25);
        --wallet-glass-bg: rgba(30, 41, 59, 0.9);
        --wallet-text-primary: #f1f5f9;
        --wallet-text-secondary: #94a3b8;
    }

    /* --- Animations --- */
    @keyframes wallet-pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.02); opacity: 0.95; }
    }

    @keyframes wallet-glow {
        0%, 100% { box-shadow: 0 0 20px rgba(224, 90, 3, 0.3); }
        50% { box-shadow: 0 0 40px rgba(224, 90, 3, 0.5); }
    }

    @keyframes wallet-float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-6px); }
    }

    @keyframes shimmer {
        0% { background-position: -200% center; }
        100% { background-position: 200% center; }
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    /* --- Page Header --- */
    .wallet-page-header {
        background: linear-gradient(135deg, var(--wallet-gradient-start), var(--wallet-gradient-end));
        border-radius: 24px;
        padding: 28px 32px;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }

    .wallet-page-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 60%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        pointer-events: none;
    }

    .wallet-page-header h1 {
        color: #fff;
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .wallet-page-header p {
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.9rem;
    }

    .wallet-header-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .wallet-header-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.875rem;
        text-decoration: none;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
    }

    .wallet-header-btn-recharge {
        background: rgba(255, 255, 255, 0.95);
        color: var(--wallet-gradient-start);
    }

    .wallet-header-btn-recharge:hover {
        background: #fff;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .wallet-header-btn-swap {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        backdrop-filter: blur(10px);
    }

    .wallet-header-btn-swap:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .wallet-header-btn-add {
        background: rgba(0, 0, 0, 0.2);
        color: #fff;
        backdrop-filter: blur(10px);
    }

    .wallet-header-btn-add:hover {
        background: rgba(0, 0, 0, 0.3);
        transform: translateY(-2px);
    }

    /* --- Total Balance Card --- */
    .total-balance-card-2026 {
        background: linear-gradient(145deg, var(--wallet-card-bg), var(--wallet-glass-bg));
        border: 1px solid var(--wallet-card-border);
        border-radius: 24px;
        padding: 28px 32px;
        box-shadow: var(--wallet-card-shadow);
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.5s ease-out;
    }

    .total-balance-card-2026::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(224, 90, 3, 0.08) 0%, transparent 70%);
        pointer-events: none;
    }

    .balance-icon-container {
        width: 72px;
        height: 72px;
        background: linear-gradient(135deg, var(--wallet-gradient-start), var(--wallet-gradient-end));
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(224, 90, 3, 0.3);
        animation: wallet-glow 3s ease-in-out infinite;
    }

    .balance-icon-container i {
        width: 36px;
        height: 36px;
        color: #fff;
    }

    .balance-amount {
        font-size: 2.75rem;
        font-weight: 800;
        color: var(--wallet-text-primary);
        line-height: 1.1;
        background: linear-gradient(135deg, var(--wallet-gradient-start), var(--wallet-gradient-end));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .balance-label {
        font-size: 0.85rem;
        color: var(--wallet-text-secondary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* --- Wallet Cards Grid --- */
    .wallet-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }

    .wallet-card-2026 {
        background: var(--wallet-card-bg);
        border: 1px solid var(--wallet-card-border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--wallet-card-shadow);
        cursor: pointer;
        transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        animation: fadeInUp 0.5s ease-out backwards;
    }

    .wallet-card-2026:nth-child(1) { animation-delay: 0.1s; }
    .wallet-card-2026:nth-child(2) { animation-delay: 0.15s; }
    .wallet-card-2026:nth-child(3) { animation-delay: 0.2s; }
    .wallet-card-2026:nth-child(4) { animation-delay: 0.25s; }
    .wallet-card-2026:nth-child(5) { animation-delay: 0.3s; }
    .wallet-card-2026:nth-child(6) { animation-delay: 0.35s; }

    .wallet-card-2026::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--wallet-gradient-start), var(--wallet-gradient-end));
        transform: scaleX(0);
        transition: transform 0.35s ease;
        transform-origin: left;
    }

    .wallet-card-2026:hover {
        transform: translateY(-8px);
        box-shadow: var(--wallet-card-hover-shadow);
        border-color: rgba(224, 90, 3, 0.3);
    }

    .wallet-card-2026:hover::before {
        transform: scaleX(1);
    }

    .wallet-flag-2026 {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 38px;
        background: linear-gradient(145deg, rgba(224, 90, 3, 0.08), rgba(255, 140, 66, 0.05));
        border-radius: 16px;
        border: 1px solid rgba(224, 90, 3, 0.1);
        transition: all 0.3s ease;
    }

    .wallet-card-2026:hover .wallet-flag-2026 {
        transform: scale(1.08);
        background: linear-gradient(145deg, rgba(224, 90, 3, 0.15), rgba(255, 140, 66, 0.1));
    }

    .wallet-currency-code {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--wallet-text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .wallet-primary-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #fff;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 3px 8px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .wallet-balance-value {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--wallet-text-primary);
        line-height: 1.2;
    }

    .wallet-usd-equivalent {
        font-size: 0.85rem;
        color: var(--wallet-text-secondary);
        margin-top: 2px;
    }

    .wallet-arrow-icon {
        width: 32px;
        height: 32px;
        background: rgba(224, 90, 3, 0.08);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .wallet-card-2026:hover .wallet-arrow-icon {
        background: var(--wallet-gradient-start);
    }

    .wallet-card-2026:hover .wallet-arrow-icon i {
        color: #fff !important;
        transform: translateX(2px);
    }

    /* --- Empty State --- */
    .wallet-empty-state-2026 {
        grid-column: 1 / -1;
        background: var(--wallet-card-bg);
        border: 2px dashed var(--wallet-card-border);
        border-radius: 24px;
        padding: 60px 40px;
        text-align: center;
        animation: fadeInUp 0.5s ease-out;
    }

    .wallet-empty-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, rgba(224, 90, 3, 0.1), rgba(255, 140, 66, 0.05));
        border-radius: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }

    .wallet-empty-icon i {
        width: 40px;
        height: 40px;
        color: var(--wallet-gradient-start);
    }

    /* --- Recent Transactions --- */
    .transactions-section {
        margin-top: 32px;
        animation: fadeInUp 0.5s ease-out 0.3s backwards;
    }

    .transactions-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .transactions-header h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--wallet-text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .transaction-item-2026 {
        background: var(--wallet-card-bg);
        border: 1px solid var(--wallet-card-border);
        border-radius: 16px;
        padding: 16px 20px;
        margin-bottom: 12px;
        transition: all 0.25s ease;
    }

    .transaction-item-2026:hover {
        border-color: rgba(224, 90, 3, 0.2);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        transform: translateX(4px);
    }

    .transaction-icon-2026 {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .transaction-icon-credit {
        background: rgba(34, 197, 94, 0.12);
        color: var(--wallet-success);
    }

    .transaction-icon-debit {
        background: rgba(239, 68, 68, 0.12);
        color: var(--wallet-danger);
    }

    .transaction-amount-credit {
        color: var(--wallet-success);
        font-weight: 700;
        font-size: 1.1rem;
    }

    .transaction-amount-debit {
        color: var(--wallet-danger);
        font-weight: 700;
        font-size: 1.1rem;
    }

    /* --- Modal Styles --- */
    .wise-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(8px);
        background: rgba(0, 0, 0, 0.6);
    }

    .wise-modal.active {
        display: flex !important;
    }

    .wise-modal-content {
        max-width: 500px;
        width: 92%;
        background: var(--wallet-card-bg);
        border-radius: 24px;
        box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
        animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    .wise-modal-header {
        background: linear-gradient(135deg, rgba(224, 90, 3, 0.08), rgba(255, 140, 66, 0.04));
        padding: 24px;
        border-bottom: 1px solid var(--wallet-card-border);
    }

    .modal-flag-large {
        font-size: 56px;
        line-height: 1;
    }

    .modal-action-btn {
        width: 100%;
        padding: 14px 20px;
        border-radius: 14px;
        font-weight: 600;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.25s ease;
        border: none;
        cursor: pointer;
    }

    .modal-action-btn-primary {
        background: rgba(224, 90, 3, 0.1);
        color: var(--wallet-gradient-start);
    }

    .modal-action-btn-primary:hover {
        background: var(--wallet-gradient-start);
        color: #fff;
        transform: translateY(-2px);
    }

    .modal-action-btn-danger {
        background: rgba(239, 68, 68, 0.1);
        color: var(--wallet-danger);
    }

    .modal-action-btn-danger:hover {
        background: var(--wallet-danger);
        color: #fff;
        transform: translateY(-2px);
    }

    /* --- Currency Selection Grid --- */
    .currency-select-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
    }

    .currency-select-item {
        cursor: pointer;
    }

    .currency-select-item input {
        display: none;
    }

    .currency-select-card {
        padding: 16px 12px;
        border-radius: 16px;
        text-align: center;
        border: 2px solid transparent;
        background: rgba(224, 90, 3, 0.03);
        transition: all 0.25s ease;
    }

    .currency-select-item input:checked + .currency-select-card {
        border-color: var(--wallet-gradient-start);
        background: rgba(224, 90, 3, 0.1);
        transform: scale(1.02);
    }

    .currency-select-card:hover {
        border-color: rgba(224, 90, 3, 0.3);
        background: rgba(224, 90, 3, 0.06);
    }

    .currency-select-flag {
        font-size: 2rem;
        margin-bottom: 6px;
    }

    .currency-select-code {
        font-weight: 700;
        font-size: 0.9rem;
        color: var(--wallet-text-primary);
    }

    /* --- Responsive --- */
    @media (max-width: 768px) {
        .wallet-page-header {
            padding: 20px;
            border-radius: 20px;
        }

        .wallet-page-header h1 {
            font-size: 1.4rem;
        }

        .wallet-header-actions {
            margin-top: 16px;
            width: 100%;
        }

        .wallet-header-btn {
            flex: 1;
            justify-content: center;
            padding: 10px 14px;
            font-size: 0.8rem;
        }

        .wallet-header-btn span {
            display: none;
        }

        .total-balance-card-2026 {
            padding: 20px;
        }

        .balance-amount {
            font-size: 2rem;
        }

        .balance-icon-container {
            width: 56px;
            height: 56px;
        }

        .wallet-grid {
            grid-template-columns: 1fr;
            gap: 14px;
        }

        .wallet-card-2026 {
            padding: 18px;
        }

        .wallet-balance-value {
            font-size: 1.5rem;
        }

        .currency-select-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 pb-24">

    <!-- Page Header with Actions -->
    <div class="wallet-page-header">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <h1>
                    <i data-lucide="wallet" class="w-7 h-7"></i>
                    Mes Portefeuilles
                </h1>
                <p>G√©rez vos soldes multi-devises et vos transactions</p>
            </div>
            <div class="wallet-header-actions">
                <a href="{{ url_for('app.wallet_recharge') }}" class="wallet-header-btn wallet-header-btn-recharge">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span>Recharger</span>
                </a>
                <a href="{{ url_for('app.wallet_swap') }}" class="wallet-header-btn wallet-header-btn-swap">
                    <i data-lucide="repeat" class="w-4 h-4"></i>
                    <span>Swap</span>
                </a>
                <button onclick="showAddCurrencyModal()" class="wallet-header-btn wallet-header-btn-add">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    <span>Ajouter Devise</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }} animate-fade-in-down">
                <i data-lucide="{% if category == 'success' %}check-circle{% elif category == 'error' %}x-circle{% else %}info{% endif %}" class="w-5 h-5"></i>
                <span>{{ message }}</span>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Total Balance Card -->
    <div class="total-balance-card-2026">
        <div class="flex items-center gap-6">
            <div class="balance-icon-container">
                <i data-lucide="trending-up"></i>
            </div>
            <div>
                <p class="balance-label">Solde Total √âquivalent</p>
                <p class="balance-amount">${{ "%.2f" % total_balance.total_usd }}</p>
            </div>
        </div>
    </div>

    <!-- Currency Wallets Grid -->
    <div class="wallet-grid">
        {% for wallet in total_balance.wallets %}
        <div class="wallet-card-2026" onclick="showWalletDetails('{{ wallet.currency }}', {{ wallet.balance }}, {{ wallet.usd_value }})">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-4">
                    <div class="wallet-flag-2026">
                        {{ wallet.currency | get_flag }}
                    </div>
                    <div>
                        <div class="wallet-currency-code">
                            {{ wallet.currency }}
                            {% if wallet.is_primary %}
                            <span class="wallet-primary-badge">
                                <i data-lucide="star" class="w-3 h-3"></i>
                                Principal
                            </span>
                            {% endif %}
                        </div>
                        <p class="text-sm text-muted mt-1">Portefeuille</p>
                    </div>
                </div>
                <div class="wallet-arrow-icon">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-amber-500 transition-all"></i>
                </div>
            </div>
            <div class="text-right">
                <p class="wallet-balance-value">{{ "%.2f" % wallet.balance }}</p>
                <p class="wallet-usd-equivalent">‚âà ${{ "%.2f" % wallet.usd_value }} USD</p>
            </div>
        </div>
        {% else %}
        <div class="wallet-empty-state-2026">
            <div class="wallet-empty-icon">
                <i data-lucide="wallet"></i>
            </div>
            <h2 class="text-xl font-bold text-default mb-2">Aucun Portefeuille</h2>
            <p class="text-muted mb-6">Commencez par ajouter votre premi√®re devise pour d√©marrer.</p>
            <button onclick="showAddCurrencyModal()" class="btn btn-primary">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                <span>Ajouter une Devise</span>
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Recent Transactions -->
    {% if transactions %}
    <div class="transactions-section">
        <div class="transactions-header">
            <h2>
                <i data-lucide="history" class="w-5 h-5 text-amber-500"></i>
                Transactions R√©centes
            </h2>
        </div>
        <div>
            {% for tx in transactions[:5] %}
            <div class="transaction-item-2026">
                <div class="flex items-center gap-4">
                    <div class="transaction-icon-2026 {{ 'transaction-icon-credit' if tx.recipient_id == session.user_id else 'transaction-icon-debit' }}">
                        <i data-lucide="{{ tx.type | get_transaction_icon }}" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-default">{{ tx.type|title }}</h3>
                        <p class="text-sm text-muted">
                            {{ tx.created_at.strftime('%d %b %Y √† %H:%M') if tx.created_at else 'Date inconnue' }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="{{ 'transaction-amount-credit' if tx.recipient_id == session.user_id else 'transaction-amount-debit' }}">
                            {{ '+' if tx.recipient_id == session.user_id else '-' }}{{ "%.2f" % tx.amount }} {{ tx.currency }}
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<!-- Wallet Details Modal -->
<div class="wise-modal" id="walletDetailsModal">
    <div class="wise-modal-backdrop" onclick="closeWalletDetails()" style="position:absolute;inset:0;"></div>
    <div class="wise-modal-content" style="max-width: 560px; position: relative; z-index: 1;">
        <div class="wise-modal-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="modal-flag-large" id="modalFlag"></div>
                    <div>
                        <h2 id="modalCurrency" class="text-2xl font-bold text-default"></h2>
                        <p id="modalBalance" class="text-sm text-muted mt-1"></p>
                    </div>
                </div>
                <button onclick="closeWalletDetails()" class="btn btn-ghost btn-icon" style="background: rgba(0,0,0,0.05); border-radius: 12px;">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <div class="p-6" style="max-height: 300px; overflow-y: auto;">
            <div id="transactionsList">
                <div class="text-center py-12 text-muted">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p>Aucune transaction pour cette devise.</p>
                </div>
            </div>
        </div>
        <div class="p-6 border-t border-border space-y-3" style="background: rgba(224, 90, 3, 0.02);">
            <button onclick="setAsPrimaryCurrency()" class="modal-action-btn modal-action-btn-primary">
                <i data-lucide="star" class="w-4 h-4"></i>
                <span>D√©finir comme devise principale</span>
            </button>
            <button onclick="confirmRemoveCurrency()" class="modal-action-btn modal-action-btn-danger">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                <span>Retirer la devise</span>
            </button>
        </div>
    </div>
</div>

<!-- Add Currency Modal -->
<div class="wise-modal" id="addCurrencyModal">
    <div class="wise-modal-backdrop" onclick="closeAddCurrencyModal()" style="position:absolute;inset:0;"></div>
    <div class="wise-modal-content" style="position: relative; z-index: 1;">
        <div class="wise-modal-header">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold text-default">Ajouter une Devise</h2>
                <button onclick="closeAddCurrencyModal()" class="btn btn-ghost btn-icon" style="background: rgba(0,0,0,0.05); border-radius: 12px;">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <p class="text-sm text-muted mb-6">
                S√©lectionnez une devise √† ajouter √† votre portefeuille multi-devises.
            </p>
            <form method="POST" action="{{ url_for('app.add_wallet_currency') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="currency-select-grid">
                    {% for currency in ['USD', 'EUR', 'GBP', 'MAD', 'CHF', 'CAD', 'AED', 'SAR'] %}
                    <label class="currency-select-item">
                        <input type="radio" name="currency" value="{{ currency }}" required>
                        <div class="currency-select-card">
                            <div class="currency-select-flag">{{ currency | get_flag }}</div>
                            <p class="currency-select-code">{{ currency }}</p>
                        </div>
                    </label>
                    {% endfor %}
                </div>
                <button type="submit" class="btn btn-primary w-full mt-6" style="padding: 14px 20px; border-radius: 14px;">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    <span>Ajouter au Portefeuille</span>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

let currentCurrency = '';
let currentBalance = 0;

// Wallet Details Modal
function showWalletDetails(currency, balance, usdValue) {
    currentCurrency = currency;
    currentBalance = balance;

    const flags = {
        'USD': 'üá∫üá∏', 'EUR': 'üá™üá∫', 'GBP': 'üá¨üáß', 'MAD': 'üá≤üá¶',
        'CHF': 'üá®üá≠', 'CAD': 'üá®üá¶', 'AED': 'üá¶üá™', 'SAR': 'üá∏üá¶'
    };

    document.getElementById('modalFlag').textContent = flags[currency] || 'üíµ';
    document.getElementById('modalCurrency').textContent = currency;
    document.getElementById('modalBalance').textContent = `Solde: ${balance.toFixed(2)} ${currency}`;

    const modal = document.getElementById('walletDetailsModal');
    modal.classList.add('active');

    loadCurrencyTransactions(currency);

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function closeWalletDetails() {
    document.getElementById('walletDetailsModal').classList.remove('active');
}

// Add Currency Modal
function showAddCurrencyModal() {
    document.getElementById('addCurrencyModal').classList.add('active');
}

function closeAddCurrencyModal() {
    document.getElementById('addCurrencyModal').classList.remove('active');
}

// Load currency transactions via AJAX
async function loadCurrencyTransactions(currency) {
    const transactionsList = document.getElementById('transactionsList');
    transactionsList.innerHTML = `
        <div class="text-center py-12 text-muted">
            <i data-lucide="loader" class="w-12 h-12 mx-auto mb-4 animate-spin"></i>
            <p>Chargement des transactions...</p>
        </div>
    `;
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    try {
        const response = await fetch(`/app/wallets/transactions/${currency}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        if (data.transactions && data.transactions.length > 0) {
            let html = '<div class="space-y-3">';
            data.transactions.forEach(tx => {
                const isCredit = tx.recipient_id === '{{ session.user_id }}';
                html += `
                    <div class="transaction-item-2026">
                        <div class="flex items-center gap-4">
                            <div class="transaction-icon-2026 ${isCredit ? 'transaction-icon-credit' : 'transaction-icon-debit'}">
                                <i data-lucide="${tx.type === 'deposit' ? 'arrow-down-left' : (tx.type === 'withdrawal' ? 'arrow-up-right' : 'arrow-right-left')}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-default">${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</h3>
                                <p class="text-sm text-muted">${new Date(tx.created_at).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="${isCredit ? 'transaction-amount-credit' : 'transaction-amount-debit'}">
                                    ${isCredit ? '+' : '-'}${tx.amount.toFixed(2)} ${tx.currency}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            transactionsList.innerHTML = html;
        } else {
            transactionsList.innerHTML = `
                <div class="text-center py-12 text-muted">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                    <p>Aucune transaction pour cette devise.</p>
                </div>
            `;
        }
    } catch (error) {
        transactionsList.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <i data-lucide="x-circle" class="w-12 h-12 mx-auto mb-4"></i>
                <p>Erreur de chargement des transactions.</p>
            </div>
        `;
    } finally {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
}

// Confirm remove currency
function confirmRemoveCurrency() {
    if (currentBalance > 0) {
        if (typeof SarfXNotify !== 'undefined') {
            SarfXNotify.error('Impossible de retirer cette devise. Le solde doit √™tre √† z√©ro.');
        } else {
            alert('Impossible de retirer cette devise. Le solde doit √™tre √† z√©ro.');
        }
        return;
    }

    if (confirm(`√ätes-vous s√ªr de vouloir retirer ${currentCurrency} de votre portefeuille?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("app.remove_wallet_currency") }}';

        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
        if (csrfToken) {
            const inputCsrf = document.createElement('input');
            inputCsrf.type = 'hidden';
            inputCsrf.name = 'csrf_token';
            inputCsrf.value = csrfToken;
            form.appendChild(inputCsrf);
        }

        const inputCurrency = document.createElement('input');
        inputCurrency.type = 'hidden';
        inputCurrency.name = 'currency';
        inputCurrency.value = currentCurrency;

        form.appendChild(inputCurrency);
        document.body.appendChild(form);
        form.submit();
    }
}

function setAsPrimaryCurrency() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("app.set_primary_currency") }}';

    // Add CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (csrfToken) {
        const inputCsrf = document.createElement('input');
        inputCsrf.type = 'hidden';
        inputCsrf.name = 'csrf_token';
        inputCsrf.value = csrfToken;
        form.appendChild(inputCsrf);
    }

    const inputCurrency = document.createElement('input');
    inputCurrency.type = 'hidden';
    inputCurrency.name = 'currency';
    inputCurrency.value = currentCurrency;

    form.appendChild(inputCurrency);
    document.body.appendChild(form);
    form.submit();
}

// Close modals on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeWalletDetails();
        closeAddCurrencyModal();
    }
});
</script>
{% endblock %}
