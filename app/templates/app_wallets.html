{% extends "app_base.html" %}

{% block title %}Mes Portefeuilles - SarfX{% endblock %}

{% block extra_head %}
<style>
    :root {
        --wallet-card-bg: var(--card-bg);
        --wallet-card-border: var(--border-color);
        --wallet-card-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        --wallet-card-hover-shadow: 0 8px 24px rgba(224, 90, 3, 0.15);
    }

    [data-theme="dark"] {
        --wallet-card-bg: var(--card-bg-dark);
        --wallet-card-border: var(--border-color-dark);
        --wallet-card-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .wallet-card {
        background-color: var(--wallet-card-bg);
        border: 1px solid var(--wallet-card-border);
        box-shadow: var(--wallet-card-shadow);
        transition: all 0.2s ease-in-out;
    }
    .wallet-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--wallet-card-hover-shadow);
        border-color: var(--brand-orange);
    }
    .wallet-flag-container {
        width: 64px;
        height: 64px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        background: linear-gradient(135deg, rgba(224, 90, 3, 0.1), rgba(255, 140, 66, 0.1));
        border-radius: 16px;
    }
    .total-balance-card {
        background: linear-gradient(135deg, rgba(224, 90, 3, 0.2), rgba(255, 140, 66, 0.2));
        border: 1px solid rgba(224, 90, 3, 0.3);
    }
    .wise-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
        background: rgba(0, 0, 0, 0.7);
    }
    .wise-modal.active {
        display: flex !important;
    }
    .wise-modal-content {
        max-width: 500px;
        width: 90%;
    }
    .wise-tab-content {
        display: none;
    }
    .wise-tab-content.active {
        display: block !important;
    }
    .wise-modal-tab {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .wise-modal-tab.active {
        color: var(--brand-orange) !important;
        border-bottom-color: var(--brand-orange) !important;
    }
    .wise-btn-primary:hover {
        background: rgb(200, 80, 3);
        transform: translateY(-1px);
    }
    /* Empty State */
    .wallet-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 20px;
        border-radius: 16px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}

<div class="space-y-8 pb-24">

    <!-- Header -->

    <div class="flex flex-wrap gap-4 justify-between items-center pt-2">

        <div>

            <h1 class="text-3xl font-bold text-default flex items-center gap-3">

                <i data-lucide="wallet" class="w-8 h-8 text-amber-500"></i>

                Mes Portefeuilles

            </h1>

            <p class="text-muted text-sm mt-1">GÃ©rez vos soldes multi-devises et vos transactions.</p>

        </div>

        <div class="flex gap-2 flex-wrap">
            <a href="{{ url_for('app.wallet_recharge') }}" class="btn btn-success" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                <i data-lucide="credit-card" class="w-4 h-4"></i>
                <span>Recharger</span>
            </a>
            <a href="{{ url_for('app.wallet_swap') }}" class="btn btn-secondary">
                <i data-lucide="repeat" class="w-4 h-4"></i>
                <span>Swap</span>
            </a>
            <button onclick="showAddCurrencyModal()" class="btn btn-primary">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                <span>Ajouter une Devise</span>
            </button>
        </div>

    </div>



    <!-- Flash Messages -->

    {% with messages = get_flashed_messages(with_categories=true) %}

        {% if messages %}

            {% for category, message in messages %}

            <div class="alert alert-{{ category }} animate-fade-in-down">

                <i data-lucide="{% if category == 'success' %}check-circle{% elif category == 'error' %}x-circle{% else %}info{% endif %}" class="w-5 h-5"></i>

                <span>{{ message }}</span>

            </div>

            {% endfor %}

        {% endif %}

    {% endwith %}



    <!-- Total Balance Card -->

    <div class="card total-balance-card p-6 rounded-2xl">

        <div class="flex items-center gap-6">

            <div class="w-16 h-16 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl flex items-center justify-center shadow-lg">

                <i data-lucide="trending-up" class="w-8 h-8 text-white"></i>

            </div>

            <div>

                <p class="text-sm text-muted mb-1">Solde Total (Ã©quivalent USD)</p>

                <p class="text-4xl font-bold text-default">${{ "%.2f" % total_balance.total_usd }}</p>

            </div>

        </div>

    </div>



    <!-- Currency Wallets Grid -->

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

        {% for wallet in total_balance.wallets %}

        <div class="wallet-card card rounded-2xl cursor-pointer" onclick="showWalletDetails('{{ wallet.currency }}', {{ wallet.balance }}, {{ wallet.usd_value }})">

            <div class="p-6">

                <div class="flex items-start justify-between mb-4">

                    <div class="flex items-center gap-4">

                        <div class="wallet-flag-container">

                            {{ wallet.currency | get_flag }}

                        </div>

                                                <div>

                                                    <h3 class="font-bold text-xl text-default flex items-center">

                                                        {{ wallet.currency }}

                                                        {% if wallet.is_primary %}

                                                            <span class="ml-2 text-amber-500" title="Devise principale">

                                                                <i data-lucide="star" class="w-4 h-4 fill-current"></i>

                                                            </span>

                                                        {% endif %}

                                                    </h3>

                                                    <p class="text-sm text-muted">Solde</p>

                                                </div>

                    </div>

                    <i data-lucide="chevron-right" class="w-5 h-5 text-muted"></i>

                </div>

                <div class="space-y-2 text-right">

                    <p class="text-3xl font-bold text-default">{{ "%.2f" % wallet.balance }}</p>

                    <p class="text-sm text-muted">â‰ˆ ${{ "%.2f" % wallet.usd_value }} USD</p>

                </div>

            </div>

        </div>

        {% else %}

        <div class="card p-8 rounded-2xl text-center col-span-full wallet-empty-state">

            <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-full mx-auto flex items-center justify-center mb-4">

                <i data-lucide="wallet" class="w-8 h-8 text-slate-500"></i>

            </div>

            <h2 class="text-xl font-semibold mb-2">Aucun Portefeuille</h2>

            <p class="text-muted mb-4">Commencez par ajouter votre premiÃ¨re devise.</p>

            <button onclick="showAddCurrencyModal()" class="btn btn-primary">

                <i data-lucide="plus-circle" class="w-4 h-4"></i>

                <span>Ajouter une Devise</span>

            </button>

        </div>

        {% endfor %}

    </div>



    <!-- Recent Transactions -->

    {% if transactions %}

    <div class="space-y-4 mt-6">

        <h2 class="text-xl font-bold text-default">Transactions RÃ©centes</h2>

        <div class="space-y-3">

            {% for tx in transactions[:5] %}

            <div class="card p-4 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">

                <div class="flex items-center gap-4">

                    <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-500">

                        <i data-lucide="{{ tx.type | get_transaction_icon }}" class="w-5 h-5"></i>

                    </div>

                    <div class="flex-1">

                        <h3 class="font-semibold text-default">{{ tx.type|title }}</h3>

                        <p class="text-sm text-muted">

                            {{ tx.created_at.strftime('%d %b %Y Ã  %H:%M') if tx.created_at else 'Date inconnue' }}

                        </p>

                    </div>

                    <div class="text-right">

                        <p class="font-bold text-lg {{ 'text-green-500' if tx.recipient_id == session.user_id else 'text-red-500' }}">

                            {{ '+' if tx.recipient_id == session.user_id else '-' }}{{ "%.2f" % tx.amount }} {{ tx.currency }}

                        </p>

                    </div>

                </div>

            </div>

            {% endfor %}

        </div>

    </div>

    {% endif %}

</div>



<!-- Wallet Details Modal -->

<div class="wise-modal" id="walletDetailsModal">

    <div class="wise-modal-content card" style="max-width: 600px;">

        <div class="wise-modal-header p-6 border-b border-border">

            <div class="flex items-center justify-between">

                <div class="flex items-center gap-4">

                    <div class="text-5xl" id="modalFlag"></div>

                    <div>

                        <h2 id="modalCurrency" class="text-2xl font-bold text-default"></h2>

                        <p id="modalBalance" class="text-sm text-muted mt-1"></p>

                    </div>

                </div>

                <button onclick="closeWalletDetails()" class="btn btn-ghost btn-icon">

                    <i data-lucide="x" class="w-5 h-5"></i>

                </button>

            </div>

        </div>

        <div class="p-6">

            <!-- Tabs can go here in the future -->

            <div id="transactionsList">

                <div class="text-center py-12 text-muted">

                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>

                    <p>Aucune transaction pour cette devise.</p>

                </div>

            </div>

        </div>

                <div class="p-6 bg-slate-50 dark:bg-slate-800/50 border-t border-border rounded-b-2xl space-y-2">

                     <button onclick="setAsPrimaryCurrency()" class="btn btn-secondary w-full">

                        <i data-lucide="star" class="w-4 h-4"></i>

                        <span>DÃ©finir comme devise principale</span>

                    </button>

                     <button onclick="confirmRemoveCurrency()" class="btn btn-danger w-full">

                        <i data-lucide="trash-2" class="w-4 h-4"></i>

                        <span>Retirer la devise</span>

                    </button>

                </div>

    </div>

</div>



<!-- Add Currency Modal -->

<div class="wise-modal" id="addCurrencyModal">

    <div class="wise-modal-backdrop" onclick="closeAddCurrencyModal()"></div>

    <div class="wise-modal-content card">

        <div class="wise-modal-header p-6 border-b border-border">

            <div class="flex items-center justify-between">

                <h2 class="text-xl font-bold text-default">Ajouter une Devise</h2>

                <button onclick="closeAddCurrencyModal()" class="btn btn-ghost btn-icon">

                    <i data-lucide="x" class="w-5 h-5"></i>

                </button>

            </div>

        </div>

        <div class="p-6">

            <p class="text-sm text-muted mb-6">

                SÃ©lectionnez une devise Ã  ajouter Ã  votre portefeuille.

            </p>

            <form method="POST" action="{{ url_for('app.add_wallet_currency') }}">

                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">

                    {% for currency in ['USD', 'EUR', 'GBP', 'MAD', 'CHF', 'CAD', 'AED', 'SAR'] %}

                    <label class="cursor-pointer">

                        <input type="radio" name="currency" value="{{ currency }}" required class="hidden peer">

                        <div class="card p-4 rounded-xl text-center peer-checked:border-amber-500 peer-checked:bg-amber-500/10 border-2 border-transparent hover:border-amber-500/50 transition-all">

                            <div class="text-3xl mb-2">{{ currency | get_flag }}</div>

                            <p class="font-bold text-default">{{ currency }}</p>

                        </div>

                    </label>

                    {% endfor %}

                </div>

                <button type="submit" class="btn btn-primary w-full mt-6">

                    <i data-lucide="plus-circle" class="w-4 h-4"></i>

                    <span>Ajouter au Portefeuille</span>

                </button>

            </form>

        </div>

    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});

let currentCurrency = '';
let currentBalance = 0;

// Wallet Details Modal
function showWalletDetails(currency, balance, usdValue) {
    currentCurrency = currency;
    currentBalance = balance;

    const flags = {
        'USD': 'ðŸ‡ºðŸ‡¸', 'EUR': 'ðŸ‡ªðŸ‡º', 'GBP': 'ðŸ‡¬ðŸ‡§', 'MAD': 'ðŸ‡²ðŸ‡¦',
        'CHF': 'ðŸ‡¨ðŸ‡­', 'CAD': 'ðŸ‡¨ðŸ‡¦', 'AED': 'ðŸ‡¦ðŸ‡ª', 'SAR': 'ðŸ‡¸ðŸ‡¦'
    };

    document.getElementById('modalFlag').textContent = flags[currency] || 'ðŸ’µ';
    document.getElementById('modalCurrency').textContent = currency;
    document.getElementById('modalBalance').textContent = `Solde: ${balance.toFixed(2)} ${currency}`;

    const modal = document.getElementById('walletDetailsModal');
    modal.classList.add('active');

    loadCurrencyTransactions(currency);

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function closeWalletDetails() {
    document.getElementById('walletDetailsModal').classList.remove('active');
}

// Add Currency Modal
function showAddCurrencyModal() {
    document.getElementById('addCurrencyModal').classList.add('active');
}

function closeAddCurrencyModal() {
    document.getElementById('addCurrencyModal').classList.remove('active');
}

// Load currency transactions via AJAX
async function loadCurrencyTransactions(currency) {
    const transactionsList = document.getElementById('transactionsList');
    transactionsList.innerHTML = `
        <div class="text-center py-12 text-muted">
            <i data-lucide="loader" class="w-12 h-12 mx-auto mb-4 animate-spin"></i>
            <p>Chargement des transactions...</p>
        </div>
    `;
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    try {
        const response = await fetch(`/app/wallets/transactions/${currency}`);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const data = await response.json();

        if (data.transactions && data.transactions.length > 0) {
            let html = '<div class="space-y-3">';
            data.transactions.forEach(tx => {
                const isCredit = tx.recipient_id === '{{ session.user_id }}';
                html += `
                    <div class="card p-4 rounded-xl">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-500">
                                <i data-lucide="${tx.type === 'deposit' ? 'arrow-down-left' : (tx.type === 'withdrawal' ? 'arrow-up-right' : 'arrow-right-left')}" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-semibold text-default">${tx.type.charAt(0).toUpperCase() + tx.type.slice(1)}</h3>
                                <p class="text-sm text-muted">${new Date(tx.created_at).toLocaleString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-lg ${isCredit ? 'text-green-500' : 'text-red-500'}">
                                    ${isCredit ? '+' : '-'}${tx.amount.toFixed(2)} ${tx.currency}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            transactionsList.innerHTML = html;
        } else {
            transactionsList.innerHTML = `
                <div class="text-center py-12 text-muted">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4"></i>
                    <p>Aucune transaction pour cette devise.</p>
                </div>
            `;
        }
    } catch (error) {
        transactionsList.innerHTML = `
            <div class="text-center py-12 text-red-500">
                <i data-lucide="x-circle" class="w-12 h-12 mx-auto mb-4"></i>
                <p>Erreur de chargement des transactions.</p>
            </div>
        `;
    } finally {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }
}

// Confirm remove currency
function confirmRemoveCurrency() {
    if (currentBalance > 0) {
        SarfXNotify.error('Impossible de retirer cette devise. Le solde doit Ãªtre Ã  zÃ©ro.');
        return;
    }

    if (confirm(`ÃŠtes-vous sÃ»r de vouloir retirer ${currentCurrency} de votre portefeuille?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("app.remove_wallet_currency") }}';

        const inputCurrency = document.createElement('input');
        inputCurrency.type = 'hidden';
        inputCurrency.name = 'currency';
        inputCurrency.value = currentCurrency;

        form.appendChild(inputCurrency);
        document.body.appendChild(form);
        form.submit();
    }
}

function setAsPrimaryCurrency() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("app.set_primary_currency") }}';

    const inputCurrency = document.createElement('input');
    inputCurrency.type = 'hidden';
    inputCurrency.name = 'currency';
    inputCurrency.value = currentCurrency;

    form.appendChild(inputCurrency);
    document.body.appendChild(form);
    form.submit();
}

// Close modals on escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeWalletDetails();
        closeAddCurrencyModal();
    }
});
</script>
{% endblock %}