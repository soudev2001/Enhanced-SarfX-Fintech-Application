{% extends "app_base.html" %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start pt-4">
        <h2 class="text-xl font-bold flex items-center gap-2 text-adaptive">
            <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-500"></i>
            SarfX IA
        </h2>
        <button onclick="document.getElementById('ai-config').classList.toggle('hidden')" class="p-2 glass-panel rounded-full text-adaptive-muted">
            <i data-lucide="settings-2" class="w-4 h-4"></i>
        </button>
    </div>
    
    <!-- Config Panel -->
    <div id="ai-config" class="hidden glass-panel p-4 rounded-xl space-y-2">
        <label class="text-xs text-adaptive-muted">URL Backend IA</label>
        <input type="text" id="ai-url" value="{{ ai_backend_url | default('https://sarfx-backend-ai-618432953337.europe-west1.run.app') }}" class="w-full glass-input rounded-lg p-2 text-xs font-mono">
        <div class="flex gap-2">
            <select id="ai-pair" class="flex-1 glass-input rounded-lg p-2 text-xs">
                <option value="EURUSD=X">EUR/USD</option>
                <option value="USDMAD=X">USD/MAD</option>
                <option value="EURMAD=X">EUR/MAD</option>
                <option value="GBPUSD=X">GBP/USD</option>
            </select>
            <button onclick="fetchAiData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold">
                Analyser
            </button>
        </div>
    </div>

    <!-- Error -->
    <div id="ai-error" class="hidden bg-rose-500/10 text-rose-500 p-4 rounded-xl text-sm border border-rose-500/20"></div>
    
    <!-- Skeleton -->
    <div id="ai-skeleton" class="hidden space-y-8 animate-pulse w-full">
        <div class="w-full h-56 skeleton rounded-2xl"></div>
        <div class="h-16 skeleton rounded-xl"></div>
    </div>

    <!-- Dashboard -->
    <div id="ai-dashboard" class="space-y-6 hidden">
        <div class="text-center">
            <h3 class="text-adaptive-muted text-sm font-bold tracking-widest uppercase mb-1" id="pair-display">EUR / USD</h3>
            <div class="relative inline-block">
                <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-[rgb(224,90,3)] tracking-tighter" id="stat-pred">--</h1>
                <span id="trend-badge" class="absolute -right-16 top-1 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase bg-slate-800 border border-slate-700 text-slate-400">--</span>
            </div>
            <p class="text-xs text-adaptive-muted font-medium">Prévision IA à J+7</p>
        </div>
        
        <!-- Chart -->
        <div class="glass-panel p-2 rounded-2xl relative h-64 border-t border-white/5">
            <div id="chart-container" class="w-full h-full"></div>
        </div>
        
        <!-- Model Results -->
        <div class="grid grid-cols-3 gap-2 text-center text-xs">
            <div class="glass-panel p-3 rounded-xl border-t border-emerald-500/20">
                <span class="text-emerald-500 font-bold block mb-1">ARIMA</span>
                <span id="res-arima" class="font-mono text-adaptive">--</span>
            </div>
            <div class="glass-panel p-3 rounded-xl border-t border-amber-500/20">
                <span class="text-amber-500 font-bold block mb-1">Prophet</span>
                <span id="res-prophet" class="font-mono text-adaptive">--</span>
            </div>
            <div class="glass-panel p-3 rounded-xl border-t border-pink-500/20">
                <span class="text-pink-500 font-bold block mb-1">LSTM</span>
                <span id="res-lstm" class="font-mono text-adaptive">--</span>
            </div>
        </div>

        <!-- AI Converter -->
        <div class="glass-panel p-5 rounded-xl space-y-2">
            <label class="text-xs font-bold text-adaptive-muted uppercase flex items-center gap-2">
                <i data-lucide="calculator" class="w-3 h-3"></i> Simulateur IA (J+7)
            </label>
            <div class="flex items-center gap-4">
                <input type="number" id="ai-input-amount" value="1000" class="flex-1 w-full bg-transparent text-xl font-bold text-adaptive focus:outline-none border-b border-slate-700 pb-2">
                <div class="text-right">
                    <p id="res-mean" class="text-xl font-bold text-blue-500 font-mono">--</p>
                    <span class="text-xs text-adaptive-muted font-bold" id="target-currency">USD</span>
                </div>
            </div>
        </div>
        
        <!-- Insights -->
        <div class="glass-panel p-4 rounded-xl">
            <h3 class="text-sm font-bold text-adaptive mb-3 flex items-center gap-2">
                <i data-lucide="lightbulb" class="w-4 h-4 text-amber-400"></i> Analyse IA
            </h3>
            <p class="text-xs text-adaptive-muted" id="ai-insight">
                Les prévisions sont basées sur l'analyse de données historiques utilisant des modèles ARIMA, Prophet et LSTM.
            </p>
        </div>
    </div>

    <!-- Initial State -->
    <div id="ai-initial" class="text-center py-12 space-y-4">
        <div class="w-20 h-20 bg-purple-500/10 rounded-full mx-auto flex items-center justify-center">
            <i data-lucide="brain-circuit" class="w-10 h-10 text-purple-500"></i>
        </div>
        <h3 class="text-xl font-bold text-adaptive">Prévisions IA</h3>
        <p class="text-sm text-adaptive-muted max-w-xs mx-auto">
            Analysez les tendances du marché des devises avec nos modèles d'intelligence artificielle.
        </p>
        <button onclick="fetchAiData()" class="btn-primary max-w-xs mx-auto">
            <i data-lucide="play" class="w-5 h-5"></i> Lancer l'analyse
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let chartInstance = null;
    let currentPredictions = null;

    async function fetchAiData() {
        const pair = document.getElementById('ai-pair').value;
        
        // Use Flask API endpoint (acts as proxy to AI backend - no CORS issues)
        const apiUrl = `/api/forecast/${pair}`;
        
        // Hide initial, show skeleton
        document.getElementById('ai-initial').classList.add('hidden');
        document.getElementById('ai-dashboard').classList.add('hidden');
        document.getElementById('ai-error').classList.add('hidden');
        document.getElementById('ai-skeleton').classList.remove('hidden');

        try {
            const res = await fetch(apiUrl);
            if (!res.ok) throw new Error(`Erreur API: ${res.status}`);
            const response = await res.json();
            
            // Check if the response was successful
            if (!response.success) {
                throw new Error(response.error || 'Erreur inconnue');
            }
            
            const data = response.data;
            
            document.getElementById('ai-skeleton').classList.add('hidden');
            document.getElementById('ai-dashboard').classList.remove('hidden');

            // Update pair display
            const pairName = pair.replace('=X', '').replace(/(.{3})(.{3})/, '$1 / $2');
            document.getElementById('pair-display').textContent = pairName;
            document.getElementById('target-currency').textContent = pair.substring(3, 6);

            // Calculate stats
            const last = data.history[data.history.length - 1].Close;
            const pred = data.predictions.Ensemble_Mean[6];
            const pct = ((pred - last) / last) * 100;
            
            document.getElementById('stat-pred').textContent = pred.toFixed(4);
            
            const badge = document.getElementById('trend-badge');
            badge.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
            badge.className = `absolute -right-16 top-1 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase border ${
                pct >= 0 
                    ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' 
                    : 'bg-rose-500/10 text-rose-400 border-rose-500/20'
            }`;

            // Store predictions
            currentPredictions = {
                mean: pred,
                arima: data.predictions.ARIMA[6],
                prophet: data.predictions.Prophet[6],
                lstm: data.predictions.LSTM[6]
            };
            
            document.getElementById('res-arima').textContent = currentPredictions.arima.toFixed(4);
            document.getElementById('res-prophet').textContent = currentPredictions.prophet.toFixed(4);
            document.getElementById('res-lstm').textContent = currentPredictions.lstm.toFixed(4);
            
            // Update insight
            const insight = pct >= 0 
                ? `La tendance prévue est à la hausse (+${pct.toFixed(2)}%). Le modèle Ensemble suggère un taux de ${pred.toFixed(4)} dans 7 jours.`
                : `La tendance prévue est à la baisse (${pct.toFixed(2)}%). Le modèle Ensemble suggère un taux de ${pred.toFixed(4)} dans 7 jours.`;
            document.getElementById('ai-insight').textContent = insight;
            
            updateAiConversion();

            // Render Chart
            if (chartInstance) chartInstance.destroy();
            
            const options = {
                series: [
                    { name: 'Ensemble', data: data.predictions.Ensemble_Mean },
                    { name: 'ARIMA', data: data.predictions.ARIMA },
                    { name: 'Prophet', data: data.predictions.Prophet }
                ],
                chart: { 
                    type: 'area', 
                    height: 230, 
                    toolbar: { show: false }, 
                    background: 'transparent' 
                },
                theme: { mode: 'dark' },
                stroke: { curve: 'smooth', width: 2 },
                xaxis: { 
                    categories: data.dates, 
                    labels: { show: false }, 
                    axisBorder: { show: false }, 
                    axisTicks: { show: false } 
                },
                yaxis: { labels: { formatter: val => val.toFixed(4) } },
                grid: { borderColor: '#334155', strokeDashArray: 4 },
                colors: ['#3b82f6', '#10b981', '#f59e0b'],
                legend: { show: true, position: 'top', labels: { colors: '#94a3b8' } },
                fill: { type: 'gradient', gradient: { opacityFrom: 0.4, opacityTo: 0.1 } }
            };
            
            chartInstance = new ApexCharts(document.querySelector("#chart-container"), options);
            chartInstance.render();

        } catch (e) {
            console.error(e);
            document.getElementById('ai-skeleton').classList.add('hidden');
            document.getElementById('ai-error').textContent = `Erreur: ${e.message}. Vérifiez l'URL du backend IA.`;
            document.getElementById('ai-error').classList.remove('hidden');
            document.getElementById('ai-initial').classList.remove('hidden');
        }
    }

    function updateAiConversion() {
        if (!currentPredictions) return;
        const amount = parseFloat(document.getElementById('ai-input-amount').value) || 0;
        document.getElementById('res-mean').textContent = (amount * currentPredictions.mean).toFixed(2);
    }

    document.getElementById('ai-input-amount').addEventListener('input', updateAiConversion);
</script>
{% endblock %}
