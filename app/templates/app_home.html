{% extends "app_base.html" %}

{% block content %}
<div class="wise-home animate-fade-in redesign-2026">
    <!-- Hero Section - 2026 Redesign -->
    <section class="hero-2026">
        <div class="hero-badge-2026">
            <span class="live-dot-2026"></span>
            Taux en direct
        </div>
        <h1 class="hero-title-2026">
            Envoyez de l'argent<br/>
            au meilleur taux
        </h1>
        <p class="hero-subtitle-2026">
            Comparez Western Union, Wise, et les banques marocaines en temps r√©el.
        </p>
    </section>

    <!-- Quick Convert Card - 2026 Glassmorphism Style -->
    <section class="converter-card-2026 glass-card">
        <!-- You Send -->
        <div class="wise-convert-header">
            <span class="wise-label">You send</span>
            <div class="live-indicator-2026">
                <span class="live-dot-2026"></span>
                Live
            </div>
        </div>

        <div class="converter-input-group-2026">
            <input type="number" id="home-amount" value="1000" class="converter-input-2026" placeholder="1,000.00">
            <select id="home-from-currency" class="currency-select-2026">
                <option value="USD">üá∫üá∏ USD</option>
                <option value="EUR">üá™üá∫ EUR</option>
                <option value="GBP">üá¨üáß GBP</option>
                <option value="CHF">üá®üá≠ CHF</option>
                <option value="CAD">üá®üá¶ CAD</option>
                <option value="AED">üá¶üá™ AED</option>
                <option value="SAR">üá∏üá¶ SAR</option>
            </select>
        </div>

        <!-- SarfX Rate Info - Modern Display -->
        <div class="rate-display-2026">
            <div>
                <span class="wise-rate-label" style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Taux SarfX</span>
                <span class="rate-value-2026" id="home-rate">10.1002</span>
            </div>
            <div style="text-align: right;">
                <span class="wise-rate-label" style="font-size: 12px; color: var(--text-tertiary); display: block; margin-bottom: 4px;">Frais</span>
                <span style="color: var(--success); font-weight: 600;" id="home-fees">0.00 <span id="home-fees-currency">USD</span></span>
            </div>
        </div>

        <!-- Recipient Receives -->
        <div class="wise-convert-header" style="margin-top: 16px;">
            <span class="wise-label">Le b√©n√©ficiaire re√ßoit</span>
            <span class="wise-via-sarfx" style="font-size: 11px; color: var(--brand-primary); font-weight: 600;">via SarfX</span>
        </div>

        <div class="converter-input-group-2026" style="margin-bottom: 0;">
            <div class="converter-input-2026" style="background: var(--bg-secondary); border-radius: var(--radius-xl); padding: var(--space-4) var(--space-6); display: flex; align-items: center; justify-content: space-between;">
                <span id="home-result" style="font-size: 28px; font-weight: 700; color: var(--text-primary);">10 100,20</span>
                <div style="display: flex; align-items: center; gap: 8px; background: var(--surface); padding: 8px 12px; border-radius: var(--radius-lg); border: 1px solid var(--border-light);">
                    <span>üá≤üá¶</span>
                    <span style="font-weight: 600;">MAD</span>
                </div>
            </div>
        </div>

        <!-- Last Updated & Refresh -->
        <div class="wise-update-row" style="display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-light);">
            <div class="wise-update-time" style="display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-tertiary);">
                <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                <span>Last updated: <strong id="last-update-time">--:--:--</strong></span>
            </div>
            <button onclick="refreshRates()" class="btn-secondary-2026" id="refresh-btn">
                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;" id="refresh-icon"></i>
                Refresh
            </button>
        </div>

        <!-- AI Status -->
        <div class="wise-ai-status" style="display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 10px 14px; background: linear-gradient(135deg, rgba(139,92,246,0.05), rgba(236,72,153,0.05)); border-radius: var(--radius-lg);">
            <div style="width: 8px; height: 8px; background: var(--accent-purple); border-radius: 50%; animation: pulse-dot 2s infinite;"></div>
            <span id="ai-status-text" style="font-size: 12px; color: var(--text-secondary);">AI scanning market opportunities...</span>
        </div>

        <button id="continue-btn" onclick="goToConverter(event)" class="btn-primary-2026" style="margin-top: 20px;">
            Continuer <i data-lucide="arrow-right" style="width: 20px; height: 20px;"></i>
        </button>
    </section>

    <!-- Compare Providers Section - Redesigned -->
    <section class="glass-card" style="padding: var(--space-5); margin-top: var(--space-4);">
        <div class="wise-card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
            <h2 style="font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="git-compare" style="width: 18px; height: 18px; color: var(--brand-primary);"></i>
                Compare Providers
            </h2>
        </div>

        <!-- Providers List - Modern Design -->
        <div class="providers-grid-2026 stagger-animation" id="providers-list">
            <!-- SarfX - Best -->
            <div class="provider-card-2026 provider-best animate-slide-up" onclick="selectProvider('SarfX', 10.1002, 10)">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="provider-logo-2026">S</div>
                    <div class="provider-info-2026">
                        <div class="provider-name-2026">
                            SarfX
                            <span class="best-tag-2026">
                                <i data-lucide="star" style="width: 10px; height: 10px;"></i>
                                Meilleur Taux
                            </span>
                        </div>
                        <div class="provider-meta-2026">‚≠ê 5.0 ‚Ä¢ ‚ö° Instantan√©</div>
                    </div>
                </div>
                <div class="provider-amount-2026">
                    <div class="provider-amount-value-2026" id="sarfx-amount">9898.24 MAD</div>
                    <div class="provider-amount-detail-2026">Taux: <span id="sarfx-rate">10.1002</span> ‚Ä¢ Frais: <span id="sarfx-fees">10.00</span> USD</div>
                </div>
            </div>

            <!-- Wise -->
            <div class="provider-card-2026 animate-slide-up" onclick="selectProvider('Wise', 9.9850, 5)">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="provider-logo-2026" style="background: #9FE870; color: #1A1A2E; font-size: 10px;">wise</div>
                    <div class="provider-info-2026">
                        <div class="provider-name-2026">Wise</div>
                        <div class="provider-meta-2026">‚≠ê 4.8 ‚Ä¢ ‚ö° 1-2h</div>
                    </div>
                </div>
                <div class="provider-amount-2026">
                    <div class="provider-amount-value-2026" id="wise-amount">9980.00 MAD</div>
                    <div class="provider-amount-detail-2026">Taux: <span id="wise-rate">9.9850</span> ‚Ä¢ Frais: <span id="wise-fees">5.00</span> USD</div>
                </div>
            </div>

            <!-- Western Union -->
            <div class="provider-card-2026 animate-slide-up" onclick="selectProvider('Western Union', 9.8500, 15)">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="provider-logo-2026" style="background: #FFCC00; color: #000; font-size: 11px; font-weight: 800;">WU</div>
                    <div class="provider-info-2026">
                        <div class="provider-name-2026">Western Union</div>
                        <div class="provider-meta-2026">‚≠ê 4.2 ‚Ä¢ üïê 1-3j</div>
                    </div>
                </div>
                <div class="provider-amount-2026">
                    <div class="provider-amount-value-2026" id="wu-amount">9702.50 MAD</div>
                    <div class="provider-amount-detail-2026">Taux: <span id="wu-rate">9.8500</span> ‚Ä¢ Frais: <span id="wu-fees">15.00</span> USD</div>
                </div>
            </div>

            <!-- Banque Populaire -->
            <div class="provider-card-2026 animate-slide-up" onclick="selectProvider('Banque Populaire', 9.7200, 25)">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="provider-logo-2026" style="background: #003366; font-size: 10px;">BP</div>
                    <div class="provider-info-2026">
                        <div class="provider-name-2026">Banque Populaire</div>
                        <div class="provider-meta-2026">‚≠ê 3.9 ‚Ä¢ üïê 2-4j</div>
                    </div>
                </div>
                <div class="provider-amount-2026">
                    <div class="provider-amount-value-2026" id="bp-amount">9477.00 MAD</div>
                    <div class="provider-amount-detail-2026">Taux: <span id="bp-rate">9.7200</span> ‚Ä¢ Frais: <span id="bp-fees">25.00</span> USD</div>
                </div>
            </div>
        </div>

        <!-- Savings Banner - Modernized -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(52,211,153,0.05)); border-radius: var(--radius-lg); color: var(--success); font-size: 14px; font-weight: 600;">
            <i data-lucide="piggy-bank" style="width: 18px; height: 18px;"></i>
            √âconomisez jusqu'√† <strong id="savings-amount" style="margin: 0 4px;">421 MAD</strong> avec SarfX
        </div>
    </section>

    <!-- Exchange Rate History - Redesigned 2026 -->
    <section class="glass-card" style="padding: var(--space-5); margin-top: var(--space-4);">
        <div class="wise-card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4); flex-wrap: wrap; gap: 12px;">
            <h2 style="font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                <i data-lucide="trending-up" style="width: 18px; height: 18px; color: var(--brand-primary);"></i>
                Historique des Taux
            </h2>
            <div style="display: flex; align-items: center; gap: 8px;">
                <select id="chart-source-currency" class="btn-secondary-2026" style="border: none; cursor: pointer;" onchange="loadChartData()">
                    <option value="USD">üá∫üá∏ USD</option>
                    <option value="EUR">üá™üá∫ EUR</option>
                    <option value="GBP">üá¨üáß GBP</option>
                    <option value="CHF">üá®üá≠ CHF</option>
                </select>
                <span style="color: var(--text-tertiary);">‚Üí</span>
                <select id="chart-target-currency" class="btn-secondary-2026" style="border: none; cursor: pointer;" onchange="loadChartData()">
                    <option value="MAD">üá≤üá¶ MAD</option>
                    <option value="EUR">üá™üá∫ EUR</option>
                    <option value="USD">üá∫üá∏ USD</option>
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: var(--space-4);">
            <button class="btn-secondary-2026 active" onclick="setPeriod('7')" style="flex: 1; padding: 10px;">7j</button>
            <button class="btn-secondary-2026" onclick="setPeriod('30')" style="flex: 1; padding: 10px;">30j</button>
            <button class="btn-secondary-2026" onclick="setPeriod('90')" style="flex: 1; padding: 10px;">3m</button>
            <button class="btn-secondary-2026" onclick="setPeriod('365')" style="flex: 1; padding: 10px;">1a</button>
        </div>

        <div class="wise-chart-container" id="rate-history-chart" style="height: 200px; border-radius: var(--radius-lg); overflow: hidden;"></div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: var(--space-4);">
            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-lg);">
                <span style="display: block; font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Actuel</span>
                <span style="font-size: 16px; font-weight: 700;" id="stat-current">10.10</span>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-lg);">
                <span style="display: block; font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Max</span>
                <span style="font-size: 16px; font-weight: 700; color: var(--success);" id="stat-high">10.25</span>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-lg);">
                <span style="display: block; font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Min</span>
                <span style="font-size: 16px; font-weight: 700; color: var(--error);" id="stat-low">9.95</span>
            </div>
            <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-lg);">
                <span style="display: block; font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Variation</span>
                <span style="font-size: 16px; font-weight: 700;" id="stat-change">+0.15%</span>
            </div>
        </div>
    </section>

<!-- Wallet Summary - Compact -->
    {% if total_balance and total_balance.total_usd > 0 %}
    <section class="wise-wallet-card">
        <div class="wise-wallet-header">
            <div class="wise-wallet-icon">
                <i data-lucide="wallet" style="width: 20px; height: 20px;"></i>
            </div>
            <div class="wise-wallet-info">
                <span class="wise-wallet-label">Mon portefeuille</span>
                <span class="wise-wallet-total">${{ total_balance.total_usd | round(2) }}</span>
            </div>
            <a href="{{ url_for('app.wallets') }}" class="wise-wallet-arrow">
                <i data-lucide="chevron-right" style="width: 20px; height: 20px;"></i>
            </a>
        </div>

        <div class="wise-wallet-currencies">
            {% for w in total_balance.wallets[:4] %}
            <div class="wise-currency-chip">
                <span class="wise-currency-flag">
                    {% if w.currency == 'USD' %}üá∫üá∏{% elif w.currency == 'EUR' %}üá™üá∫{% elif w.currency == 'MAD' %}üá≤üá¶{% elif w.currency == 'GBP' %}üá¨üáß{% else %}üí±{% endif %}
                </span>
                <span class="wise-currency-amount">{{ w.balance | round(2) }}</span>
                <span class="wise-currency-code">{{ w.currency }}</span>
            </div>
            {% endfor %}
        </div>

        <!-- Quick Actions -->
        <div class="wise-wallet-actions">
            <a href="{{ url_for('app.wallet_swap') }}" class="wise-action-btn">
                <i data-lucide="repeat" style="width: 16px; height: 16px;"></i>
                Swap
            </a>
            <a href="{{ url_for('app.wallets') }}" class="wise-action-btn">
                <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                Ajouter
            </a>
        </div>
    </section>
    {% else %}
    <!-- Empty Wallet State -->
    <section class="wise-wallet-card wise-wallet-empty">
        <div class="wise-wallet-header">
            <div class="wise-wallet-icon" style="background: rgba(148, 163, 184, 0.1);">
                <i data-lucide="wallet" style="width: 20px; height: 20px; color: #94a3b8;"></i>
            </div>
            <div class="wise-wallet-info">
                <span class="wise-wallet-label">Mon portefeuille</span>
                <span class="wise-wallet-total" style="color: #94a3b8;">0.00 MAD</span>
            </div>
        </div>
        <a href="{{ url_for('app.wallets') }}" class="wise-wallet-cta">
            <i data-lucide="plus-circle" style="width: 16px; height: 16px;"></i>
            Cr√©er mon portefeuille
        </a>
    </section>
    {% endif %}

    <!-- Banks Partners - Grid -->
    <section class="wise-card">
        <div class="wise-card-header">
            <h2 class="wise-card-title">
                <i data-lucide="landmark" style="width: 18px; height: 18px; color: var(--brand-primary);"></i>
                Banques Partenaires
            </h2>
            <a href="{{ url_for('app.banks_list') }}" class="wise-link">Voir tout</a>
        </div>

        <div class="wise-banks-grid">
            {% if banks and banks|length > 0 %}
                {% for bank in banks[:6] %}
                <a href="{{ url_for('app.bank_detail', bank_id=bank._id) }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    {% if bank.logo %}
                    <img src="{{ bank.logo }}" alt="{{ bank.name }}" class="wise-bank-logo">
                    {% else %}
                    <div class="wise-bank-placeholder">{{ bank.name[:2] | upper }}</div>
                    {% endif %}
                    <span class="wise-bank-name">{{ bank.name }}</span>
                </a>
                {% endfor %}
            {% else %}
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/attijariwafa.svg') }}" alt="Attijariwafa" class="wise-bank-logo">
                    <span class="wise-bank-name">Attijariwafa</span>
                </a>
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/banque-populaire.svg') }}" alt="Banque Populaire" class="wise-bank-logo">
                    <span class="wise-bank-name">B. Populaire</span>
                </a>
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/cih.svg') }}" alt="CIH" class="wise-bank-logo">
                    <span class="wise-bank-name">CIH Bank</span>
                </a>
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/boa.svg') }}" alt="BOA" class="wise-bank-logo">
                    <span class="wise-bank-name">Bank of Africa</span>
                </a>
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/bmci.svg') }}" alt="BMCI" class="wise-bank-logo">
                    <span class="wise-bank-name">BMCI</span>
                </a>
                <a href="{{ url_for('app.banks_list') }}" class="wise-bank-item" style="text-decoration: none; color: inherit;">
                    <img src="{{ url_for('static', filename='images/banks/albarid.svg') }}" alt="Al Barid" class="wise-bank-logo">
                    <span class="wise-bank-name">Al Barid</span>
                </a>
            {% endif %}
        </div>

        <p class="wise-banks-footer">
            <span class="wise-highlight">{{ bank_count|default(banks|length if banks else 6) }}</span> banques ‚Ä¢
            <span class="wise-highlight">{{ atm_count|default(250) }}{% if atm_count|default(0) > 0 %}{% else %}+{% endif %}</span> distributeurs
        </p>
    </section>

    <!-- Recent Transactions -->
    {% if transactions and transactions|length > 0 %}
    <section class="wise-card">
        <div class="wise-card-header">
            <h2 class="wise-card-title">
                <i data-lucide="history" style="width: 18px; height: 18px; color: var(--brand-primary);"></i>
                Activit√© R√©cente
            </h2>
            <a href="{{ url_for('app.transactions') }}" class="wise-link">Voir tout</a>
        </div>

        <div class="wise-transactions-list">
            {% for tx in transactions[:3] %}
            <div class="wise-tx-item">
                <div class="wise-tx-icon {{ 'wise-tx-out' if tx.type == 'send' else 'wise-tx-in' }}">
                    <i data-lucide="{{ 'arrow-up-right' if tx.type == 'send' else 'arrow-down-left' }}" style="width: 16px; height: 16px;"></i>
                </div>
                <div class="wise-tx-info">
                    <span class="wise-tx-name">{{ tx.recipient_name or tx.recipient or 'Transaction' }}</span>
                    <span class="wise-tx-date">{{ tx.created_at.strftime('%d/%m/%Y') if tx.created_at else 'Aujourd\'hui' }}</span>
                </div>
                <span class="wise-tx-amount {{ 'wise-tx-negative' if tx.type == 'send' else 'wise-tx-positive' }}">
                    {{ '-' if tx.type == 'send' else '+' }}{{ tx.amount or 0 }} {{ tx.from_currency or tx.currency or 'MAD' }}
                </span>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- Features Grid - Modern 2026 -->
    <section style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: var(--space-4);">
        <div class="glass-card" style="padding: 20px; text-align: center;">
            <div style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(224,90,3,0.15), rgba(255,138,61,0.1)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                <i data-lucide="zap" style="width: 24px; height: 24px; color: var(--brand-primary);"></i>
            </div>
            <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">Rapide</h3>
            <p style="font-size: 12px; color: var(--text-tertiary);">En quelques minutes</p>
        </div>
        <div class="glass-card" style="padding: 20px; text-align: center;">
            <div style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(52,211,153,0.1)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                <i data-lucide="shield-check" style="width: 24px; height: 24px; color: var(--success);"></i>
            </div>
            <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">S√©curis√©</h3>
            <p style="font-size: 12px; color: var(--text-tertiary);">Cryptage bancaire</p>
        </div>
        <div class="glass-card" style="padding: 20px; text-align: center;">
            <div style="width: 48px; height: 48px; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(168,85,247,0.1)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                <i data-lucide="brain-circuit" style="width: 24px; height: 24px; color: var(--accent-purple);"></i>
            </div>
            <h3 style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">IA</h3>
            <p style="font-size: 12px; color: var(--text-tertiary);">Pr√©dictions pr√©cises</p>
        </div>
    </section>

    <!-- Main CTA - Modernized -->
    <a href="{{ url_for('app.converter') }}" class="btn-primary-2026" style="margin-top: var(--space-6); text-decoration: none;">
        <span>Commencer maintenant</span>
        <i data-lucide="arrow-right" style="width: 20px; height: 20px;"></i>
    </a>
</div>

<style>
/* ==========================================
   WISE-INSPIRED DESIGN SYSTEM - HOME PAGE
   ========================================== */

/* Container */
.wise-home {
    display: flex;
    flex-direction: column;
    gap: 20px;
    padding-bottom: 100px;
}

/* Hero Section */
.wise-hero {
    padding: 20px 0 8px;
}

.wise-hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--success-bg);
    color: var(--success);
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 16px;
}

.wise-pulse-dot {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.wise-hero-title {
    font-size: 28px;
    font-weight: 800;
    line-height: 1.15;
    color: var(--text-primary);
    margin-bottom: 12px;
}

.wise-hero-highlight {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.wise-hero-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    max-width: 340px;
}

/* Convert Card */
.wise-convert-card {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 20px;
    box-shadow: var(--shadow-card);
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
    box-sizing: border-box;
}

@media (min-width: 1200px) {
    .wise-convert-card {
        max-width: 600px;
        padding: 28px;
    }
}

@media (max-width: 480px) {
    .wise-convert-card {
        padding: 16px;
        margin: 0 8px;
        border-radius: 12px;
    }
}

.wise-convert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.wise-label {
    font-size: 11px;
    color: var(--text-tertiary);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.wise-live-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--success);
    font-weight: 700;
}

.wise-live-dot {
    width: 6px;
    height: 6px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

.wise-input-row {
    display: flex;
    gap: 12px;
    align-items: center;
}

.wise-amount-input {
    flex: 1;
    font-size: 32px;
    font-weight: 700;
    border: none;
    background: transparent;
    color: var(--text-primary);
    padding: 8px 0;
    min-width: 0;
}

.wise-amount-input:focus {
    outline: none;
}

.wise-currency-select {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    min-width: 105px;
}

.wise-currency-select:focus {
    outline: none;
    border-color: var(--brand-primary);
}

.wise-rate-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-secondary);
    border-radius: 10px;
    padding: 12px 14px;
    margin: 14px 0;
}

.wise-rate-icon {
    color: var(--text-tertiary);
    font-size: 14px;
}

.wise-rate-value {
    font-size: 15px;
    font-weight: 700;
    color: var(--success);
    font-family: 'Inter', monospace;
}

.wise-rate-label {
    font-size: 11px;
    color: var(--text-tertiary);
    margin-left: auto;
}

.wise-result-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    padding: 6px 0;
}

.wise-result-value {
    font-size: 34px;
    font-weight: 800;
    color: var(--text-primary);
    font-family: 'Inter', monospace;
}

.wise-result-currency {
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 600;
}

.wise-cta-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    background: var(--brand-primary);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    margin-top: 18px;
    transition: all 0.2s ease;
}

.wise-cta-btn:hover {
    background: var(--brand-primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(224, 90, 3, 0.25);
}

/* Cards */
.wise-card {
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    padding: 18px;
    box-shadow: var(--shadow-card);
}

.wise-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}

.wise-card-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
}

.wise-select-sm {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 6px 10px;
    font-size: 12px;
    color: var(--text-secondary);
}

.wise-link {
    font-size: 13px;
    font-weight: 600;
    color: var(--brand-primary);
}

/* Rate Chart */
.wise-chart-container {
    height: 160px;
    background: var(--bg-secondary);
    border-radius: 12px;
    margin-bottom: 14px;
}

.wise-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
}

.wise-stat-item {
    text-align: center;
    padding: 10px 6px;
    background: var(--bg-secondary);
    border-radius: 10px;
}

.wise-stat-label {
    display: block;
    font-size: 10px;
    color: var(--text-tertiary);
    margin-bottom: 4px;
}

.wise-stat-value {
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
}

.wise-stat-up { color: var(--success); }
.wise-stat-down { color: var(--error); }

/* Providers */
.wise-providers-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.wise-provider-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.wise-provider-item:hover {
    border-color: var(--brand-primary);
}

.wise-provider-best {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.04);
}

.wise-best-tag {
    position: absolute;
    top: -8px;
    right: 12px;
    background: var(--success);
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 700;
}

.wise-provider-logo {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    overflow: hidden;
}

.wise-provider-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.wise-provider-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.wise-provider-rate {
    font-size: 12px;
    color: var(--text-secondary);
}

.wise-provider-rate strong {
    color: var(--text-primary);
}

.wise-provider-badge {
    font-size: 10px;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 6px;
}

.wise-badge-fast {
    background: var(--success-bg);
    color: var(--success);
}

.wise-badge-medium {
    background: var(--warning-bg);
    color: var(--warning);
}

.wise-badge-slow {
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
}

.wise-savings-banner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 14px;
    padding: 12px;
    background: var(--success-bg);
    border-radius: 10px;
    font-size: 12px;
    color: var(--success);
}

/* Wallet */
.wise-wallet-card {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
    border-radius: 16px;
    padding: 18px;
    color: white;
}

.wise-wallet-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
}

.wise-wallet-icon {
    width: 40px;
    height: 40px;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wise-wallet-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.wise-wallet-label {
    font-size: 11px;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}

.wise-wallet-total {
    font-size: 24px;
    font-weight: 800;
}

.wise-wallet-arrow {
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wise-wallet-currencies {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 4px;
}

.wise-currency-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,255,255,0.15);
    padding: 8px 12px;
    border-radius: 10px;
    flex-shrink: 0;
}

.wise-currency-flag { font-size: 16px; }
.wise-currency-amount { font-size: 14px; font-weight: 700; }
.wise-currency-code { font-size: 10px; opacity: 0.7; }

/* Wallet Actions */
.wise-wallet-actions {
    display: flex;
    gap: 8px;
    margin-top: 14px;
}

.wise-action-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: rgba(255,255,255,0.15);
    padding: 10px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    color: white;
    transition: all 0.2s ease;
}

.wise-action-btn:hover {
    background: rgba(255,255,255,0.25);
}

/* Empty Wallet */
.wise-wallet-empty {
    background: var(--surface);
    border: 1px dashed var(--border-light);
}

.wise-wallet-cta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 14px;
    padding: 12px;
    background: var(--brand-primary);
    border-radius: 10px;
    color: white;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s ease;
}

.wise-wallet-cta:hover {
    background: var(--brand-primary-dark);
    transform: translateY(-2px);
}

/* Banks Grid */
.wise-banks-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.wise-bank-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    padding: 14px 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.wise-bank-item:hover {
    border-color: var(--brand-primary);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(224, 90, 3, 0.15);
}

.wise-bank-logo {
    width: 56px;
    height: 36px;
    object-fit: contain;
}

.wise-bank-placeholder {
    width: 56px;
    height: 36px;
    background: var(--border-light);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
    color: var(--text-tertiary);
}

.wise-bank-name {
    font-size: 10px;
    color: var(--text-secondary);
    text-align: center;
    font-weight: 500;
}

.wise-banks-footer {
    text-align: center;
    margin-top: 12px;
    font-size: 12px;
    color: var(--text-tertiary);
}

.wise-highlight {
    font-weight: 700;
    color: var(--brand-primary);
}

/* Transactions */
.wise-transactions-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.wise-tx-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--bg-secondary);
    border-radius: 10px;
}

.wise-tx-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.wise-tx-out {
    background: var(--error-bg);
    color: var(--error);
}

.wise-tx-in {
    background: var(--success-bg);
    color: var(--success);
}

.wise-tx-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.wise-tx-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.wise-tx-date {
    font-size: 11px;
    color: var(--text-tertiary);
}

.wise-tx-amount {
    font-size: 14px;
    font-weight: 700;
}

.wise-tx-negative { color: var(--error); }
.wise-tx-positive { color: var(--success); }

/* Features */
.wise-features-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.wise-feature-item {
    text-align: center;
    padding: 18px 10px;
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: 12px;
}

.wise-feature-icon {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
}

.wise-feature-title {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.wise-feature-desc {
    font-size: 10px;
    color: var(--text-tertiary);
}

/* Main CTA */
.wise-main-cta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-primary-dark));
    color: white;
    padding: 18px 28px;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 6px 20px rgba(224, 90, 3, 0.25);
    transition: all 0.2s ease;
}

.wise-main-cta:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 28px rgba(224, 90, 3, 0.35);
}

/* Responsive */
@media (min-width: 640px) {
    .wise-hero-title { font-size: 36px; }
    .wise-providers-list {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
    }
    .wise-banks-grid { grid-template-columns: repeat(4, 1fr); }
}

@media (min-width: 1024px) {
    .wise-hero-title { font-size: 42px; }
    .wise-banks-grid { grid-template-columns: repeat(6, 1fr); }
}

/* Animation */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* ===== NEW STYLES FOR ENHANCED CONVERTER ===== */

/* Result Currency Box */
.wise-result-currency-box {
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-tertiary);
    padding: 8px 14px;
    border-radius: 10px;
    border: 1px solid var(--border-light);
}

.wise-result-flag { font-size: 20px; }

/* Update Row */
.wise-update-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border-light);
}

.wise-update-time {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-tertiary);
}

.wise-update-time strong { color: var(--text-secondary); }

.wise-refresh-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    background: var(--brand-primary);
    color: white;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.wise-refresh-btn:hover {
    background: var(--brand-primary-dark);
}

.wise-refresh-btn.loading #refresh-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* AI Status */
.wise-ai-status {
    margin-top: 12px;
    padding: 10px 14px;
    background: linear-gradient(90deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1));
    border-radius: 10px;
    border: 1px solid rgba(139, 92, 246, 0.2);
}

.wise-ai-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #a78bfa;
}

.wise-ai-dot {
    width: 8px;
    height: 8px;
    background: #a78bfa;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}

/* Tabs Mini */
.wise-tabs-mini {
    display: flex;
    gap: 4px;
    background: var(--bg-secondary);
    padding: 3px;
    border-radius: 8px;
}

.wise-tab-mini {
    padding: 6px 10px;
    font-size: 11px;
    font-weight: 600;
    border-radius: 6px;
    border: none;
    background: transparent;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all 0.2s;
}

.wise-tab-mini.active {
    background: var(--surface);
    color: var(--text-primary);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Enhanced Provider Item */
.wise-provider-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    padding: 14px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.wise-provider-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.wise-provider-right {
    text-align: right;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.wise-provider-name-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

.wise-provider-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-tertiary);
}

.wise-provider-rating { color: #f59e0b; }
.wise-provider-speed { color: var(--success); }

.wise-provider-amount {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.wise-provider-details {
    font-size: 11px;
    color: var(--text-tertiary);
}

.wise-provider-selected {
    font-size: 11px;
    font-weight: 600;
    color: var(--success);
}

.sarfx-logo {
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
}

.sarfx-logo span {
    color: white;
    font-weight: 800;
    font-size: 16px;
}

.wise-best-tag {
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    background: var(--success);
    color: white;
    border-radius: 4px;
}

/* Chart Controls */
.wise-chart-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.wise-chart-arrow {
    font-size: 14px;
    color: var(--text-tertiary);
}

/* Period Tabs */
.wise-period-tabs {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
}

.wise-period-btn {
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    background: var(--bg-secondary);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
}

.wise-period-btn:hover {
    border-color: var(--brand-primary);
    color: var(--brand-primary);
}

.wise-period-btn.active {
    background: var(--brand-primary);
    border-color: var(--brand-primary);
    color: white;
}

/* Rate Info Box */
.wise-rate-info {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 16px 0;
}

.wise-rate-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.wise-rate-line:not(:last-child) {
    border-bottom: 1px solid var(--border-light);
}

.wise-rate-label {
    font-size: 13px;
    color: var(--text-secondary);
}

.wise-rate-value-display {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Inter', monospace;
}

.wise-fees-low {
    color: var(--success) !important;
}

.wise-via-sarfx {
    font-size: 11px;
    font-weight: 600;
    color: var(--brand-primary);
    background: rgba(224, 90, 3, 0.1);
    padding: 3px 10px;
    border-radius: 6px;
}

/* Currency Select Style - 2026 */
.currency-select-2026 {
    appearance: none;
    -webkit-appearance: none;
    background: var(--bg-tertiary, #f0f0f0);
    border: 1px solid var(--border-color, #ddd);
    border-radius: 12px;
    padding: 12px 16px;
    padding-right: 36px;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
    min-width: 120px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    transition: all 0.2s ease;
}

.currency-select-2026:hover {
    border-color: var(--brand-primary, #6366f1);
}

.currency-select-2026:focus {
    outline: none;
    border-color: var(--brand-primary, #6366f1);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
}

.converter-input-group-2026 {
    display: flex;
    align-items: center;
    gap: 12px;
}

.converter-input-2026 {
    flex: 1;
    font-size: 28px;
    font-weight: 700;
    border: none;
    background: transparent;
    color: var(--text-primary);
    min-width: 0;
}

.converter-input-2026:focus {
    outline: none;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// ===== CONFIGURATION =====
const CACHE_TTL = 30000; // 30 secondes
const FRANKFURTER_API = 'https://api.frankfurter.app';
const rateCache = new Map();
let rateChart = null;
let currentPeriod = '7';

// Taux de fallback vers MAD (simul√© car MAD non support√© par Frankfurter)
const madMultipliers = {
    'USD': 10.10, 'EUR': 10.85, 'GBP': 12.75, 'CHF': 11.35, 'CAD': 7.45, 'AED': 2.75, 'SAR': 2.69
};

// Provider data avec frais et taux - SarfX TOUJOURS le moins cher!
const providers = {
    sarfx: { name: 'SarfX', margin: 1.005, fees: 2.50, rating: 5.0, speed: '‚ö° Instantan√©' },  // 2.50 = moins que Wise!
    wise: { name: 'Wise', margin: 0.998, fees: 4.99, rating: 4.8, speed: '‚ö° 1-2h' },
    wu: { name: 'Western Union', margin: 0.985, fees: 12, rating: 4.2, speed: 'üïê 1-3j' },
    bp: { name: 'Banque Populaire', margin: 0.972, fees: 20, rating: 3.9, speed: 'üïê 2-4j' }
};

// ===== DOM ELEMENTS =====
const homeAmount = document.getElementById('home-amount');
const homeFromCurrency = document.getElementById('home-from-currency');
const homeResult = document.getElementById('home-result');

// ===== UTILITAIRES =====
function formatNumber(num) {
    return num.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatTime(date) {
    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function updateLastUpdateTime() {
    const el = document.getElementById('last-update-time');
    if (el) el.textContent = formatTime(new Date());
}

// ===== AI STATUS =====
const aiMessages = [
    'AI scanning market opportunities...',
    'Analyzing market sentiment...',
    'Comparing provider rates...',
    'Optimizing exchange route...',
    'Calculating best deal...'
];

let aiMessageIndex = 0;
function cycleAIStatus() {
    const el = document.getElementById('ai-status-text');
    if (el) {
        el.textContent = aiMessages[aiMessageIndex];
        aiMessageIndex = (aiMessageIndex + 1) % aiMessages.length;
    }
}
setInterval(cycleAIStatus, 3000);

// ===== FRANKFURTER API =====
async function fetchFrankfurterRate(from, to) {
    const cacheKey = `frankfurter_${from}_${to}`;
    const cached = rateCache.get(cacheKey);
    if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
        return cached.data;
    }

    try {
        // Frankfurter ne supporte pas MAD, on utilise EUR comme proxy
        const targetCurrency = to === 'MAD' ? 'EUR' : to;
        const response = await fetch(`${FRANKFURTER_API}/latest?from=${from}&to=${targetCurrency}`);
        if (!response.ok) throw new Error('API error');

        const data = await response.json();
        let rate = data.rates[targetCurrency];

        // Si la cible est MAD, multiplier par le taux EUR/MAD
        if (to === 'MAD') {
            rate = madMultipliers[from] || (rate * 10.85);
        }

        const result = { rate, date: data.date, from, to };
        rateCache.set(cacheKey, { data: result, timestamp: Date.now() });
        return result;
    } catch (error) {
        console.warn('Frankfurter API error, using fallback:', error);
        return { rate: madMultipliers[from] || 10.0, date: new Date().toISOString().split('T')[0], from, to };
    }
}

async function fetchHistoricalRates(from, to, days) {
    try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setDate(startDate.getDate() - days);

        const start = startDate.toISOString().split('T')[0];
        const end = endDate.toISOString().split('T')[0];

        // Pour MAD, on utilise EUR comme proxy
        const targetCurrency = to === 'MAD' ? 'EUR' : to;
        const response = await fetch(`${FRANKFURTER_API}/${start}..${end}?from=${from}&to=${targetCurrency}`);
        if (!response.ok) throw new Error('API error');

        const data = await response.json();
        const madMultiplier = madMultipliers[from] / (data.rates[Object.keys(data.rates)[0]]?.[targetCurrency] || 1);

        return Object.entries(data.rates).map(([date, rates]) => ({
            x: new Date(date).getTime(),
            y: to === 'MAD' ? rates[targetCurrency] * madMultiplier : rates[targetCurrency]
        }));
    } catch (error) {
        console.warn('Historical data error, generating mock:', error);
        return generateMockHistoricalData(from, to, days);
    }
}

function generateMockHistoricalData(from, to, days) {
    const data = [];
    const baseRate = madMultipliers[from] || 10.0;
    let rate = baseRate;

    for (let i = days; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        rate += (Math.random() - 0.5) * 0.1;
        rate = Math.max(baseRate * 0.95, Math.min(baseRate * 1.05, rate));
        data.push({ x: date.getTime(), y: parseFloat(rate.toFixed(4)) });
    }
    return data;
}

// ===== CALCUL PRINCIPAL =====
async function updateHomeCalc() {
    const amount = parseFloat(homeAmount.value) || 1000;
    const currency = homeFromCurrency.value;

    // Loading state
    homeResult.innerHTML = '<span class="animate-pulse">Calcul...</span>';
    document.getElementById('ai-status-text').textContent = 'AI scanning market opportunities...';

    try {
        const rateData = await fetchFrankfurterRate(currency, 'MAD');
        const baseRate = rateData.rate;

        // Update SarfX (best rate)
        const sarfxRate = baseRate * providers.sarfx.margin;
        const sarfxTotal = (amount * sarfxRate) - providers.sarfx.fees;
        homeResult.textContent = formatNumber(sarfxTotal);

        // Update home display rate and fees
        document.getElementById('home-rate').textContent = sarfxRate.toFixed(4);
        const homeFeesEl = document.getElementById('home-fees');
        if (homeFeesEl) homeFeesEl.innerHTML = `${providers.sarfx.fees.toFixed(2)} <span id="home-fees-currency">${currency}</span>`;

        document.getElementById('sarfx-rate').textContent = sarfxRate.toFixed(4);
        document.getElementById('sarfx-fees').textContent = providers.sarfx.fees.toFixed(2);
        document.getElementById('sarfx-amount').textContent = formatNumber(sarfxTotal) + ' MAD';

        // Update Wise
        const wiseRate = baseRate * providers.wise.margin;
        const wiseTotal = (amount * wiseRate) - providers.wise.fees;
        document.getElementById('wise-rate').textContent = wiseRate.toFixed(4);
        document.getElementById('wise-fees').textContent = providers.wise.fees.toFixed(2);
        document.getElementById('wise-amount').textContent = formatNumber(wiseTotal) + ' MAD';

        // Update WU
        const wuRate = baseRate * providers.wu.margin;
        const wuTotal = (amount * wuRate) - providers.wu.fees;
        document.getElementById('wu-rate').textContent = wuRate.toFixed(4);
        document.getElementById('wu-fees').textContent = providers.wu.fees.toFixed(2);
        document.getElementById('wu-amount').textContent = formatNumber(wuTotal) + ' MAD';

        // Update BP
        const bpRate = baseRate * providers.bp.margin;
        const bpTotal = (amount * bpRate) - providers.bp.fees;
        document.getElementById('bp-rate').textContent = bpRate.toFixed(4);
        document.getElementById('bp-fees').textContent = providers.bp.fees.toFixed(2);
        document.getElementById('bp-amount').textContent = formatNumber(bpTotal) + ' MAD';

        // Update savings (SarfX vs worst provider)
        const savings = sarfxTotal - bpTotal;
        document.getElementById('savings-amount').textContent = formatNumber(Math.abs(savings)) + ' MAD';

        // Update last update time
        updateLastUpdateTime();

        // Update AI status
        setTimeout(() => {
            document.getElementById('ai-status-text').textContent = '‚úì Best rate found via SarfX';
        }, 1000);

    } catch (error) {
        console.error('Erreur calcul:', error);
        homeResult.textContent = formatNumber(amount * (madMultipliers[currency] || 10));
    }
}

// ===== REFRESH RATES =====
async function refreshRates() {
    const btn = document.getElementById('refresh-btn');
    btn.classList.add('loading');

    // Clear cache
    rateCache.clear();

    // Update calculator
    await updateHomeCalc();

    // Reload chart
    await loadChartData();

    setTimeout(() => {
        btn.classList.remove('loading');
        showToast('Taux mis √† jour!');
    }, 500);
}

// ===== CHART =====
async function initChart() {
    const chartEl = document.getElementById('rate-history-chart');
    if (!chartEl) return;

    const from = document.getElementById('chart-source-currency')?.value || 'USD';
    const to = document.getElementById('chart-target-currency')?.value || 'MAD';
    const data = await fetchHistoricalRates(from, to, parseInt(currentPeriod));

    // Calculate stats
    const rates = data.map(d => d.y);
    const current = rates[rates.length - 1];
    const high = Math.max(...rates);
    const low = Math.min(...rates);
    const change = ((current - rates[0]) / rates[0] * 100);

    document.getElementById('stat-current').textContent = current.toFixed(2);
    document.getElementById('stat-high').textContent = high.toFixed(2);
    document.getElementById('stat-low').textContent = low.toFixed(2);

    const changeEl = document.getElementById('stat-change');
    changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
    changeEl.className = `wise-stat-value ${change >= 0 ? 'wise-stat-up' : 'wise-stat-down'}`;

    const options = {
        series: [{ name: `${from}/${to}`, data }],
        chart: { type: 'area', height: 160, toolbar: { show: false }, background: 'transparent', zoom: { enabled: false } },
        colors: ['#e05a03'],
        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05 } },
        stroke: { curve: 'smooth', width: 2 },
        grid: { borderColor: 'var(--border-light)', strokeDashArray: 3, padding: { left: 10, right: 10 } },
        xaxis: { type: 'datetime', labels: { style: { colors: '#8492a6', fontSize: '10px' }, datetimeFormatter: { year: 'yyyy', month: 'MMM', day: 'dd MMM' } }, axisBorder: { show: false }, axisTicks: { show: false } },
        yaxis: { labels: { style: { colors: '#8492a6', fontSize: '10px' }, formatter: val => val.toFixed(2) } },
        tooltip: { theme: 'dark', x: { format: 'dd MMM yyyy' }, y: { formatter: val => val.toFixed(4) + ' ' + to } },
        dataLabels: { enabled: false }
    };

    if (rateChart) {
        rateChart.updateOptions(options);
    } else {
        rateChart = new ApexCharts(chartEl, options);
        rateChart.render();
    }
}

async function loadChartData() {
    await initChart();
}

function setPeriod(period) {
    currentPeriod = period;
    document.querySelectorAll('.wise-period-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(period === '7' ? '7j' : period === '30' ? '30j' : period === '90' ? '3m' : '1a'));
    });
    loadChartData();
}

// ===== GO TO CONVERTER =====
function goToConverter(event) {
    event.preventDefault();

    const amount = parseFloat(homeAmount.value) || 1000;
    const fromCurrency = homeFromCurrency.value;
    const toCurrency = 'MAD';
    const rate = document.getElementById('home-rate')?.textContent || '10.0';
    const result = homeResult?.textContent?.replace(/\s/g, '').replace(',', '.') || '0';

    // Construire l'URL avec les param√®tres
    const url = `/app/converter?amount=${amount}&from=${fromCurrency}&to=${toCurrency}&rate=${rate}&result=${result}`;
    window.location.href = url;
}

// ===== PROVIDER SELECTION =====
function selectProvider(name, rate, fees) {
    const amount = parseFloat(homeAmount.value) || 1000;
    const total = (amount * rate) - fees;
    homeResult.textContent = formatNumber(total);

    // Visual feedback
    document.querySelectorAll('.wise-provider-item').forEach(item => {
        item.classList.remove('wise-provider-best');
        item.querySelector('.wise-provider-selected')?.remove();
    });

    if (event?.currentTarget) {
        event.currentTarget.classList.add('wise-provider-best');
    }

    showToast(`${name} s√©lectionn√© - ${formatNumber(total)} MAD`);
}

function showProviderTab(tab) {
    document.querySelectorAll('.wise-tab-mini').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    // Could show/hide different content based on tab
}

// ===== TOAST =====
function showToast(message) {
    let toast = document.getElementById('home-toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'home-toast';
        toast.style.cssText = `
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #1a1a2e; color: white; padding: 12px 24px; border-radius: 12px;
            font-size: 14px; z-index: 1000; opacity: 0; transition: opacity 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        document.body.appendChild(toast);
    }
    toast.textContent = message;
    toast.style.opacity = '1';
    setTimeout(() => { toast.style.opacity = '0'; }, 2500);
}

// ===== EVENTS =====
let updateTimeout = null;
homeAmount?.addEventListener('input', () => {
    clearTimeout(updateTimeout);
    updateTimeout = setTimeout(updateHomeCalc, 300);
});

homeFromCurrency?.addEventListener('change', () => {
    updateHomeCalc();
    loadChartData();
});

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    updateHomeCalc();
    initChart();
    updateLastUpdateTime();

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
