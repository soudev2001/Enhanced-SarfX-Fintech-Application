{% extends "app_base.html" %}

{% block content %}
<div class="flex flex-col gap-6 md:gap-8 animate-fade-in">
    <!-- Header -->
    <header class="flex justify-between items-center pt-2">
        <div class="logo">
            <span class="logo-text">Sarf</span><span class="logo-accent">X</span>
        </div>
        <a href="{{ url_for('app.profile') }}" class="btn btn-icon btn-ghost rounded-full" aria-label="Profil utilisateur">
            <i data-lucide="user" style="width: 20px; height: 20px;"></i>
        </a>
    </header>

    <!-- Hero Text -->
    <section class="flex flex-col gap-4">
        <div class="badge badge-warning" style="width: fit-content;">
            <span class="status-dot status-dot-success"></span>
            Le futur du change
        </div>
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold" style="line-height: 1.2; color: var(--text-primary);">
            Le Premier Bureau de Change <br/>
            <span style="background: linear-gradient(135deg, var(--brand-secondary), var(--brand-primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">100% DigitalisÃ©</span>
        </h1>
        <p class="text-sm md:text-base" style="color: var(--text-secondary); max-width: 600px;">
            Obtenez les meilleurs taux de change en temps rÃ©el grÃ¢ce Ã  l'IA. Plus de files d'attente, plus de frais cachÃ©s, plus de stress.
        </p>
    </section>

    <!-- Wallet Card - Modern Design -->
    <section class="wallet-card">
        <div class="relative" style="z-index: 10;">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="wallet" style="width: 16px; height: 16px;"></i>
                    </div>
                    <span style="color: rgba(255,255,255,0.8); font-size: var(--text-xs); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Portefeuille</span>
                </div>
                <a href="{{ url_for('app.profile') }}" style="color: rgba(255,255,255,0.6); font-size: var(--text-xs); display: flex; align-items: center; gap: 4px; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.6)'">
                    DÃ©tails <i data-lucide="chevron-right" style="width: 12px; height: 12px;"></i>
                </a>
            </div>
            
            <!-- Total Balance -->
            <div class="text-center py-4">
                <p style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px;">Solde Total</p>
                <h2 class="text-3xl sm:text-4xl font-extrabold" style="letter-spacing: -0.025em;">
                    ${{ total_balance.total_usd | default(0) | round(2) }}
                </h2>
                <p style="color: rgba(255,255,255,0.4); font-size: var(--text-xs); margin-top: 4px;">â‰ˆ {{ (total_balance.total_usd | default(0) * 10.2) | round(2) }} MAD</p>
            </div>
            
            <!-- Currency Breakdown with Flags -->
            {% if total_balance.wallets and total_balance.wallets|length >= 1 %}
            <div class="grid grid-cols-2 gap-2 mt-4">
                {% for w in total_balance.wallets %}
                <div class="card-interactive" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(8px); border-radius: var(--radius-xl); padding: var(--space-3); display: flex; align-items: center; gap: var(--space-3); border: 1px solid rgba(255,255,255,0.1);">
                    <!-- Currency Flag -->
                    <div style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                        {% if w.currency == 'USD' %}ðŸ‡ºðŸ‡¸
                        {% elif w.currency == 'EUR' %}ðŸ‡ªðŸ‡º
                        {% elif w.currency == 'MAD' %}ðŸ‡²ðŸ‡¦
                        {% elif w.currency == 'GBP' %}ðŸ‡¬ðŸ‡§
                        {% elif w.currency == 'CHF' %}ðŸ‡¨ðŸ‡­
                        {% else %}ðŸ’±{% endif %}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <p style="color: white; font-weight: 700; font-size: var(--text-sm);">{{ w.balance | round(2) }}</p>
                        <p style="color: rgba(255,255,255,0.5); font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em;">{{ w.currency }}</p>
                    </div>
                    {% if w.balance > 0 %}
                    <div style="text-align: right;">
                        <p style="color: var(--success-light); font-size: 10px; font-weight: 700;">${{ w.usd_value | round(2) }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div style="background: rgba(255,255,255,0.1); border-radius: var(--radius-xl); padding: var(--space-4); text-align: center; margin-top: var(--space-4);">
                <i data-lucide="wallet" style="width: 32px; height: 32px; color: rgba(255,255,255,0.3); margin: 0 auto 8px;"></i>
                <p style="color: rgba(255,255,255,0.5); font-size: var(--text-xs);">Aucun solde disponible</p>
                <a href="{{ url_for('app.converter') }}" style="color: var(--brand-primary); font-size: var(--text-xs); font-weight: 700; margin-top: 8px; display: inline-block;">Ajouter des fonds â†’</a>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="flex gap-3 mt-5">
                <a href="{{ url_for('app.converter') }}" class="btn btn-lg" style="flex: 1; background: white; color: #1a1a2e;">
                    <i data-lucide="send" style="width: 16px; height: 16px;"></i> Envoyer
                </a>
                <a href="{{ url_for('app.profile') }}" class="btn btn-lg" style="flex: 1; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.2);">
                    <i data-lucide="download" style="width: 16px; height: 16px;"></i> Recevoir
                </a>
                <a href="{{ url_for('app.transactions') }}" class="btn btn-icon" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.1);">
                    <i data-lucide="history" style="width: 16px; height: 16px;"></i>
                </a>
            </div>
        </div>
        
        <!-- Decorative Elements -->
        <div style="position: absolute; top: 0; right: 0; width: 128px; height: 128px; background: rgba(255,255,255,0.05); border-radius: 50%; transform: translate(50%, -50%);"></div>
        <div style="position: absolute; bottom: 0; left: 0; width: 96px; height: 96px; background: rgba(255,255,255,0.05); border-radius: 50%; transform: translate(-50%, 50%);"></div>
    </section>

    <!-- Features Cards - Responsive Grid -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
        <div class="card feature-card">
            <div class="feature-icon feature-icon-secondary">
                <i data-lucide="bar-chart-3" style="width: 20px; height: 20px;"></i>
            </div>
            <div class="feature-content">
                <h3 class="feature-title">Meilleurs Taux</h3>
                <p class="feature-description">Comparaison temps rÃ©el de {{ suppliers_count | default(0) }} fournisseurs</p>
            </div>
        </div>
        <div class="card feature-card">
            <div class="feature-icon feature-icon-primary">
                <i data-lucide="shield-check" style="width: 20px; height: 20px;"></i>
            </div>
            <div class="feature-content">
                <h3 class="feature-title">100% SÃ©curisÃ©</h3>
                <p class="feature-description">Transactions cryptÃ©es de bout en bout</p>
            </div>
        </div>
        <div class="card feature-card sm:col-span-2 lg:col-span-1">
            <div class="feature-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                <i data-lucide="brain-circuit" style="width: 20px; height: 20px;"></i>
            </div>
            <div class="feature-content">
                <h3 class="feature-title">PrÃ©visions IA</h3>
                <p class="feature-description">ARIMA, Prophet, LSTM pour des prÃ©dictions prÃ©cises</p>
            </div>
        </div>
    </section>

    <!-- Bank Partners Section -->
    <section class="card card-lg">
        <h3 class="text-sm font-bold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
            <i data-lucide="landmark" style="width: 16px; height: 16px; color: var(--brand-secondary);"></i> Nos Banques Partenaires
        </h3>
        <div class="relative">
            <!-- Partners Carousel -->
            <div id="partners-carousel" style="overflow: hidden;">
                <div class="flex gap-4" id="partners-track" style="transition: transform 0.5s ease-out; transform: translateX(0);">
                    {% if banks and banks|length > 0 %}
                        {% for bank in banks %}
                        <div class="partner-card">
                            {% if bank.logo %}
                            <img src="{{ bank.logo }}" alt="{{ bank.name }}" loading="lazy">
                            {% else %}
                            <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-tertiary);">
                                <span class="font-bold text-sm">{{ bank.name[:3] | upper }}</span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <!-- Fallback static logos if no banks in DB -->
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/attijariwafa.svg') }}" alt="Attijariwafa Bank" loading="lazy">
                        </div>
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/boa.svg') }}" alt="Bank of Africa" loading="lazy">
                        </div>
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/banque-populaire.svg') }}" alt="Banque Populaire" loading="lazy">
                        </div>
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/cih.svg') }}" alt="CIH Bank" loading="lazy">
                        </div>
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/albarid.svg') }}" alt="Al Barid Bank" loading="lazy">
                        </div>
                        <div class="partner-card">
                            <img src="{{ url_for('static', filename='images/banks/bmci.svg') }}" alt="BMCI" loading="lazy">
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Carousel Indicators -->
            <div class="flex justify-center gap-2 mt-4">
                <button onclick="scrollCarousel(-1)" class="btn btn-icon btn-ghost" style="padding: var(--space-2);" aria-label="PrÃ©cÃ©dent">
                    <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
                </button>
                <button onclick="scrollCarousel(1)" class="btn btn-icon btn-ghost" style="padding: var(--space-2);" aria-label="Suivant">
                    <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                </button>
            </div>
        </div>
        <p class="text-xs text-center mt-3" style="color: var(--text-tertiary);">
            Plus de <span class="font-bold" style="color: var(--brand-secondary);">250 distributeurs</span> rÃ©partis dans tout le Maroc
        </p>
    </section>

    <!-- Recent Transactions -->
    {% if transactions %}
    <section class="card">
        <h3 class="text-sm font-bold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
            <i data-lucide="history" style="width: 16px; height: 16px; color: #a855f7;"></i> Transactions RÃ©centes
        </h3>
        <div class="flex flex-col gap-2">
            {% for tx in transactions[:3] %}
            <div class="transaction-item">
                <div class="transaction-icon {{ 'transaction-icon-send' if tx.type == 'send' else 'transaction-icon-receive' }}">
                    <i data-lucide="{{ 'arrow-up-right' if tx.type == 'send' else 'arrow-down-left' }}" style="width: 16px; height: 16px;"></i>
                </div>
                <div class="transaction-details">
                    <p class="transaction-title">{{ tx.recipient | default('Transaction') }}</p>
                    <p class="transaction-subtitle">{{ tx.created_at | default('Aujourd\'hui') }}</p>
                </div>
                <div class="transaction-amount">
                    <span class="transaction-amount-value {{ 'transaction-amount-negative' if tx.type == 'send' else 'transaction-amount-positive' }}">
                        {{ '-' if tx.type == 'send' else '+' }}{{ tx.amount }} {{ tx.currency }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        <a href="{{ url_for('app.transactions') }}" class="btn btn-secondary btn-block mt-4">
            Voir tout l'historique
        </a>
    </section>
    {% endif %}

    <!-- CTA Button -->
    <a href="{{ url_for('app.converter') }}" class="btn btn-gradient btn-lg btn-block">
        Commencer maintenant <i data-lucide="arrow-right" style="width: 20px; height: 20px;"></i>
    </a>
</div>

<style>
/* Partner Cards Styling */
.partner-card {
    width: 140px;
    height: 70px;
    background: var(--surface);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--space-2);
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.partner-card:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: var(--shadow-lg);
}

.partner-card img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* Responsive partner cards */
@media (min-width: 768px) {
    .partner-card {
        width: 160px;
        height: 80px;
    }
}

@media (min-width: 1024px) {
    .partner-card {
        width: 180px;
        height: 90px;
    }
}
</style>

<script>
// Carousel functionality for bank partners
let currentPartnerIndex = 0;
const partnersTrack = document.getElementById('partners-track');
const partnerCards = document.querySelectorAll('.partner-card');
const totalPartners = partnerCards.length;
const getCardsToShow = () => window.innerWidth >= 1024 ? 4 : window.innerWidth >= 768 ? 3 : 2;

function scrollCarousel(direction) {
    const cardsToShow = getCardsToShow();
    const maxIndex = Math.max(0, totalPartners - cardsToShow);
    
    currentPartnerIndex += direction;
    
    // Loop back
    if (currentPartnerIndex < 0) {
        currentPartnerIndex = maxIndex;
    } else if (currentPartnerIndex > maxIndex) {
        currentPartnerIndex = 0;
    }
    
    if (partnerCards.length > 0) {
        const cardWidth = partnerCards[0].offsetWidth;
        const gap = 16; // 1rem gap
        const offset = currentPartnerIndex * (cardWidth + gap);
        partnersTrack.style.transform = `translateX(-${offset}px)`;
    }
}

// Auto-scroll every 3 seconds
let autoScrollInterval = setInterval(() => scrollCarousel(1), 3000);

// Pause auto-scroll on hover
const carouselContainer = document.getElementById('partners-carousel');
if (carouselContainer) {
    carouselContainer.addEventListener('mouseenter', () => clearInterval(autoScrollInterval));
    carouselContainer.addEventListener('mouseleave', () => {
        autoScrollInterval = setInterval(() => scrollCarousel(1), 3000);
    });
}

// Handle window resize
window.addEventListener('resize', () => {
    currentPartnerIndex = 0;
    if (partnersTrack) partnersTrack.style.transform = 'translateX(0)';
});
</script>
{% endblock %}
