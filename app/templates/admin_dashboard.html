{% extends "app_base.html" %}

{% block content %}
<div class="space-y-6 pb-24">
    <!-- Header -->
    <div class="flex justify-between items-center pt-2">
        <div>
            <div class="flex items-center gap-2">
                <div class="logo">
                    <span class="logo-text">Sarf</span><span class="logo-accent">X</span>
                </div>
                <span class="badge badge-error">Admin</span>
            </div>
            <p class="text-muted text-sm mt-1">Tableau de bord administrateur</p>
        </div>
        <div class="flex items-center gap-2">
            <!-- Notification Bell -->
            <button id="notification-btn" class="btn btn-ghost w-10 h-10 rounded-full flex items-center justify-center text-muted hover:text-default transition relative">
                <i data-lucide="bell" class="w-5 h-5"></i>
                <span id="notification-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-error text-white text-xs rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <a href="{{ url_for('app.settings') }}" class="btn btn-ghost w-10 h-10 rounded-full flex items-center justify-center text-muted hover:text-default transition">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </a>
        </div>
    </div>

    <!-- Notifications Panel (Hidden by default) -->
    <div id="notifications-panel" class="card p-4 hidden">
        <div class="flex justify-between items-center mb-3">
            <h4 class="font-bold text-default">Notifications</h4>
            <button onclick="clearNotifications()" class="text-xs text-muted hover:text-error">Tout effacer</button>
        </div>
        <div id="notifications-list" class="space-y-2 max-h-48 overflow-y-auto">
            <p class="text-muted text-sm text-center py-4">Aucune notification</p>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-2 gap-4">
        <!-- Users -->
        <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="bg-secondary/10 p-2 rounded-lg">
                    <i data-lucide="users" class="w-5 h-5 text-secondary"></i>
                </div>
                <span class="badge badge-success text-xs">+{{ new_users_today | default(0) }} aujourd'hui</span>
            </div>
            <p class="text-2xl font-bold text-default">{{ user_count | default(0) }}</p>
            <p class="text-xs text-muted">Utilisateurs</p>
        </div>

        <!-- Wallets -->
        <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="bg-accent/10 p-2 rounded-lg">
                    <i data-lucide="wallet" class="w-5 h-5 text-accent"></i>
                </div>
                <span class="text-xs text-muted">Actifs</span>
            </div>
            <p class="text-2xl font-bold text-default">{{ wallet_count | default(0) }}</p>
            <p class="text-xs text-muted">Portefeuilles</p>
        </div>

        <!-- Transactions -->
        <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="bg-primary/10 p-2 rounded-lg">
                    <i data-lucide="arrow-left-right" class="w-5 h-5 text-primary"></i>
                </div>
                <span class="badge badge-success text-xs">+{{ today_transactions | default(0) }} aujourd'hui</span>
            </div>
            <p class="text-2xl font-bold text-default">{{ transaction_count | default(0) }}</p>
            <p class="text-xs text-muted">Transactions</p>
        </div>

        <!-- Volume -->
        <div class="card p-4">
            <div class="flex items-center justify-between mb-2">
                <div class="bg-success/10 p-2 rounded-lg">
                    <i data-lucide="trending-up" class="w-5 h-5 text-success"></i>
                </div>
                <span class="text-xs text-muted">MAD</span>
            </div>
            <p class="text-2xl font-bold text-default">{{ "{:,.0f}".format(total_volume | default(0)) }}</p>
            <p class="text-xs text-muted">Volume Total</p>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 gap-4">
        <!-- Volume Chart -->
        <div class="card p-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-default">Volume des Transactions</h3>
                <select id="chart-period" onchange="updateVolumeChart()" class="input text-xs px-2 py-1" style="width: auto;">
                    <option value="7">7 jours</option>
                    <option value="30">30 jours</option>
                </select>
            </div>
            <div id="volume-chart" class="h-48"></div>
        </div>

        <!-- Currency Distribution -->
        <div class="card p-4">
            <h3 class="font-bold text-default mb-4">Répartition par Devise</h3>
            <div id="currency-chart" class="h-48"></div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="space-y-3">
        <h3 class="font-bold text-default">Gestion</h3>
        <div class="grid grid-cols-2 gap-3">
            <a href="{{ url_for('admin.users') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-secondary/10 p-3 rounded-lg">
                    <i data-lucide="users" class="w-5 h-5 text-secondary"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Utilisateurs</p>
                    <p class="text-xs text-muted">{{ user_count }} comptes</p>
                </div>
            </a>
            
            <a href="{{ url_for('admin.wallets') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-accent/10 p-3 rounded-lg">
                    <i data-lucide="wallet" class="w-5 h-5 text-accent"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Portefeuilles</p>
                    <p class="text-xs text-muted">{{ wallet_count }} wallets</p>
                </div>
            </a>
            
            <a href="{{ url_for('admin.transactions') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-primary/10 p-3 rounded-lg">
                    <i data-lucide="receipt" class="w-5 h-5 text-primary"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Transactions</p>
                    <p class="text-xs text-muted">Historique complet</p>
                </div>
            </a>
            
            <a href="{{ url_for('admin_banks.list_banks') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-success/10 p-3 rounded-lg">
                    <i data-lucide="building-2" class="w-5 h-5 text-success"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Banques</p>
                    <p class="text-xs text-muted">Partenaires</p>
                </div>
            </a>
            
            <a href="{{ url_for('suppliers.list_suppliers') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-info/10 p-3 rounded-lg">
                    <i data-lucide="store" class="w-5 h-5 text-info"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Fournisseurs</p>
                    <p class="text-xs text-muted">{{ supplier_count | default(0) }} actifs</p>
                </div>
            </a>
            
            <a href="{{ url_for('admin.beneficiaries') }}" class="card p-4 flex items-center gap-3 hover:shadow-md transition">
                <div class="bg-accent/10 p-3 rounded-lg">
                    <i data-lucide="contact" class="w-5 h-5 text-accent"></i>
                </div>
                <div>
                    <p class="font-bold text-default text-sm">Bénéficiaires</p>
                    <p class="text-xs text-muted">{{ beneficiary_count | default(0) }} contacts</p>
                </div>
            </a>
        </div>
    </div>

    <!-- Export Section -->
    <div class="card p-4">
        <h3 class="font-bold text-default mb-4">Export des Données</h3>
        <div class="grid grid-cols-2 gap-3">
            <a href="{{ url_for('admin.export_users') }}" class="btn btn-ghost flex items-center justify-center gap-2 bg-secondary/10 text-secondary hover:bg-secondary/20 py-3 font-bold text-sm transition">
                <i data-lucide="download" class="w-4 h-4"></i>
                Users CSV
            </a>
            <a href="{{ url_for('admin.export_transactions') }}" class="btn btn-ghost flex items-center justify-center gap-2 bg-primary/10 text-primary hover:bg-primary/20 py-3 font-bold text-sm transition">
                <i data-lucide="download" class="w-4 h-4"></i>
                Transactions CSV
            </a>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <h3 class="font-bold text-default">Transactions Récentes</h3>
            <a href="{{ url_for('admin.transactions') }}" class="text-primary text-sm font-bold">Voir tout</a>
        </div>
        
        <div class="space-y-2">
            {% for tx in recent_transactions[:5] %}
            <div class="card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-secondary to-accent flex items-center justify-center text-white font-bold text-sm">
                        {{ tx.user_email[0] | upper if tx.user_email else 'U' }}
                    </div>
                    <div>
                        <p class="text-sm font-bold text-default">{{ tx.user_email | default('N/A') }}</p>
                        <p class="text-xs text-muted">{{ tx.from_currency }} → {{ tx.to_currency }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm font-bold text-default">{{ tx.amount | round(2) }} {{ tx.from_currency }}</p>
                    <span class="badge {% if tx.status == 'completed' %}badge-success{% elif tx.status == 'pending' %}badge-warning{% else %}badge-error{% endif %}">
                        {{ tx.status | capitalize }}
                    </span>
                </div>
            </div>
            {% endfor %}
            
            {% if not recent_transactions %}
            <div class="card p-8 text-center">
                <i data-lucide="inbox" class="w-12 h-12 text-muted mx-auto mb-2"></i>
                <p class="text-muted">Aucune transaction récente</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Users -->
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <h3 class="font-bold text-default">Nouveaux Utilisateurs</h3>
            <a href="{{ url_for('admin.users') }}" class="text-primary text-sm font-bold">Voir tout</a>
        </div>
        
        <div class="space-y-2">
            {% for user in recent_users[:5] %}
            <div class="card p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-success to-info flex items-center justify-center text-white font-bold text-sm">
                        {% set email_name = user.email.split('@')[0] if user.email else 'us' %}
                        {% if '.' in email_name %}
                            {% set email_parts = email_name.split('.') %}
                            {{ email_parts[0][0] | upper }}{{ email_parts[1][0] | upper }}
                        {% else %}
                            {{ email_name[:2] | upper }}
                        {% endif %}
                    </div>
                    <div>
                        <p class="text-sm font-bold text-default">{{ user.email | default('N/A') }}</p>
                        <p class="text-xs text-muted">
                            {% if user.created_at %}
                            {{ user.created_at.strftime('%d/%m/%Y %H:%M') }}
                            {% else %}
                            Date inconnue
                            {% endif %}
                        </p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="badge {% if user.role == 'admin' %}badge-error{% else %}badge-secondary{% endif %}">
                        {{ user.role | capitalize }}
                    </span>
                    <span class="w-2 h-2 rounded-full {% if user.is_active %}bg-success{% else %}bg-neutral-400{% endif %}"></span>
                </div>
            </div>
            {% endfor %}
            
            {% if not recent_users %}
            <div class="card p-8 text-center">
                <i data-lucide="users" class="w-12 h-12 text-muted mx-auto mb-2"></i>
                <p class="text-muted">Aucun utilisateur récent</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Admin Navigation -->
<nav class="fixed bottom-0 left-0 right-0 bg-surface border-t border-border px-6 py-3 z-50" style="background: var(--bg-secondary); backdrop-filter: blur(20px);">
    <div class="flex justify-around items-center max-w-lg mx-auto">
        <a href="{{ url_for('admin.dashboard') }}" class="flex flex-col items-center gap-1 text-primary">
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
            <span class="text-xs font-bold">Dashboard</span>
        </a>
        <a href="{{ url_for('admin.users') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="users" class="w-5 h-5"></i>
            <span class="text-xs">Users</span>
        </a>
        <a href="{{ url_for('admin.transactions') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="receipt" class="w-5 h-5"></i>
            <span class="text-xs">Txns</span>
        </a>
        <a href="{{ url_for('admin_banks.list_banks') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="building-2" class="w-5 h-5"></i>
            <span class="text-xs">Banques</span>
        </a>
        <a href="{{ url_for('app.home') }}" class="flex flex-col items-center gap-1 text-muted hover:text-default transition">
            <i data-lucide="home" class="w-5 h-5"></i>
            <span class="text-xs">App</span>
        </a>
    </div>
</nav>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
// Real data from backend
const volumeData = {{ volume_data | tojson | default('[]') }};
const volumeLabels = {{ volume_labels | tojson | default('[]') }};
const currencyData = {{ currency_data | tojson | default('{}') }};

// Volume Chart
let volumeChart;
function initVolumeChart() {
    const options = {
        series: [{
            name: 'Volume (MAD)',
            data: volumeData.length > 0 ? volumeData : [0, 0, 0, 0, 0, 0, 0]
        }],
        chart: {
            type: 'area',
            height: 180,
            toolbar: { show: false },
            background: 'transparent',
            animations: { enabled: true, easing: 'easeinout', speed: 800 }
        },
        colors: ['rgb(224,90,3)'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.2,
            }
        },
        stroke: { curve: 'smooth', width: 2 },
        grid: { borderColor: 'rgba(255,255,255,0.1)', strokeDashArray: 3 },
        xaxis: {
            categories: volumeLabels.length > 0 ? volumeLabels : ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
            labels: { style: { colors: '#94a3b8' } }
        },
        yaxis: {
            labels: { 
                style: { colors: '#94a3b8' },
                formatter: (val) => val.toLocaleString() + ' MAD'
            }
        },
        tooltip: {
            theme: 'dark',
            y: { formatter: (val) => val.toLocaleString() + ' MAD' }
        }
    };
    
    volumeChart = new ApexCharts(document.querySelector("#volume-chart"), options);
    volumeChart.render();
}

// Currency Distribution Chart
function initCurrencyChart() {
    const labels = Object.keys(currencyData).length > 0 ? Object.keys(currencyData) : ['EUR', 'USD', 'MAD', 'GBP'];
    const values = Object.values(currencyData).length > 0 ? Object.values(currencyData) : [45, 30, 20, 5];
    
    const options = {
        series: values,
        chart: {
            type: 'donut',
            height: 180,
            background: 'transparent'
        },
        labels: labels,
        colors: ['#3b82f6', '#22c55e', 'rgb(224,90,3)', '#a855f7'],
        legend: {
            position: 'bottom',
            labels: { colors: '#94a3b8' }
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '60%',
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Total',
                            color: '#94a3b8'
                        }
                    }
                }
            }
        },
        dataLabels: { enabled: false },
        tooltip: { theme: 'dark' }
    };
    
    const chart = new ApexCharts(document.querySelector("#currency-chart"), options);
    chart.render();
}

// Update chart with new period
function updateVolumeChart() {
    const period = document.getElementById('chart-period').value;
    fetch(`/admin/api/volume-data?days=${period}`)
        .then(res => res.json())
        .then(data => {
            volumeChart.updateOptions({
                xaxis: { categories: data.labels }
            });
            volumeChart.updateSeries([{ data: data.values }]);
        });
}

// Notifications
let lastNotificationCheck = Date.now();
let notifications = [];

function toggleNotifications() {
    const panel = document.getElementById('notifications-panel');
    panel.classList.toggle('hidden');
}

function addNotification(message, type = 'info') {
    const list = document.getElementById('notifications-list');
    const badge = document.getElementById('notification-badge');
    
    notifications.unshift({ message, type, time: new Date() });
    
    // Update badge
    badge.textContent = notifications.length;
    badge.classList.remove('hidden');
    
    // Update list
    renderNotifications();
}

function renderNotifications() {
    const list = document.getElementById('notifications-list');
    
    if (notifications.length === 0) {
        list.innerHTML = '<p class="text-adaptive-muted text-sm text-center py-4">Aucune notification</p>';
        return;
    }
    
    list.innerHTML = notifications.map(n => `
        <div class="flex items-start gap-2 p-2 rounded-lg bg-white/5">
            <span class="w-2 h-2 rounded-full mt-1.5 ${n.type === 'transaction' ? 'bg-green-500' : 'bg-blue-500'}"></span>
            <div>
                <p class="text-sm text-adaptive">${n.message}</p>
                <p class="text-xs text-adaptive-muted">${formatTime(n.time)}</p>
            </div>
        </div>
    `).join('');
}

function clearNotifications() {
    notifications = [];
    document.getElementById('notification-badge').classList.add('hidden');
    renderNotifications();
}

function formatTime(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return 'À l\'instant';
    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

// Polling for new data
function checkForUpdates() {
    fetch('/admin/api/notifications?since=' + lastNotificationCheck)
        .then(res => res.json())
        .then(data => {
            if (data.new_transactions > 0) {
                addNotification(`${data.new_transactions} nouvelle(s) transaction(s)`, 'transaction');
            }
            if (data.new_users > 0) {
                addNotification(`${data.new_users} nouvel(le) utilisateur(s)`, 'user');
            }
            lastNotificationCheck = Date.now();
        })
        .catch(() => {});
}

// Init
document.addEventListener('DOMContentLoaded', function() {
    initVolumeChart();
    initCurrencyChart();
    
    // Notification toggle
    document.getElementById('notification-btn').addEventListener('click', toggleNotifications);
    
    // Poll every 30 seconds
    setInterval(checkForUpdates, 30000);
});
</script>
{% endblock %}
