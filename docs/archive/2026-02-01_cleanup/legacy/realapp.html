<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SarfX - Le Futur du Change</title>
    
    <!-- STACK TECHNIQUE -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        /* --- TYPOGRAPHIE & BASE --- */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --brand-orange: rgb(224, 90, 3);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a; /* Dark Default */
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s ease;
        }

        /* --- THEME CLAIR (Light Mode) --- */
        body.theme-light {
            background-color: #f8fafc;
            color: #0f172a;
        }

        /* --- COMPOSANTS UI --- */
        
        /* Glassmorphism Adaptatif */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .theme-light .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* Inputs Adaptatifs */
        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .theme-light .glass-input {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #0f172a;
        }
        .theme-light .glass-input::placeholder { color: #94a3b8; }
        
        /* Navigation Bar */
        .nav-bar { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid rgba(255,255,255,0.05);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .theme-light .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid #e2e8f0;
        }

        /* Text Colors for Theme Switching */
        .text-adaptive { color: white; }
        .theme-light .text-adaptive { color: #0f172a; }
        
        .text-adaptive-muted { color: #94a3b8; }
        .theme-light .text-adaptive-muted { color: #64748b; }

        /* SarfX Logo Colors */
        .logo-text { color: white; }
        .theme-light .logo-text { color: #0f172a; }
        .logo-x { color: var(--brand-orange); }

        /* --- ANIMATIONS & UTILITAIRES --- */
        ::-webkit-scrollbar { width: 0; }
        .screen { display: none; animation: fadeIn 0.3s ease-out; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .blob {
            position: absolute; filter: blur(90px); z-index: -1; opacity: 0.4;
            transition: opacity 0.5s ease;
        }
        .theme-light .blob { opacity: 0.15; } /* Plus subtil en mode clair */

        .loader {
            border: 2px solid rgba(255,255,255,0.1); border-left-color: var(--brand-orange);
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite;
        }
        .theme-light .loader { border-color: rgba(0,0,0,0.1); border-left-color: var(--brand-orange); }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .skeleton {
            background: rgba(30, 41, 59, 0.5);
            position: relative; overflow: hidden; border-radius: 8px;
        }
        .theme-light .skeleton { background: #e2e8f0; }
        
        /* Transition Classes for JS Logic */
        .hidden-opacity { opacity: 0; pointer-events: none; height: 0; overflow: hidden; transition: all 0.3s; margin: 0 !important; padding: 0 !important; }
        .visible-opacity { opacity: 1; pointer-events: auto; height: auto; transition: all 0.3s; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden relative selection:bg-orange-500/30" id="app-body">

    <!-- Background Blobs (Décoration) -->
    <div class="blob bg-blue-600 w-80 h-80 rounded-full top-0 left-0 -translate-x-1/2 -translate-y-1/2"></div>
    <div class="blob bg-[rgb(224,90,3)] w-64 h-64 rounded-full bottom-0 right-0 translate-x-1/2 translate-y-1/2"></div>

    <!-- Notifications System -->
    <div id="notification-container" class="fixed top-4 left-4 right-4 z-[100] space-y-2 pointer-events-none"></div>

    <!-- MAIN CONTENT AREA -->
    <main id="main-content" class="flex-1 overflow-y-auto pb-24 relative z-10 p-6">
        
        <!-- ========================================== -->
        <!-- SCREEN 1: ACCUEIL (HOME)                   -->
        <!-- ========================================== -->
        <div id="screen-home" class="screen active space-y-8">
            <!-- Header -->
            <div class="flex justify-between items-center pt-2">
                <div class="flex items-center gap-2">
                    <!-- LOGO SARFX (Blanc/Noir + Orange) -->
                    <span class="font-extrabold text-2xl tracking-tighter logo-text">
                        Sarf<span class="logo-x">X</span>
                    </span>
                </div>
                <button onclick="switchTab('profile')" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-adaptive-muted hover:text-adaptive transition">
                    <i data-lucide="user" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Hero Text -->
            <div class="space-y-4">
                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[rgb(224,90,3)]/10 border border-[rgb(224,90,3)]/20 text-[rgb(224,90,3)] text-xs font-bold uppercase tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-[rgb(224,90,3)] animate-pulse"></span>
                    Le futur du change
                </div>
                <h1 class="text-4xl font-extrabold leading-tight text-adaptive">
                    Le Premier Bureau de Change <br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-[rgb(224,90,3)]">100% Digitalisé</span>
                </h1>
                <p class="text-adaptive-muted text-sm">
                    Obtenez les meilleurs taux de change en temps réel grâce à l'IA. Plus de files d'attente, plus de frais cachés, plus de stress.
                </p>
            </div>

            <!-- Features Cards -->
            <div class="grid grid-cols-1 gap-3">
                <div class="glass-panel p-4 rounded-xl flex items-center gap-4">
                    <div class="bg-blue-500/10 p-3 rounded-lg text-blue-500"><i data-lucide="bar-chart-3" class="w-5 h-5"></i></div>
                    <div>
                        <h3 class="font-bold text-adaptive text-sm">Meilleurs Taux</h3>
                        <p class="text-xs text-adaptive-muted">Comparaison temps réel</p>
                    </div>
                </div>
                <div class="glass-panel p-4 rounded-xl flex items-center gap-4">
                    <div class="bg-[rgb(224,90,3)]/10 p-3 rounded-lg text-[rgb(224,90,3)]"><i data-lucide="shield-check" class="w-5 h-5"></i></div>
                    <div>
                        <h3 class="font-bold text-adaptive text-sm">100% Sécurisé</h3>
                        <p class="text-xs text-adaptive-muted">Transactions cryptées</p>
                    </div>
                </div>
            </div>

            <button onclick="switchTab('converter')" class="w-full bg-gradient-to-r from-blue-600 to-[rgb(224,90,3)] text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transform active:scale-95 transition">
                Commencer maintenant <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- ========================================== -->
        <!-- SCREEN 2: CONVERTISSEUR (SMART EXCHANGE)   -->
        <!-- ========================================== -->
        <div id="screen-converter" class="screen space-y-6">
            <div class="pt-4 flex justify-between items-center">
                <span class="font-extrabold text-2xl tracking-tighter logo-text">
                    Sarf<span class="logo-x">X</span>
                </span>
                <div class="bg-blue-500/10 text-blue-500 px-3 py-1 rounded-full text-xs font-bold border border-blue-500/20">Live Market</div>
            </div>
            
            <!-- Currency Input -->
            <div class="glass-panel p-5 rounded-2xl space-y-4 relative overflow-hidden group">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-adaptive-muted uppercase tracking-wide">Vous envoyez</label>
                    <span class="text-[10px] text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded font-bold border border-emerald-500/20 hidden" id="savings-badge">Économie: $--</span>
                </div>
                <div class="flex items-center gap-4 relative z-10">
                    <div class="relative flex-1">
                        <input type="number" id="smart-amount" value="1000" min="0" class="w-full text-4xl font-bold text-adaptive focus:outline-none bg-transparent placeholder-slate-400 font-mono tracking-tight" placeholder="0.00">
                    </div>
                    <button class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-xl transition">
                        <img src="https://flagcdn.com/w40/us.png" class="w-6 h-6 rounded-full shadow-sm object-cover">
                        <span class="font-bold">USD</span>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                    </button>
                </div>
            </div>

            <!-- Breakdown -->
            <div id="exchange-results" class="hidden-opacity relative pl-6 ml-4 space-y-8 border-l-2 border-slate-200 dark:border-slate-700">
                <!-- Fee -->
                <div class="relative">
                    <div class="absolute -left-[25px] top-0 bg-slate-100 dark:bg-slate-800 border-2 border-white dark:border-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-adaptive-muted"><i data-lucide="minus" class="w-4 h-4"></i></div>
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-adaptive-muted">Frais SarfX (1%)</p>
                        <p class="text-sm font-bold text-adaptive" id="smart-fee-display">--</p>
                    </div>
                </div>
                <!-- Convert -->
                <div class="relative">
                    <div class="absolute -left-[25px] top-0 bg-slate-100 dark:bg-slate-800 border-2 border-white dark:border-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-adaptive-muted"><i data-lucide="arrow-down" class="w-4 h-4"></i></div>
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-adaptive-muted">Montant converti</p>
                        <p class="text-sm font-bold text-adaptive" id="smart-convert-amount">--</p>
                    </div>
                </div>
                <!-- Rate & Suppliers -->
                <div class="relative">
                    <div class="absolute -left-[25px] top-0 bg-[rgb(224,90,3)]/10 border-2 border-white dark:border-slate-700 w-8 h-8 rounded-full flex items-center justify-center text-[rgb(224,90,3)] animate-pulse"><i data-lucide="percent" class="w-4 h-4"></i></div>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="text-xs text-adaptive-muted font-bold uppercase">Meilleur Taux (IA)</p>
                            <p class="text-sm font-bold text-emerald-500 font-mono" id="smart-rate-display">--</p>
                        </div>
                        <!-- Suppliers List (ID was missing here previously) -->
                        <div id="suppliers-list" class="space-y-2 mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Recipient (ID was missing here previously) -->
            <div id="recipient-section" class="hidden-opacity glass-panel p-5 rounded-2xl space-y-4 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-white/5 rounded-bl-full -mr-4 -mt-4"></div>
                <div class="flex items-center gap-3 mb-2 relative z-10">
                    <div class="w-10 h-10 bg-blue-500/20 rounded-xl flex items-center justify-center text-blue-400 border border-blue-500/30">
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-adaptive text-sm">Bénéficiaire</h3>
                        <p class="text-[10px] text-adaptive-muted">Détails du compte</p>
                    </div>
                </div>
                <div class="space-y-3 relative z-10">
                    <input type="text" id="recipient-name" placeholder="Nom complet" class="w-full glass-input rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition placeholder-slate-500">
                    <input type="text" id="recipient-account" placeholder="IBAN / Numéro de compte" class="w-full glass-input rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition placeholder-slate-500">
                </div>
            </div>

            <!-- Final Result (ID was missing here previously) -->
            <div id="summary-section" class="hidden-opacity bg-gradient-to-r from-blue-600 to-[rgb(224,90,3)] rounded-2xl p-6 text-white shadow-xl shadow-blue-900/20">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <p class="text-white/80 text-xs font-bold uppercase mb-1">Le bénéficiaire reçoit</p>
                        <h2 class="text-4xl font-extrabold tracking-tight" id="smart-final-amount">--</h2>
                    </div>
                    <div class="flex items-center gap-2 bg-white/20 px-3 py-1 rounded-lg backdrop-blur-md">
                        <img src="https://flagcdn.com/w40/ma.png" class="w-5 h-5 rounded-full">
                        <span class="font-bold text-sm">MAD</span>
                    </div>
                </div>
                <button onclick="confirmExchange()" class="w-full bg-white text-blue-900 font-bold py-3 rounded-xl shadow-sm hover:bg-blue-50 transition flex items-center justify-center gap-2">
                    Confirmer l'échange <i data-lucide="check-circle" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="h-6"></div>
        </div>

        <!-- ========================================== -->
        <!-- SCREEN 3: IA FORECAST (Dark Mode Optimized) -->
        <!-- ========================================== -->
        <div id="screen-ai" class="screen space-y-6">
            <div class="flex justify-between items-start pt-4">
                <h2 class="text-xl font-bold flex items-center gap-2 text-adaptive">
                    <i data-lucide="brain-circuit" class="w-5 h-5 text-purple-500"></i>
                    SarfX IA
                </h2>
                <button onclick="document.getElementById('ai-config').classList.toggle('hidden')" class="p-2 glass-panel rounded-full text-adaptive-muted"><i data-lucide="settings-2" class="w-4 h-4"></i></button>
            </div>
            
            <div id="ai-config" class="hidden glass-panel p-4 rounded-xl space-y-2">
                <label class="text-xs text-adaptive-muted">URL Backend</label>
                <input type="text" id="ai-url" value="https://sarfx-backend-ai-618432953337.europe-west1.run.app" class="w-full glass-input rounded-lg p-2 text-xs font-mono">
                <button onclick="fetchAiData('EURUSD=X')" class="bg-blue-600 text-white w-full py-2 rounded-lg text-xs font-bold">Relancer</button>
            </div>

            <!-- Error & Skeleton -->
            <div id="ai-error" class="hidden bg-rose-500/10 text-rose-500 p-4 rounded-xl text-sm border border-rose-500/20"></div>
            <div id="ai-skeleton" class="hidden space-y-8 animate-pulse w-full">
                 <div class="w-full h-56 skeleton rounded-2xl"></div>
                 <div class="h-16 skeleton rounded-xl"></div>
            </div>

            <!-- Dashboard -->
            <div id="ai-dashboard" class="space-y-6 hidden">
                <div class="text-center">
                    <h3 class="text-adaptive-muted text-sm font-bold tracking-widest uppercase mb-1">EUR / USD</h3>
                    <div class="relative inline-block">
                        <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-[rgb(224,90,3)] tracking-tighter" id="stat-pred">--</h1>
                        <span id="trend-badge" class="absolute -right-16 top-1 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase bg-slate-800 border border-slate-700 text-slate-400">--</span>
                    </div>
                    <p class="text-xs text-adaptive-muted font-medium">Prévision IA à J+7</p>
                </div>
                
                <div class="glass-panel p-2 rounded-2xl relative h-64 border-t border-white/5">
                    <div id="chart-container" class="w-full h-full"></div>
                </div>
                
                <!-- Detailed Models -->
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                    <div class="glass-panel p-3 rounded-xl border-t border-emerald-500/20">
                        <span class="text-emerald-500 font-bold block mb-1">ARIMA</span>
                        <span id="res-arima" class="font-mono text-adaptive">--</span>
                    </div>
                    <div class="glass-panel p-3 rounded-xl border-t border-amber-500/20">
                        <span class="text-amber-500 font-bold block mb-1">Prophet</span>
                        <span id="res-prophet" class="font-mono text-adaptive">--</span>
                    </div>
                    <div class="glass-panel p-3 rounded-xl border-t border-pink-500/20">
                        <span class="text-pink-500 font-bold block mb-1">LSTM</span>
                        <span id="res-lstm" class="font-mono text-adaptive">--</span>
                    </div>
                </div>

                <!-- AI Converter -->
                 <div class="glass-panel p-5 rounded-xl space-y-2">
                    <label class="text-xs font-bold text-adaptive-muted uppercase flex items-center gap-2">
                        <i data-lucide="calculator" class="w-3 h-3"></i> Simulateur IA (J+7)
                    </label>
                    <div class="flex items-center gap-4">
                        <input type="number" id="ai-input-amount" value="1000" oninput="updateAiConversion()" class="flex-1 w-full bg-transparent text-xl font-bold text-adaptive focus:outline-none border-b border-slate-700 pb-2">
                        <div class="text-right">
                            <p id="res-mean" class="text-xl font-bold text-blue-500 font-mono">--</p>
                            <span class="text-xs text-adaptive-muted font-bold">USD</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========================================== -->
        <!-- SCREEN 4: PROFILE                          -->
        <!-- ========================================== -->
        <div id="screen-profile" class="screen p-6 space-y-6">
            <h2 class="text-2xl font-bold pt-4 text-adaptive">Mon Profil</h2>
            <div class="glass-panel p-6 rounded-xl text-center">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-[rgb(224,90,3)] rounded-full mx-auto flex items-center justify-center text-3xl shadow-lg mb-4 text-white">S</div>
                <h3 class="font-bold text-adaptive text-xl">Utilisateur SarfX</h3>
                <p class="text-sm text-adaptive-muted">user@sarfx.com</p>
            </div>
            
            <div class="glass-panel p-4 rounded-xl">
                 <h3 class="text-sm font-bold text-adaptive mb-4 flex items-center gap-2">
                    <i data-lucide="history" class="w-4 h-4 text-purple-400"></i> Historique
                 </h3>
                 <div class="space-y-3">
                     <div class="flex justify-between items-center p-2 rounded hover:bg-white/5">
                         <div class="flex items-center gap-3">
                             <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i data-lucide="arrow-up-right" class="w-4 h-4"></i></div>
                             <div>
                                 <p class="text-sm font-bold text-adaptive">Envoi à Amine</p>
                                 <p class="text-[10px] text-adaptive-muted">Aujourd'hui</p>
                             </div>
                         </div>
                         <span class="text-sm font-bold text-adaptive">-1000 USD</span>
                     </div>
                 </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- SCREEN 5: SETTINGS & ADMIN                 -->
        <!-- ========================================== -->
        <div id="screen-settings" class="screen p-6 space-y-6">
            <h2 class="text-2xl font-bold pt-4 text-adaptive">Réglages</h2>
            
            <!-- Theme Toggle -->
            <div class="glass-panel p-4 rounded-xl flex items-center justify-between">
                <span class="text-sm font-bold text-adaptive flex items-center gap-2"><i data-lucide="moon" class="w-4 h-4"></i> Mode Sombre</span>
                <button onclick="toggleTheme()" class="w-12 h-6 bg-slate-700 rounded-full relative transition-colors" id="theme-toggle-btn">
                    <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform" id="theme-toggle-dot"></div>
                </button>
            </div>

            <div class="space-y-4 border-t border-slate-700/50 pt-4">
                <h3 class="text-lg font-bold text-adaptive flex items-center gap-2">
                    <i data-lucide="shield-alert" class="w-5 h-5 text-[rgb(224,90,3)]"></i>
                    Administration
                </h3>
                
                <!-- Admin: Suppliers -->
                <div class="glass-panel p-4 rounded-xl space-y-4">
                    <h4 class="text-sm font-semibold text-adaptive-muted uppercase flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Fournisseurs
                    </h4>
                    <div id="admin-suppliers-list" class="space-y-3"></div>
                </div>

                <!-- Admin: API -->
                <div class="glass-panel p-4 rounded-xl space-y-4">
                    <h4 class="text-sm font-semibold text-adaptive-muted uppercase flex items-center gap-2">
                        <i data-lucide="database" class="w-4 h-4"></i> Configuration API
                    </h4>
                    <div class="space-y-2">
                        <label class="text-xs text-adaptive-muted">URL Backend</label>
                        <input type="text" id="admin-api-url" class="w-full glass-input rounded-lg px-3 py-3 text-sm font-mono text-blue-400" onchange="document.getElementById('ai-url').value = this.value">
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full bg-gradient-to-r from-blue-600 to-[rgb(224,90,3)] text-white font-bold py-3 rounded-xl hover:shadow-lg transition active:scale-95">
                    Sauvegarder
                </button>
            </div>
        </div>

    </main>

    <!-- NAVIGATION BAR -->
    <nav class="fixed bottom-0 w-full nav-bar pb-6 pt-3 px-2 flex justify-around z-50">
        <button onclick="switchTab('home')" class="nav-item text-blue-500 flex flex-col items-center gap-1 w-16">
            <i data-lucide="home" class="w-5 h-5"></i><span class="text-[10px] font-medium">Accueil</span>
        </button>
        <button onclick="switchTab('converter')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-16">
            <i data-lucide="repeat" class="w-5 h-5"></i><span class="text-[10px] font-medium">Exchange</span>
        </button>
        <button onclick="switchTab('ai')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-16">
            <i data-lucide="brain-circuit" class="w-5 h-5"></i><span class="text-[10px] font-medium">IA</span>
        </button>
        <button onclick="switchTab('profile')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-16">
            <i data-lucide="user" class="w-5 h-5"></i><span class="text-[10px] font-medium">Profil</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-item text-slate-500 flex flex-col items-center gap-1 w-16">
            <i data-lucide="settings" class="w-5 h-5"></i><span class="text-[10px] font-medium">Réglages</span>
        </button>
    </nav>

    <script>
        lucide.createIcons();

        // --- GLOBAL STATE ---
        let suppliers = [
            { id: 1, name: "Binance P2P", type: "crypto", baseRate: 10.12, fee: 0, logo: "https://cryptologos.cc/logos/binance-coin-bnb-logo.png?v=026" },
            { id: 2, name: "Banque Populaire", type: "bank", baseRate: 9.85, fee: 20, logo: "https://upload.wikimedia.org/wikipedia/fr/2/22/Logo_Banque_Populaire.png" },
            { id: 3, name: "Marché Noir", type: "cash", baseRate: 10.05, fee: 0, logo: "https://cdn-icons-png.flaticon.com/512/2489/2489756.png" }
        ];
        const SARFX_FEE_PCT = 0.01;
        let chartInstance = null;
        let currentPredictions = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedApi = localStorage.getItem('sarfx_api_url');
            if (savedApi) {
                document.getElementById('ai-url').value = savedApi;
                document.getElementById('admin-api-url').value = savedApi;
                fetchAiData('EURUSD=X');
            }
            
            const savedSuppliers = localStorage.getItem('sarfx_suppliers');
            if(savedSuppliers) suppliers = JSON.parse(savedSuppliers);

            document.getElementById('smart-amount').addEventListener('input', calculateSmartExchange);
            
            // Check theme preference
            if(localStorage.getItem('sarfx_theme') === 'light') {
                document.body.classList.add('theme-light');
                updateThemeToggleUI(false);
            }

            calculateSmartExchange();
            renderAdminSuppliers();
        });

        // --- NAVIGATION ---
        function switchTab(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-'+id).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(b => {
                b.classList.remove('text-blue-500'); 
                b.classList.add('text-slate-500');
            });
            // Update active state
            const map = {'home':0, 'converter':1, 'ai':2, 'profile':3, 'settings':4};
            const btn = document.querySelectorAll('.nav-item')[map[id]];
            if(btn) {
                btn.classList.remove('text-slate-500');
                btn.classList.add('text-blue-500');
            }

            if (id === 'converter') {
                calculateSmartExchange();
            }
        }

        // --- THEME LOGIC ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('theme-light');
            const isDark = !body.classList.contains('theme-light');
            localStorage.setItem('sarfx_theme', isDark ? 'dark' : 'light');
            updateThemeToggleUI(isDark);
        }

        function updateThemeToggleUI(isDark) {
            const dot = document.getElementById('theme-toggle-dot');
            const btn = document.getElementById('theme-toggle-btn');
            if(isDark) {
                dot.style.transform = 'translateX(0)';
                btn.classList.replace('bg-blue-200', 'bg-slate-700');
            } else {
                dot.style.transform = 'translateX(24px)';
                btn.classList.replace('bg-slate-700', 'bg-blue-200');
            }
        }

        // --- SMART EXCHANGE LOGIC ---
        function calculateSmartExchange() {
            const amountInput = document.getElementById('smart-amount');
            const amount = parseFloat(amountInput.value) || 0;
            const resSection = document.getElementById('exchange-results');
            const sumSection = document.getElementById('summary-section');
            const recSection = document.getElementById('recipient-section');

            // Safety check for elements before access
            if (!resSection || !sumSection || !recSection) return;

            if (amount <= 0) {
                resSection.classList.add('hidden-opacity'); resSection.classList.remove('visible-opacity');
                sumSection.classList.add('hidden-opacity'); sumSection.classList.remove('visible-opacity');
                recSection.classList.add('hidden-opacity'); recSection.classList.remove('visible-opacity');
                return;
            } else {
                resSection.classList.remove('hidden-opacity'); resSection.classList.add('visible-opacity');
                sumSection.classList.remove('hidden-opacity'); sumSection.classList.add('visible-opacity');
                recSection.classList.remove('hidden-opacity'); recSection.classList.add('visible-opacity');
            }

            const sarfxFee = amount * SARFX_FEE_PCT;
            const amountToConvert = amount - sarfxFee;
            
            // Simulation Logic
            const providers = suppliers.map(s => ({ ...s, rate: s.baseRate + (Math.random()*0.05 - 0.025) }));
            providers.sort((a,b) => b.rate - a.rate);
            const finalAmount = amountToConvert * providers[0].rate;

            // UI Update
            document.getElementById('smart-fee-display').textContent = `-${sarfxFee.toFixed(2)} USD`;
            document.getElementById('smart-convert-amount').textContent = `${amountToConvert.toFixed(2)} USD`;
            
            // Fix: Check if element exists before setting textContent
            const rateDisplay = document.getElementById('smart-rate-display');
            if(rateDisplay) rateDisplay.textContent = providers[0].rate.toFixed(4);
            
            document.getElementById('smart-final-amount').textContent = new Intl.NumberFormat('fr-MA', { style: 'currency', currency: 'MAD' }).format(finalAmount);

            // Populate List
            const list = document.getElementById('suppliers-list');
            if(list) {
                list.innerHTML = '';
                providers.forEach((s, i) => {
                    const isBest = i === 0;
                    const div = document.createElement('div');
                    div.className = `flex justify-between items-center p-3 rounded-lg border transition-all ${isBest ? 'bg-emerald-500/10 border-emerald-500/30' : 'glass-panel border-white/5 opacity-80'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white p-1 flex items-center justify-center">
                                <img src="${s.logo}" class="w-full h-full object-contain" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1175/1175239.png'">
                            </div>
                            <div>
                                <p class="text-sm font-bold text-adaptive">${s.name}</p>
                                <p class="text-[10px] text-slate-400">1 USD = ${s.rate.toFixed(4)}</p>
                            </div>
                        </div>
                        ${isBest ? '<span class="text-[10px] font-bold bg-emerald-500 text-white px-2 py-1 rounded-full shadow-lg">Meilleur</span>' : ''}
                    `;
                    list.appendChild(div);
                });
            }
        }
        
        function confirmExchange() {
            const r = document.getElementById('recipient-name').value;
            if(!r) { alert("Veuillez entrer un bénéficiaire"); return; }
            alert("Transaction simulée avec succès !");
        }

        // --- AI LOGIC ---
        function updateAiConversion() {
            if (!currentPredictions) return;
            const amount = parseFloat(document.getElementById('ai-input-amount').value) || 0;
            document.getElementById('res-mean').textContent = (amount * currentPredictions.mean).toFixed(2);
        }

        async function fetchAiData(pair) {
            const url = document.getElementById('ai-url').value.replace(/\/$/, "");
            if (!url) return;
            
            document.getElementById('ai-dashboard').classList.add('hidden');
            document.getElementById('ai-skeleton').classList.remove('hidden');

            try {
                const headers = {};
                if (url.includes('loca.lt') || url.includes('ngrok')) {
                    headers['ngrok-skip-browser-warning'] = 'true';
                    headers['Bypass-Tunnel-Reminder'] = 'true';
                }
                const res = await fetch(`${url}/predict/${pair}`, { headers });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                
                document.getElementById('ai-skeleton').classList.add('hidden');
                document.getElementById('ai-dashboard').classList.remove('hidden');

                // Update Stats
                const last = data.history[data.history.length-1].Close;
                const pred = data.predictions.Ensemble_Mean[6];
                const pct = ((pred - last)/last)*100;
                
                document.getElementById('stat-pred').textContent = pred.toFixed(4);
                const badge = document.getElementById('trend-badge');
                badge.textContent = `${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%`;
                badge.className = `absolute -right-16 top-1 text-[9px] px-2 py-0.5 rounded-full font-bold uppercase border ${pct >= 0 ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' : 'bg-rose-500/10 text-rose-400 border-rose-500/20'}`;

                currentPredictions = {
                    mean: pred,
                    arima: data.predictions.ARIMA[6],
                    prophet: data.predictions.Prophet[6],
                    lstm: data.predictions.LSTM[6]
                };
                
                document.getElementById('res-arima').textContent = currentPredictions.arima.toFixed(4);
                document.getElementById('res-prophet').textContent = currentPredictions.prophet.toFixed(4);
                document.getElementById('res-lstm').textContent = currentPredictions.lstm.toFixed(4);
                updateAiConversion();

                // Chart
                if(chartInstance) chartInstance.destroy();
                const options = {
                    series: [{ name: 'IA', data: data.predictions.Ensemble_Mean }],
                    chart: { type: 'area', height: 230, toolbar: {show:false}, background: 'transparent' },
                    theme: { mode: 'dark' },
                    stroke: { curve: 'smooth', width: 3 },
                    xaxis: { categories: data.dates, labels: {show:false}, axisBorder: {show:false}, axisTicks: {show:false} },
                    grid: { borderColor: '#334155', strokeDashArray: 4 },
                    colors: ['#3b82f6']
                };
                chartInstance = new ApexCharts(document.querySelector("#chart-container"), options);
                chartInstance.render();

            } catch(e) {
                console.error(e);
                document.getElementById('ai-skeleton').classList.add('hidden');
                document.getElementById('ai-error').textContent = e.message;
                document.getElementById('ai-error').classList.remove('hidden');
                document.getElementById('ai-config-panel').classList.remove('hidden');
            }
        }

        // --- ADMIN ---
        function renderAdminSuppliers() {
            const list = document.getElementById('admin-suppliers-list');
            if(!list) return;
            list.innerHTML = '';
            suppliers.forEach((s, i) => {
                const d = document.createElement('div');
                d.className = "bg-slate-800/50 p-2 rounded mb-2 border border-slate-700/50";
                d.innerHTML = `
                    <div class="flex items-center gap-2 mb-2">
                        <img src="${s.logo}" class="w-5 h-5 rounded-full bg-white p-0.5 object-contain">
                        <span class="text-sm font-bold text-white">${s.name}</span>
                    </div>
                    <input type="text" value="${s.logo}" id="supp-logo-${i}" class="w-full glass-input rounded px-2 py-1 text-xs mb-1" placeholder="Logo">
                    <input type="text" value="${s.name}" id="supp-name-${i}" class="w-full glass-input rounded px-2 py-1 text-xs" placeholder="Nom">
                `;
                list.appendChild(d);
            });
        }
        function saveSettings() {
            const url = document.getElementById('admin-api-url').value;
            localStorage.setItem('sarfx_api_url', url);
            document.getElementById('ai-url').value = url;
            
            suppliers.forEach((s, i) => {
                s.name = document.getElementById(`supp-name-${i}`).value;
                s.logo = document.getElementById(`supp-logo-${i}`).value;
            });
            localStorage.setItem('sarfx_suppliers', JSON.stringify(suppliers));
            
            alert("Sauvegardé !");
            calculateSmartExchange();
            renderAdminSuppliers();
        }
    </script>
</body>
</html>